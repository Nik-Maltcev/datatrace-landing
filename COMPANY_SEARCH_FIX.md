# Исправление поиска компаний - Замена AI на нормализатор

## Что было исправлено

### Проблема
В разделе "проверить компанию" использовался механизм перевода JSON ответа через OpenAI API, что вызывало:
- Ошибки при недоступности OpenAI
- Сообщения "AI response" в консоли
- Зависимость от внешнего AI сервиса для базовой нормализации данных

### Решение
Заменили вызов OpenAI API на локальный нормализатор полей:

1. **Удален эндпоинт** `/api/openai/format-company`
2. **Добавлена функция** `normalizeCompanyData()` в фронтенде
3. **Добавлена функция** `generateCompanyHTML()` для генерации HTML
4. **Обновлены логи** - убраны упоминания "AI response"

## Файлы изменены

### 1. `apps/api/public/company-search.html`
- Заменен вызов `/api/openai/format-company` на локальную нормализацию
- Добавлены функции `normalizeCompanyData()` и `generateCompanyHTML()`
- Обновлены статусные сообщения
- Добавлены отладочные логи

### 2. `apps/api/src/index.js`
- Удален эндпоинт `/api/openai/format-company`
- Обновлены логи в `/api/company-summarize`

### 3. `apps/api/public/company-test.html` (новый файл)
- Тестовая страница для проверки работы поиска компаний

## Как тестировать

### 1. Основная страница поиска компаний
```
http://localhost:3000/company-search.html
```

### 2. Тестовая страница
```
http://localhost:3000/company-test.html
```

### 3. Проверить логи в консоли браузера
- Должны появляться сообщения о нормализации данных
- НЕ должно быть сообщений "AI response"
- Должны быть логи: "Нормализация данных компании...", "Нормализованные данные:", "HTML сгенерирован"

## Ожидаемое поведение

### При успешном поиске:
1. Этап "Идёт поиск информации..." - получение данных от Datanewton и Checko
2. Этап "Нормализация данных..." - обработка полученных данных локально
3. Отображение структурированной информации о компании в HTML формате

### При ошибках:
- Если источники недоступны - показывается базовая информация
- Если ИНН некорректный - показывается ошибка валидации
- Никаких зависимостей от OpenAI API

## Структура нормализованных данных

```javascript
{
  company: {
    name: "Название компании",
    fullName: "Полное название",
    shortName: "Краткое название", 
    inn: "ИНН",
    ogrn: "ОГРН",
    kpp: "КПП",
    status: "Статус",
    address: "Адрес",
    activity: "Деятельность",
    registrationDate: "Дата регистрации",
    charterCapital: "Уставный капитал",
    contacts: {
      phones: [],
      emails: [],
      sites: []
    }
  },
  ceo: {
    name: "ФИО руководителя",
    position: "Должность"
  },
  okved: {
    main: { code: "Код", text: "Описание" },
    additional: []
  },
  riskFlags: [],
  sources: [
    { name: "Datanewton", status: "success|error" },
    { name: "Checko", status: "success|error" }
  ]
}
```

## Преимущества нового подхода

1. **Независимость от AI** - работает без OpenAI API
2. **Быстрота** - нет задержек на запросы к внешним сервисам
3. **Надежность** - меньше точек отказа
4. **Прозрачность** - понятная логика нормализации данных
5. **Отладка** - четкие логи процесса обработки

## Тестовые ИНН

- `7707083893` - Сбербанк (должен найти данные)
- `1234567890` - Несуществующий (должен показать ошибку или пустые данные)
- `77070838931` - Некорректный формат (должен показать ошибку валидации)