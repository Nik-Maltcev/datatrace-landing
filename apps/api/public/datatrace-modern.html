<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DataTrace — Поиск утечек данных v2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=PT+Mono:wght@400&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'PT Mono', monospace;
      background: white;
      color: black;
      margin: 0;
      line-height: 1.6;
    }
    
    .container {
      max-width: 880px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* Кнопки в стиле лендинга */
    .btn-primary {
      background: black;
      color: white;
      border: 2px solid black;
      padding: 14px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'PT Mono', monospace;
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: white;
      color: black;
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: transparent;
      color: black;
      border: 2px solid #e5e7eb;
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'PT Mono', monospace;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    .btn-secondary:hover {
      border-color: black;
    }
    
    .btn-secondary.active {
      border-color: black;
      background: black;
      color: white;
    }
    
    /* Поля ввода */
    .input-field {
      background: white;
      color: black;
      border: 2px solid #e5e7eb;
      padding: 14px 16px;
      font-family: 'PT Mono', monospace;
      transition: border-color 0.2s;
      flex: 1;
      font-size: 15px;
      width: 100%;
      max-width: 400px;
      min-width: 320px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: black;
    }
    
    .select-field {
      background: white;
      color: black;
      border: 2px solid #e5e7eb;
      padding: 14px 16px;
      font-family: 'PT Mono', monospace;
      min-width: 200px;
      font-size: 15px;
    }
    
    .select-field:focus {
      outline: none;
      border-color: black;
    }
    
    /* Карточки результатов */
    .result-card {
      background: white;
      border: 2px solid #e5e7eb;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }
    
    .result-card:hover {
      border-color: black;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      margin-bottom: 16px;
    }
    
    .result-title {
      font-weight: 600;
      font-size: 18px;
      letter-spacing: 0.2px;
    }
    
    .status-badge {
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-clean {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    
    .status-found {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
    
    .status-error {
      background: #fefce8;
      color: #ca8a04;
      border: 1px solid #fde047;
    }
    
    .result-body {
      display: none;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .result-card.open .result-body {
      display: block;
    }
    
    .caret {
      transition: transform 0.2s ease;
      font-size: 14px;
      color: #6b7280;
    }
    
    .result-card.open .caret {
      transform: rotate(90deg);
    }
    
    /* Прогресс */
    .progress-container {
      margin: 32px 0;
      padding: 24px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .progress-fill {
      height: 100%;
      background: black;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .progress-text {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    
    .progress-percent {
      font-weight: 600;
    }
    
    /* Данные */
    .data-grid {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 12px 16px;
      margin-top: 16px;
    }
    
    .data-label {
      font-weight: 600;
      color: #6b7280;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .data-value {
      color: black;
      word-break: break-word;
      font-size: 14px;
    }
    
    /* Итоговый анализ */
    .summary-container {
      margin-top: 32px;
      padding: 24px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      display: none;
    }
    
    .summary-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Футер */
    .footer-section {
      margin-top: 48px;
      padding: 32px;
      background: black;
      color: white;
    }
    
    .footer-title {
      font-weight: 600;
      margin-bottom: 16px;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .footer-text {
      font-size: 14px;
      line-height: 1.6;
    }
    
    .footer-text div {
      margin-bottom: 8px;
    }

    /* Стили для красивого профиля */
    .formatted-profile {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 20px;
    }

    .profile-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
    }

    .profile-header h2 {
      color: white !important;
    }

    .view-toggle-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .view-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .view-toggle-btn.active {
      background: white;
      color: #667eea;
      border-color: white;
      font-weight: 600;
    }

    .profile-content {
      padding: 24px;
    }

    .profile-text {
      font-size: 16px;
      line-height: 1.8;
      color: #374151;
    }

    .profile-text h3, .profile-text h4 {
      margin-top: 24px;
      margin-bottom: 12px;
      color: #1f2937;
      font-weight: 700;
    }

    .profile-text p {
      margin-bottom: 12px;
    }

    .profile-text ul {
      margin: 12px 0;
      padding-left: 0;
    }

    .profile-text li {
      margin-bottom: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
      list-style: none;
    }

    .profile-text li:last-child {
      border-bottom: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    /* AI Loading Overlay */
    .ai-loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .ai-loading-content {
      background: white;
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      max-width: 420px;
      margin: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .ai-loading-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1f2937;
    }

    .ai-loading-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 32px;
    }

    .ai-spinner {
      width: 50px;
      height: 50px;
      margin: 0 auto 24px;
      border: 4px solid #f3f4f6;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: ai-spin 1s linear infinite;
    }

    @keyframes ai-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .ai-progress-dots {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .ai-dot {
      width: 10px;
      height: 10px;
      background: #3b82f6;
      border-radius: 50%;
      animation: ai-bounce 1.4s ease-in-out infinite both;
    }

    .ai-dot:nth-child(1) { animation-delay: -0.32s; }
    .ai-dot:nth-child(2) { animation-delay: -0.16s; }
    .ai-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes ai-bounce {
      0%, 80%, 100% { 
        transform: scale(0.6); 
        opacity: 0.5; 
      }
      40% { 
        transform: scale(1.2); 
        opacity: 1; 
      }
    }

    .ai-status-text {
      font-size: 14px;
      color: #4b5563;
      font-weight: 500;
    }

    /* Utility classes */
    .flex {
      display: flex;
    }
    
    .items-center {
      align-items: center;
    }
    
    .gap-3 {
      gap: 12px;
    }
  </style>
</head>

<body>
  <!-- Header в стиле лендинга -->
  <header class="border-b-2 border-gray-200">
    <div class="container py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24">
            <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
          </svg>
          <span class="text-xl font-bold">DataTrace</span>
        </div>
        <div class="flex items-center space-x-4">
          <div id="userInfo" class="hidden">
            <span id="userEmail" class="text-sm"></span>
            <button id="logoutBtn" class="btn-secondary ml-2">Выйти</button>
          </div>
          <button id="loginBtn" class="btn-secondary">Войти</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white max-w-md w-full p-6 border-2 border-black">
        <div class="flex justify-between items-center mb-6">
          <h2 id="authTitle" class="text-xl font-bold">Вход в систему</h2>
          <button id="closeAuthModal" class="text-2xl">&times;</button>
        </div>
        
        <div id="authError" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700"></div>
        <div id="authSuccess" class="hidden mb-4 p-3 bg-green-100 border border-green-400 text-green-700"></div>
        
        <form id="authForm">
          <div class="mb-4">
            <label class="block text-sm font-bold mb-2">Email</label>
            <input id="authEmail" type="email" class="input-field w-full" required>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-bold mb-2">Пароль</label>
            <input id="authPassword" type="password" class="input-field w-full" required>
          </div>
          
          <div class="mb-6">
            <button id="authSubmit" type="submit" class="btn-primary w-full">Войти</button>
          </div>
          
          <div class="text-center">
            <button id="authToggle" type="button" class="text-sm underline">
              Нет аккаунта? Зарегистрироваться
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="container py-16">
    <!-- Hero Section -->
    <div class="text-center mb-16">
      <h1 id="heroTitle" class="text-5xl font-bold text-black leading-tight mb-6">
        Поиск утечек данных
      </h1>
      <p id="heroDescription" class="text-xl text-gray-600 mb-8 max-w-2xl mx-auto">
        Проверим ваши персональные данные по всем доступным источникам утечек и предоставим детальный анализ
      </p>
    </div>

    <!-- Search Form -->
    <div class="max-w-4xl mx-auto">
      <!-- Mode Selection -->
      <div class="flex gap-3 mb-8 justify-center flex-wrap">
        <button id="modeLeaks" class="btn-secondary active">Поиск утечек</button>
        <button id="modeCompany" class="btn-secondary">Проверить компанию</button>
        <button id="modePassword" class="btn-secondary">🔐 Проверить пароль</button>
      </div>

      <!-- Search Input -->
      <div id="searchInput" class="flex gap-4 mb-8 flex-wrap">
        <select id="field" class="select-field">
          <option value="phone">Телефон</option>
          <option value="email">Email</option>
          <option value="vk">VK</option>
          <option value="ok">Одноклассники</option>
          <option value="inn">ИНН</option>
          <option value="snils">СНИЛС</option>
        </select>
        <input id="q" type="text" placeholder="Например: +79990000000" class="input-field" />
        <button id="btn" class="btn-primary">Проверить</button>
      </div>

      <!-- Password Check Input -->
      <div id="passwordInput" class="hidden mb-8">
        <div class="max-w-2xl mx-auto">
          <div class="mb-4">
            <label class="block text-sm font-bold mb-2">Введите пароль для проверки</label>
            <div class="relative">
              <input id="passwordField" type="password" placeholder="Введите пароль..." class="input-field w-full pr-12" />
              <button id="togglePassword" type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-black">
                👁️
              </button>
            </div>
          </div>
          <div class="mb-4">
            <div id="passwordStrength" class="text-sm text-gray-600"></div>
          </div>
          <div class="text-center">
            <button id="checkPasswordBtn" class="btn-primary">🔐 Проверить пароль</button>
          </div>
          <div class="mt-4 text-xs text-gray-500 text-center">
            <p>⚠️ Пароль проверяется через зашифрованный хеш. Сам пароль не передается на сервер.</p>
          </div>
        </div>
      </div>

      <!-- Progress -->
      <div id="progressContainer" class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text">
          <span id="progressStatus">Ожидание...</span>
          <span id="progressPercent" class="progress-percent">0%</span>
        </div>
      </div>

      <!-- Results -->
      <div id="results"></div>
    </div>

    <!-- Footer Info -->
    <div class="footer-section">
      <div class="max-w-4xl mx-auto">
        <div class="footer-title">Удаление информации</div>
        <div class="footer-text">
          <div>1. Запустите бота для удаления данных</div>
          <div>2. Выберите "Мой профиль"</div>
          <div>3. Нажмите "Скрыть информацию"</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Основные элементы
    const q = document.getElementById('q');
    const fieldSel = document.getElementById('field');
    const btn = document.getElementById('btn');
    const modeLeaks = document.getElementById('modeLeaks');
    const modeCompany = document.getElementById('modeCompany');
    const modePassword = document.getElementById('modePassword');
    const results = document.getElementById('results');
    
    // Password check elements
    const searchInput = document.getElementById('searchInput');
    const passwordInput = document.getElementById('passwordInput');
    const passwordField = document.getElementById('passwordField');
    const togglePassword = document.getElementById('togglePassword');
    const passwordStrength = document.getElementById('passwordStrength');
    const checkPasswordBtn = document.getElementById('checkPasswordBtn');

    // Authentication elements
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');
    const authModal = document.getElementById('authModal');
    const closeAuthModal = document.getElementById('closeAuthModal');
    const authForm = document.getElementById('authForm');
    const authTitle = document.getElementById('authTitle');
    const authSubmit = document.getElementById('authSubmit');
    const authToggle = document.getElementById('authToggle');
    const authError = document.getElementById('authError');
    const authSuccess = document.getElementById('authSuccess');

    // Authentication state
    let currentUser = null;
    let authToken = null;
    let isLoginMode = true;

    // Переключение режимов
    let currentMode = 'leaks';

    // ===== ФУНКЦИИ ДЛЯ РАБОТЫ С УТЕЧКАМИ (определяем в начале) =====
    window.displayLeakResultsBySources = async function(sourceResults) {
      results.innerHTML = '';
      
      if (!sourceResults || sourceResults.length === 0) {
        results.innerHTML = '<div class="result-card"><div style="color: #dc2626;">Нет данных для отображения</div></div>';
        return;
      }

      // Проверяем есть ли вообще данные для AI анализа
      const hasAnyData = sourceResults.some(result => 
        result.ok && result.items && window.checkIfSourceHasLeakData(result, result.name)
      );

      // Добавляем кнопку ИИ анализа В НАЧАЛЕ если есть данные
      if (hasAnyData) {
        const aiAnalysisContainer = document.createElement('div');
        aiAnalysisContainer.className = 'result-card';
        aiAnalysisContainer.style.textAlign = 'center';
        aiAnalysisContainer.style.backgroundColor = '#f8fafc';
        aiAnalysisContainer.style.border = '2px dashed #cbd5e1';
        
        aiAnalysisContainer.innerHTML = `
          <div style="padding: 20px;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">🤖 Анализ ИИ</div>
            <div style="color: #64748b; margin-bottom: 15px;">
              Получите детальный анализ найденных утечек, оценку критичности и рекомендации по безопасности
            </div>
            <button id="getAIAnalysis" class="btn-primary" style="margin: 0 auto;">
              📊 Получить ИИ анализ
            </button>
            <div id="aiAnalysisResult" style="display: none; margin-top: 20px;"></div>
          </div>
        `;
        
        results.appendChild(aiAnalysisContainer);

        // Обработчик кнопки
        document.getElementById('getAIAnalysis').addEventListener('click', async () => {
          await performAIAnalysis(sourceResults);
        });
      }

      // Показываем результаты по источникам ПОСЛЕ AI блока
      sourceResults.forEach((result, index) => {
        const sourceName = result.name || `Источник ${index + 1}`;
        let status = 'success';
        
        if (result.error) {
          status = 'warning';
        } else if (result.ok && result.items) {
          const hasData = window.checkIfSourceHasLeakData(result, sourceName);
          if (hasData) {
            status = 'danger';
          }
        }
        
        const item = createResultItem(sourceName, status, result.items || result.error);
        results.appendChild(item);
      });
    };

    // Функция выполнения ИИ анализа
    async function performAIAnalysis(sourceResults) {
      const button = document.getElementById('getAIAnalysis');
      const resultDiv = document.getElementById('aiAnalysisResult');
      
      button.disabled = true;
      button.innerHTML = '🔄 Анализируем данные...';
      
      try {
        // Устанавливаем большой таймаут для DeepSeek V3 анализа (120 секунд)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000);
        
        const response = await fetch('/api/ai-leak-analysis', {
          method: 'POST',
          headers: createAuthHeaders(),
          body: JSON.stringify({
            query: q.value.trim(),
            field: fieldSel.value,
            results: sourceResults
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        const data = await response.json();
        
        if (data.ok && data.analysis) {
          displayAIAnalysis(data.analysis, resultDiv);
          button.style.display = 'none';
          resultDiv.style.display = 'block';
        } else {
          throw new Error(data.error || 'Ошибка анализа');
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          console.error('AI Analysis timeout after 120 seconds');
          button.innerHTML = '⏱️ Таймаут анализа (120с)';
        } else {
          console.error('AI Analysis error:', error);
          button.innerHTML = '❌ Ошибка анализа';
        }
        button.disabled = false;
        
        setTimeout(() => {
          button.innerHTML = '📊 Получить ИИ анализ';
        }, 3000);
      }
    }

    // Функция отображения ИИ анализа
    function displayAIAnalysis(analysis, container) {
      console.log('🎯 displayAIAnalysis called!');
      console.log('📊 Analysis type:', typeof analysis);
      console.log('📝 Analysis preview:', typeof analysis === 'string' ? analysis.substring(0, 200) + '...' : analysis);
      console.log('📦 Container element:', container);
      
      let html = '<div style="text-align: left; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">';
      
      // Проверяем тип анализа - строка (DeepSeek V3) или объект (старый формат)
      if (typeof analysis === 'string') {
        // DeepSeek V3 возвращает готовый markdown-форматированный текст
        let htmlContent = analysis
          .replace(/\n/g, '<br>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/### (.*?)(?=<br>|$)/g, '<h3 style="color: #1f2937; margin: 16px 0 8px 0; font-size: 18px;">$1</h3>')
          .replace(/#### (.*?)(?=<br>|$)/g, '<h4 style="color: #374151; margin: 12px 0 6px 0; font-size: 16px;">$1</h4>');

        // Конвертируем markdown-таблицы в HTML-таблицы
        htmlContent = htmlContent.replace(
          /(\|.*?\|<br>)+/g,
          match => {
            const lines = match.split('<br>').filter(line => line.trim().startsWith('|'));
            if (lines.length < 2) return match; // не таблица
            
            const rows = lines.map(line => 
              line.trim().slice(1, -1).split('|').map(cell => cell.trim())
            );
            
            // Пропускаем строку с разделителями (---|---|---)
            const dataRows = rows.filter(row => !row[0].includes('-'));
            if (dataRows.length < 2) return match;
            
            let table = '<table style="width:100%;border-collapse:collapse;margin:16px 0;font-size:14px;">';
            
            // Заголовок
            table += '<thead><tr>';
            dataRows[0].forEach(cell => {
              table += `<th style="border:1px solid #d1d5db;padding:8px 12px;background:#f9fafb;text-align:left;font-weight:600;">${cell}</th>`;
            });
            table += '</tr></thead>';
            
            // Данные
            table += '<tbody>';
            for (let i = 1; i < dataRows.length; i++) {
              table += '<tr>';
              dataRows[i].forEach(cell => {
                table += `<td style="border:1px solid #d1d5db;padding:8px 12px;">${cell}</td>`;
              });
              table += '</tr>';
            }
            table += '</tbody></table>';
            
            return table;
          }
        );

        html += `
          <div style="color: #374151; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            ${htmlContent}
          </div>
        `;
      } else if (typeof analysis === 'object' && analysis !== null) {
        // Старый объектный формат - оставляем как есть для совместимости
        
        // Уровень критичности
        if (analysis.risk_level) {
          const riskColors = {
            'low': '#16a34a',
            'medium': '#d97706', 
            'high': '#dc2626',
            'critical': '#991b1b'
          };
          const riskTexts = {
            'low': 'Низкий',
            'medium': 'Средний',
            'high': 'Высокий', 
            'critical': 'Критический'
          };
          
          html += `
            <div style="margin-bottom: 20px;">
              <div style="font-weight: 600; margin-bottom: 8px;">🚨 Уровень риска:</div>
              <div style="color: ${riskColors[analysis.risk_level] || '#6b7280'}; font-weight: 600; font-size: 16px;">
                ${riskTexts[analysis.risk_level] || analysis.risk_level}
              </div>
            </div>
          `;
        }

        // Сайты для смены паролей
        if (analysis.security_recommendations?.password_change_sites?.length > 0) {
          html += `
            <div style="margin-bottom: 20px;">
              <div style="font-weight: 600; margin-bottom: 8px;">🔐 Смените пароли на сайтах:</div>
              <ul style="list-style: none; padding-left: 0;">
          `;
          analysis.security_recommendations.password_change_sites.forEach(site => {
            html += `<li style="margin-bottom: 4px; color: #dc2626;">• ${site}</li>`;
          });
          html += '</ul></div>';
        }

        // Краткая сводка
        if (analysis.summary) {
          html += `
            <div style="margin-bottom: 20px;">
              <div style="font-weight: 600; margin-bottom: 8px;">📋 Краткая сводка:</div>
              <div style="color: #374151; line-height: 1.5;">${analysis.summary}</div>
            </div>
          `;
        }

        // Рекомендации
        if (analysis.security_recommendations?.immediate_actions?.length > 0) {
          html += `
            <div>
              <div style="font-weight: 600; margin-bottom: 8px;">⚡ Рекомендуемые действия:</div>
              <ul style="list-style: none; padding-left: 0;">
          `;
          analysis.security_recommendations.immediate_actions.forEach(action => {
            html += `<li style="margin-bottom: 4px; color: #059669;">• ${action}</li>`;
          });
          html += '</ul></div>';
        }
      } else {
        // Fallback для неожиданного формата
        html += `
          <div style="color: #dc2626; font-weight: 600;">
            ❌ Ошибка: неожиданный формат анализа
          </div>
          <pre style="background: #f3f4f6; padding: 10px; border-radius: 4px; margin-top: 10px; overflow-x: auto;">
            ${JSON.stringify(analysis, null, 2)}
          </pre>
        `;
      }

      html += '</div>';
      container.innerHTML = html;
      
      console.log('✅ HTML content set!');
      console.log('📏 HTML length:', html.length);
      console.log('👁️ Container visibility:', container.style.display);
      console.log('🎨 Final HTML preview:', html.substring(0, 300) + '...');
    }

    // Функция стандартного отображения результатов
    function displayStandardLeakResults(sourceResults, aiSummary) {
      results.innerHTML = '';
      
      sourceResults.forEach((result, index) => {
        const sourceName = result.name || `Источник ${index + 1}`;
        
        // Определяем статус на основе найденных данных
        let status = 'success'; // По умолчанию зеленый (нет утечек)
        
        if (result.error) {
          status = 'warning'; // Желтый (ошибка источника)
        } else if (result.ok && result.items) {
          // Проверяем, есть ли данные в результатах
          const hasData = window.checkIfSourceHasLeakData(result, sourceName);
          if (hasData) {
            status = 'danger'; // Красный (найдены утечки)
          }
        }
        
        let displayData = result.items || result.error;
        
        // Если есть обработанные данные от AI, используем их
        if (aiSummary && result.ok && result.items) {
          displayData = window.formatAIDataForLeakSource(result.items, sourceName, aiSummary);
        }
        
        const item = createResultItem(sourceName, status, displayData);
        results.appendChild(item);
      });
    }

    window.checkIfSourceHasLeakData = function(result, sourceName) {
      if (!result.ok || !result.items) return false;
      
      // Проверяем каждый источник на наличие данных
      switch (sourceName) {
        case 'ITP':
          return result.items && typeof result.items === 'object' && Object.keys(result.items).length > 0;
        case 'Dyxless':
          return Array.isArray(result.items) && result.items.length > 0;
        case 'LeakOsint':
          return Array.isArray(result.items) && result.items.length > 0;
        case 'Usersbox':
          return Array.isArray(result.items) && result.items.length > 0;
        case 'Vektor':
          return result.items && (Array.isArray(result.items) ? result.items.length > 0 : Object.keys(result.items).length > 0);
        default:
          return false;
      }
    };

    // ===== ФУНКЦИЯ ДЛЯ ФОРМАТИРОВАНИЯ ДАННЫХ ИИ =====
    window.formatAIDataForLeakSource = function(originalData, sourceName, aiSummary) {
      const formattedData = {};
      
      // Если есть обработанные ИИ данные для этого источника, используем их
      if (aiSummary && aiSummary.sources && aiSummary.sources[sourceName]) {
        const sourceInfo = aiSummary.sources[sourceName];
        
        // Показываем количество записей
        if (sourceInfo.foundCount) {
          formattedData['📊 Найдено записей'] = sourceInfo.foundCount;
        }
        
        // Показываем базы данных
        if (sourceInfo.databases && sourceInfo.databases.length > 0) {
          formattedData['🗄️ Базы данных'] = sourceInfo.databases.join(', ');
        }
        
        // Показываем все обработанные записи от ИИ
        if (sourceInfo.records && Array.isArray(sourceInfo.records)) {
          sourceInfo.records.forEach((record, index) => {
            if (record && typeof record === 'object') {
              const recordInfo = [];
              
              // Форматируем каждую запись
              if (record.email) recordInfo.push(`📧 ${record.email}`);
              if (record.phone) recordInfo.push(`📞 ${record.phone}`);
              if (record.name) recordInfo.push(`👤 ${record.name}`);
              if (record.username) recordInfo.push(`🔑 ${record.username}`);
              if (record.password) recordInfo.push(`🔐 ${record.password.substring(0, 8)}...`);
              if (record.database) recordInfo.push(`🗄️ ${record.database}`);
              if (record.source) recordInfo.push(`🔗 ${record.source}`);
              if (record.date) recordInfo.push(`📅 ${record.date}`);
              
              if (recordInfo.length > 0) {
                formattedData[`📄 Запись ${index + 1}`] = recordInfo.join(' | ');
              }
            } else if (typeof record === 'string') {
              formattedData[`📄 Запись ${index + 1}`] = record;
            }
          });
        }
        
        // Добавляем заметки ИИ
        if (sourceInfo.notes) {
          formattedData['📝 Анализ ИИ'] = sourceInfo.notes;
        }
        
        // Если есть обработанные данные, возвращаем их
        if (Object.keys(formattedData).length > 1) { // больше 1 потому что может быть только счетчик
          return formattedData;
        }
      }
      
      // Если нет ИИ данных, используем оригинальные данные
      if (originalData && typeof originalData === 'object') {
        switch (sourceName) {
          case 'ITP':
            formatITPData(originalData, formattedData);
            break;
          case 'Dyxless':
            formatDyxlessData(originalData, formattedData);
            break;
          case 'LeakOsint':
            formatLeakOsintData(originalData, formattedData);
            break;
          case 'Usersbox':
            formatUsersboxData(originalData, formattedData);
            break;
          case 'Vektor':
            formatVektorData(originalData, formattedData);
            break;
          default:
            Object.assign(formattedData, originalData);
        }
      }
      
      return Object.keys(formattedData).length > 0 ? formattedData : originalData;
    };

    function formatITPData(data, formattedData) {
      if (!data || typeof data !== 'object') return;
      
      // ITP возвращает данные в виде групп
      for (const [groupName, groupData] of Object.entries(data)) {
        if (groupData && groupData.data && Array.isArray(groupData.data)) {
          formattedData[`📁 ${groupName}`] = `${groupData.data.length} записей`;
          
          // Показываем первые несколько записей
          groupData.data.slice(0, 3).forEach((record, index) => {
            if (record && typeof record === 'object') {
              const recordInfo = [];
              if (record.phone) recordInfo.push(`📞 ${record.phone}`);
              if (record.email) recordInfo.push(`📧 ${record.email}`);
              if (record.name) recordInfo.push(`👤 ${record.name}`);
              if (record.address) recordInfo.push(`🏠 ${record.address}`);
              
              if (recordInfo.length > 0) {
                formattedData[`  └ Запись ${index + 1}`] = recordInfo.join(', ');
              }
            }
          });
          
          if (groupData.data.length > 3) {
            formattedData[`  └ ...`] = `и еще ${groupData.data.length - 3} записей`;
          }
        }
      }
    }

    function formatDyxlessData(data, formattedData) {
      if (!Array.isArray(data)) return;
      
      formattedData['📊 Всего записей'] = data.length;
      
      // Группируем по базам данных
      const databases = {};
      data.forEach(record => {
        if (record && record.database) {
          if (!databases[record.database]) {
            databases[record.database] = [];
          }
          databases[record.database].push(record);
        }
      });
      
      // Показываем данные по базам
      for (const [dbName, records] of Object.entries(databases)) {
        formattedData[`🗄️ База: ${dbName}`] = `${records.length} записей`;
        
        // Показываем первые записи
        records.slice(0, 2).forEach((record, index) => {
          const recordInfo = [];
          if (record.email) recordInfo.push(`📧 ${record.email}`);
          if (record.phone) recordInfo.push(`📞 ${record.phone}`);
          if (record.name) recordInfo.push(`👤 ${record.name}`);
          if (record.password) recordInfo.push(`🔑 ${record.password.substring(0, 10)}...`);
          
          if (recordInfo.length > 0) {
            formattedData[`  └ ${index + 1}`] = recordInfo.join(', ');
          }
        });
      }
    }

    function formatLeakOsintData(data, formattedData) {
      if (!Array.isArray(data)) return;
      
      formattedData['📊 Найдено баз'] = data.length;
      
      data.forEach((leak, index) => {
        if (leak && leak.db) {
          formattedData[`🗄️ База: ${leak.db}`] = leak.info || 'Информация о базе';
          
          if (leak.data && Array.isArray(leak.data)) {
            formattedData[`  └ Записей в базе`] = leak.data.length;
            
            // Показываем первые записи
            leak.data.slice(0, 2).forEach((record, recordIndex) => {
              if (typeof record === 'string') {
                formattedData[`  └ ${recordIndex + 1}`] = record;
              } else if (typeof record === 'object') {
                const recordInfo = [];
                Object.entries(record).forEach(([key, value]) => {
                  if (value && typeof value === 'string') {
                    recordInfo.push(`${key}: ${value}`);
                  }
                });
                if (recordInfo.length > 0) {
                  formattedData[`  └ ${recordIndex + 1}`] = recordInfo.join(', ');
                }
              }
            });
          }
        }
      });
    }

    function formatUsersboxData(data, formattedData) {
      if (!Array.isArray(data)) return;
      
      formattedData['📊 Всего записей'] = data.length;
      
      data.slice(0, 5).forEach((record, index) => {
        if (record && typeof record === 'object') {
          const recordInfo = [];
          if (record.email) recordInfo.push(`📧 ${record.email}`);
          if (record.phone) recordInfo.push(`📞 ${record.phone}`);
          if (record.name) recordInfo.push(`👤 ${record.name}`);
          if (record.source) recordInfo.push(`🔗 ${record.source}`);
          
          if (recordInfo.length > 0) {
            formattedData[`📄 Запись ${index + 1}`] = recordInfo.join(', ');
          }
        }
      });
      
      if (data.length > 5) {
        formattedData['...'] = `и еще ${data.length - 5} записей`;
      }
    }

    function formatVektorData(data, formattedData) {
      if (Array.isArray(data)) {
        formattedData['📊 Всего записей'] = data.length;
        
        data.slice(0, 5).forEach((record, index) => {
          if (typeof record === 'string') {
            formattedData[`📄 ${index + 1}`] = record;
          } else if (typeof record === 'object') {
            const recordInfo = [];
            Object.entries(record).forEach(([key, value]) => {
              if (value) recordInfo.push(`${key}: ${value}`);
            });
            if (recordInfo.length > 0) {
              formattedData[`📄 ${index + 1}`] = recordInfo.join(', ');
            }
          }
        });
      } else if (typeof data === 'object') {
        Object.entries(data).forEach(([key, value]) => {
          if (value) {
            formattedData[key] = Array.isArray(value) ? value.join(', ') : value;
          }
        });
      }
    }

    function displayFinanceData(bodyId, financeData) {
      const bodyEl = document.getElementById(bodyId);
      if (!bodyEl || !financeData) return;
      
      console.log('📊 Displaying finance data:', financeData);
      
      let financeHtml = '<div style="margin-top: 20px; border-top: 2px solid #e5e7eb; padding-top: 16px;">';
      financeHtml += '<h4 style="color: #1f2937; font-weight: 600; margin-bottom: 12px;">💰 Финансовая информация</h4>';
      
      // Информация о компании
      if (financeData.company) {
        financeHtml += '<div style="margin-bottom: 16px;">';
        financeHtml += '<h5 style="color: #374151; font-weight: 600; margin-bottom: 8px;">Компания</h5>';
        financeHtml += formatResultData(financeData.company);
        financeHtml += '</div>';
      }
      
      // Финансовые данные по годам
      if (financeData.data && typeof financeData.data === 'object') {
        financeHtml += '<div style="margin-bottom: 16px;">';
        financeHtml += '<h5 style="color: #374151; font-weight: 600; margin-bottom: 8px;">Финансовые показатели</h5>';
        
        const years = Object.keys(financeData.data).sort((a, b) => b - a); // Сортируем по убыванию
        
        if (years.length > 0) {
          // Показываем последние 3 года
          const recentYears = years.slice(0, 3);
          
          recentYears.forEach(year => {
            const yearData = financeData.data[year];
            if (yearData && typeof yearData === 'object') {
              financeHtml += `<div style="margin-bottom: 12px; padding: 8px; background: #f9fafb; border-radius: 4px;">`;
              financeHtml += `<h6 style="color: #1f2937; font-weight: 600; margin-bottom: 8px;">📅 ${year} год</h6>`;
              
              // Форматируем основные финансовые показатели
              const formattedYearData = formatFinancialIndicators(yearData);
              financeHtml += formatResultData(formattedYearData);
              
              financeHtml += '</div>';
            }
          });
          
          if (years.length > 3) {
            financeHtml += `<div style="color: #6b7280; font-style: italic;">И еще данные за ${years.length - 3} лет(а)</div>`;
          }
        } else {
          financeHtml += '<div style="color: #6b7280;">Нет доступных финансовых данных</div>';
        }
        
        financeHtml += '</div>';
      }
      
      // Ссылки на официальные отчеты
      if (financeData['bo.nalog.ru'] && financeData['bo.nalog.ru']['Отчет']) {
        const reports = financeData['bo.nalog.ru']['Отчет'];
        financeHtml += '<div style="margin-bottom: 16px;">';
        financeHtml += '<h5 style="color: #374151; font-weight: 600; margin-bottom: 8px;">📋 Официальные отчеты ФНС</h5>';
        
        Object.entries(reports).forEach(([year, url]) => {
          financeHtml += `<div style="margin-bottom: 4px;">`;
          financeHtml += `<a href="${url}" target="_blank" style="color: #2563eb; text-decoration: underline;">`;
          financeHtml += `📄 Отчет за ${year} год</a>`;
          financeHtml += `</div>`;
        });
        
        financeHtml += '</div>';
      }
      
      financeHtml += '</div>';
      
      bodyEl.innerHTML += financeHtml;
    }
    
    function formatFinancialIndicators(yearData) {
      const formatted = {};
      
      // Основные показатели с расшифровкой кодов
      const indicators = {
        '1100': 'Итого по разделу I (внеоборотные активы)',
        '1200': 'Итого по разделу II (оборотные активы)', 
        '1600': 'БАЛАНС (актив)',
        '1300': 'Итого по разделу III (капитал и резервы)',
        '1400': 'Итого по разделу IV (долгосрочные обязательства)',
        '1500': 'Итого по разделу V (краткосрочные обязательства)',
        '1700': 'БАЛАНС (пассив)',
        '2110': 'Выручка',
        '2200': 'Прибыль (убыток) от продаж',
        '2300': 'Прибыль (убыток) до налогообложения',
        '2400': 'Чистая прибыль (убыток)'
      };
      
      Object.entries(indicators).forEach(([code, description]) => {
        if (yearData[code] !== undefined && yearData[code] !== null) {
          const value = Number(yearData[code]);
          if (!isNaN(value)) {
            // Форматируем крупные суммы
            formatted[description] = formatCurrency(value);
          }
        }
      });
      
      return formatted;
    }
    
    function formatCurrency(value) {
      if (Math.abs(value) >= 1000000) {
        return `${(value / 1000000).toFixed(1)} млн руб.`;
      } else if (Math.abs(value) >= 1000) {
        return `${(value / 1000).toFixed(0)} тыс. руб.`;
      } else {
        return `${value} руб.`;
      }
    }

    // Функции прогресса
    function showProgress() {
      document.getElementById('progressContainer').style.display = 'block';
      resetProgress();
    }

    function hideProgress() {
      document.getElementById('progressContainer').style.display = 'none';
    }

    function resetProgress() {
      const fill = document.getElementById('progressFill');
      const percent = document.getElementById('progressPercent');
      const status = document.getElementById('progressStatus');
      
      fill.style.width = '0%';
      percent.textContent = '0%';
      status.textContent = 'Инициализация...';
    }

    function updateProgress(percentage, statusText) {
      const fill = document.getElementById('progressFill');
      const percent = document.getElementById('progressPercent');
      const status = document.getElementById('progressStatus');
      
      fill.style.width = percentage + '%';
      percent.textContent = Math.round(percentage) + '%';
      status.textContent = statusText;
    }

    // Создание элементов результатов
    function createResultItem(title, status, data, isOpen = false) {
      const item = document.createElement('div');
      item.className = `result-card ${isOpen ? 'open' : ''}`;
      
      const statusClass = status === 'success' ? 'status-clean' : 
                         status === 'danger' ? 'status-found' : 'status-error';
      const statusText = status === 'success' ? 'Чисто' : 
                        status === 'danger' ? 'Найдено' : 'Ошибка';

      item.innerHTML = `
        <div class="result-header" onclick="toggleResult(this)">
          <div class="result-title">${title}</div>
          <div class="flex items-center gap-3">
            <span class="status-badge ${statusClass}">${statusText}</span>
            <span class="caret">▶</span>
          </div>
        </div>
        <div class="result-body">
          ${typeof data === 'string' ? data : formatResultData(data)}
        </div>
      `;

      return item;
    }

    // Функция переключения результата
    function toggleResult(header) {
      const card = header.closest('.result-card');
      card.classList.toggle('open');
    }

    // Функция форматирования данных результата
    function formatResultData(data) {
      if (!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
        return '<div style="color: #6b7280; font-style: italic;">Нет данных</div>';
      }

      if (typeof data === 'string') {
        return data;
      }

      let html = '<div class="data-grid">';
      
      for (const [key, value] of Object.entries(data)) {
        if (value !== null && value !== undefined && value !== '') {
          const formattedValue = Array.isArray(value) ? value.join(', ') : 
                                 typeof value === 'object' ? JSON.stringify(value, null, 2) : 
                                 String(value);
          
          html += `
            <div class="data-label">${key}</div>
            <div class="data-value">${formattedValue}</div>
          `;
        }
      }
      
      html += '</div>';
      return html;
    }

    // Helper function для создания заголовков с авторизацией
    function createAuthHeaders() {
      const headers = {
        'Content-Type': 'application/json'
      };
      
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      
      return headers;
    }

    // Основная функция поиска
    async function performSearch() {
      if (currentMode === 'password') {
        // Password mode uses its own button and logic
        return;
      }
      
      const query = q.value.trim();
      if (!query) {
        alert('Введите данные для поиска');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Поиск...';
      results.innerHTML = '';
      showProgress();

      try {
        if (currentMode === 'company') {
          await performCompanySearch(query);
        } else {
          await performLeakSearch(query);
        }
      } catch (error) {
        console.error('Ошибка поиска:', error);
        hideProgress();
        results.innerHTML = `<div class="result-card"><div style="color: #dc2626;">${error.message}</div></div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Проверить';
      }
    }

    // Поиск утечек (новая логика с кнопкой ИИ)
    async function performLeakSearch(query) {
      console.log('🔍 Starting leak search for:', query);
      
      const allResults = [];
      const sources = [
        { name: 'ITP', step: 1 },
        { name: 'Dyxless', step: 2 },
        { name: 'LeakOsint', step: 3 },
        { name: 'Usersbox', step: 4 },
        { name: 'Vektor', step: 5 }
      ];

      // Последовательный поиск по источникам
      for (const source of sources) {
        updateProgress((source.step / sources.length) * 90, `Поиск в ${source.name}...`);
        
        try {
          const response = await fetch('/api/leak-search-step', {
            method: 'POST',
            headers: createAuthHeaders(),
            body: JSON.stringify({
              query: query,
              field: fieldSel.value,
              step: source.step
            })
          });

          const stepData = await response.json();
          
          if (stepData.result) {
            console.log(`✅ ${source.name} completed:`, stepData.result);
            allResults.push(stepData.result);
          } else {
            console.log(`❌ ${source.name} failed:`, stepData.error);
            allResults.push({ name: source.name, ok: false, error: stepData.error });
          }
        } catch (error) {
          console.error(`💥 Error in ${source.name}:`, error);
          allResults.push({ name: source.name, ok: false, error: error.message });
        }
        
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      // Сразу показываем сырые результаты
      updateProgress(100, 'Завершено');
      setTimeout(() => {
        hideProgress();
        window.displayLeakResultsBySources(allResults);
      }, 500);
    }

    // Поиск компаний (старая логика без изменений)
    async function performCompanySearch(query) {
      console.log('🏢 Starting company search for:', query);
      
      const allResults = [];
      const sources = [
        { name: 'Datanewton', step: 1 },
        { name: 'Checko', step: 2 }
      ];

      // Последовательный поиск по источникам компаний
      for (let i = 0; i < sources.length; i++) {
        const source = sources[i];
        const progress = 25 + (i * 25);
        
        updateProgress(progress, `Поиск в ${source.name}...`);
        
        try {
          const response = await fetch('/api/company-search-step', {
            method: 'POST',
            headers: createAuthHeaders(),
            body: JSON.stringify({ inn: query, step: source.step })
          });

          const stepData = await response.json();
          
          if (response.ok && stepData.result) {
            allResults.push(stepData.result);
            console.log(`✅ ${source.name} completed:`, stepData.result);
          } else {
            console.log(`❌ ${source.name} failed:`, stepData.error);
            allResults.push({ name: source.name, ok: false, error: stepData.error });
          }
        } catch (error) {
          console.error(`💥 Error in ${source.name}:`, error);
          allResults.push({ name: source.name, ok: false, error: error.message });
        }
        
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      // Для компаний показываем стандартные результаты (без ИИ кнопки)
      updateProgress(100, 'Завершено');
      setTimeout(() => {
        hideProgress();
        displayCompanyResults(allResults);
      }, 500);
    }

    // Отображение результатов компаний (стандартная логика)
    function displayCompanyResults(companyResults) {
      results.innerHTML = '';
      
      if (!companyResults || companyResults.length === 0) {
        results.innerHTML = '<div class="result-card"><div style="color: #dc2626;">Нет данных для отображения</div></div>';
        return;
      }

      companyResults.forEach((result, index) => {
        const sourceName = result.name || `Источник ${index + 1}`;
        let status = 'success';
        
        if (result.error) {
          status = 'warning';
        } else if (result.ok && result.items) {
          // Для компаний считаем успехом наличие любых данных
          status = 'success';
        }
        
        const item = createResultItem(sourceName, status, result.items || result.error);
        results.appendChild(item);
      });
    }

    // Обработчики событий
    btn.addEventListener('click', () => {
      console.log('Button clicked! Current mode:', currentMode);
      console.log('Button element:', btn);
      console.log('Query input:', q);
      performSearch();
    });
    
    q.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        console.log('Enter pressed! Current mode:', currentMode);
        performSearch();
      }
    });

    // Обработчики для переключения режимов
    modeLeaks.addEventListener('click', () => {
      setMode('leaks');
    });
    
    modeCompany.addEventListener('click', () => {
      setMode('company');
    });
    
    modePassword.addEventListener('click', () => {
      setMode('password');
    });

    // Функция переключения режимов
    function setMode(mode) {
      currentMode = mode;
      
      // Убираем активный класс со всех кнопок
      modeLeaks.classList.remove('active');
      modeCompany.classList.remove('active');
      modePassword.classList.remove('active');
      
      // Добавляем активный класс к выбранной кнопке
      if (mode === 'leaks') {
        modeLeaks.classList.add('active');
        searchInput.style.display = 'block';
        searchInput.style.justifyContent = 'flex-start';
        passwordInput.style.display = 'none';
        fieldSel.style.display = 'inline-block';
        fieldSel.value = 'phone'; // Устанавливаем телефон по умолчанию
        q.placeholder = 'Например: +79990000000';
        q.value = '';
      } else if (mode === 'company') {
        modeCompany.classList.add('active');
        searchInput.style.display = 'block';
        searchInput.style.justifyContent = 'center'; // Центрируем для ИНН
        passwordInput.style.display = 'none';
        fieldSel.style.display = 'none'; // Скрываем селектор для ИНН
        q.placeholder = 'Введите ИНН';
        q.value = '';
        fieldSel.value = 'inn'; // Устанавливаем поле поиска как ИНН
      } else if (mode === 'password') {
        modePassword.classList.add('active');
        searchInput.style.display = 'none';
        passwordInput.style.display = 'block';
        fieldSel.style.display = 'none';
      }
      
      // Очищаем результаты при смене режима
      results.innerHTML = '';
    }

    // Глобальная функция для переключения результатов
    window.toggleResult = toggleResult;

    // AI Loading функции
    function showAILoading() {
      const overlay = document.getElementById('aiLoadingOverlay');
      if (overlay) {
        overlay.style.display = 'flex';
      }
    }

    function hideAILoading() {
      const overlay = document.getElementById('aiLoadingOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }

    function updateAIStatus(message) {
      const statusElement = document.querySelector('#aiLoadingOverlay .loading-text');
      if (statusElement) {
        statusElement.textContent = message;
      }
    }

    // Делаем функции доступными глобально
    window.showAILoading = showAILoading;
    window.hideAILoading = hideAILoading;
    window.updateAIStatus = updateAIStatus;
  </script>

  <!-- AI Loading Overlay -->
  <div id="aiLoadingOverlay" class="ai-loading-overlay">
    <div class="ai-loading-content">
      <div class="ai-loading-title">🤖 Обработка данных ИИ</div>
      <div class="ai-loading-subtitle">Анализируем найденную информацию...</div>
      
      <div class="ai-spinner"></div>
      
      <div class="ai-progress-dots">
        <div class="ai-dot"></div>
        <div class="ai-dot"></div>
        <div class="ai-dot"></div>
      </div>
      
      <div id="aiStatusText" class="ai-status-text">Подготовка данных для анализа</div>
    </div>
  </div>

</body>
</html>