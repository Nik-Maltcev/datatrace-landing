<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DataTrace — Поиск утечек данных v2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=PT+Mono:wght@400&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'PT Mono', monospace;
      background: white;
      color: black;
      margin: 0;
      line-height: 1.6;
    }
    
    .container {
      max-width: 880px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* Кнопки в стиле лендинга */
    .btn-primary {
      background: black;
      color: white;
      border: 2px solid black;
      padding: 14px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'PT Mono', monospace;
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: white;
      color: black;
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: transparent;
      color: black;
      border: 2px solid #e5e7eb;
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'PT Mono', monospace;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    .btn-secondary:hover {
      border-color: black;
    }
    
    .btn-secondary.active {
      border-color: black;
      background: black;
      color: white;
    }
    
    /* Поля ввода */
    .input-field {
      background: white;
      color: black;
      border: 2px solid #e5e7eb;
      padding: 14px 16px;
      font-family: 'PT Mono', monospace;
      transition: border-color 0.2s;
      flex: 1;
      font-size: 15px;
      width: 100%;
      max-width: 400px;
      min-width: 320px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: black;
    }
    
    .select-field {
      background: white;
      color: black;
      border: 2px solid #e5e7eb;
      padding: 14px 16px;
      font-family: 'PT Mono', monospace;
      min-width: 200px;
      font-size: 15px;
    }
    
    .select-field:focus {
      outline: none;
      border-color: black;
    }
    
    /* Карточки результатов */
    .result-card {
      background: white;
      border: 2px solid #e5e7eb;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }
    
    .result-card:hover {
      border-color: black;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      margin-bottom: 16px;
    }
    
    .result-title {
      font-weight: 600;
      font-size: 18px;
      letter-spacing: 0.2px;
    }
    
    .status-badge {
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-clean {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    
    .status-found {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
    
    .status-error {
      background: #fefce8;
      color: #ca8a04;
      border: 1px solid #fde047;
    }
    
    .result-body {
      display: none;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .result-card.open .result-body {
      display: block;
    }
    
    .caret {
      transition: transform 0.2s ease;
      font-size: 14px;
      color: #6b7280;
    }
    
    .result-card.open .caret {
      transform: rotate(90deg);
    }
    
    /* Прогресс */
    .progress-container {
      margin: 32px 0;
      padding: 24px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .progress-fill {
      height: 100%;
      background: black;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .progress-text {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    
    .progress-percent {
      font-weight: 600;
    }
    
    /* Данные */
    .data-grid {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 12px 16px;
      margin-top: 16px;
    }
    
    .data-label {
      font-weight: 600;
      color: #6b7280;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .data-value {
      color: black;
      word-break: break-word;
      font-size: 14px;
    }
    
    /* Итоговый анализ */
    .summary-container {
      margin-top: 32px;
      padding: 24px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      display: none;
    }
    
    .summary-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Футер */
    .footer-section {
      margin-top: 48px;
      padding: 32px;
      background: black;
      color: white;
    }
    
    .footer-title {
      font-weight: 600;
      margin-bottom: 16px;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .footer-text {
      font-size: 14px;
      line-height: 1.6;
    }
    
    .footer-text div {
      margin-bottom: 8px;
    }

    /* Стили для красивого профиля */
    .formatted-profile {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 20px;
    }

    .profile-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
    }

    .profile-header h2 {
      color: white !important;
    }

    .view-toggle-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .view-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .view-toggle-btn.active {
      background: white;
      color: #667eea;
      border-color: white;
      font-weight: 600;
    }

    .profile-content {
      padding: 24px;
    }

    .profile-text {
      font-size: 16px;
      line-height: 1.8;
      color: #374151;
    }

    .profile-text h3, .profile-text h4 {
      margin-top: 24px;
      margin-bottom: 12px;
      color: #1f2937;
      font-weight: 700;
    }

    .profile-text p {
      margin-bottom: 12px;
    }

    .profile-text ul {
      margin: 12px 0;
      padding-left: 0;
    }

    .profile-text li {
      margin-bottom: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
      list-style: none;
    }

    .profile-text li:last-child {
      border-bottom: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    /* AI Loading Overlay */
    .ai-loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .ai-loading-content {
      background: white;
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      max-width: 420px;
      margin: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .ai-loading-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1f2937;
    }

    .ai-loading-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 32px;
    }

    .ai-spinner {
      width: 50px;
      height: 50px;
      margin: 0 auto 24px;
      border: 4px solid #f3f4f6;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: ai-spin 1s linear infinite;
    }

    @keyframes ai-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .ai-progress-dots {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .ai-dot {
      width: 10px;
      height: 10px;
      background: #3b82f6;
      border-radius: 50%;
      animation: ai-bounce 1.4s ease-in-out infinite both;
    }

    .ai-dot:nth-child(1) { animation-delay: -0.32s; }
    .ai-dot:nth-child(2) { animation-delay: -0.16s; }
    .ai-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes ai-bounce {
      0%, 80%, 100% { 
        transform: scale(0.6); 
        opacity: 0.5; 
      }
      40% { 
        transform: scale(1.2); 
        opacity: 1; 
      }
    }

    .ai-status-text {
      font-size: 14px;
      color: #4b5563;
      font-weight: 500;
    }

    /* Utility classes */
    .flex {
      display: flex;
    }
    
    .items-center {
      align-items: center;
    }
    
    .gap-3 {
      gap: 12px;
    }

    /* Nothing OS Dashboard Styles */
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #000000;
      min-height: 100vh;
      font-family: 'PT Mono', monospace;
      color: #ffffff;
    }

    .dashboard-header {
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
      border: 2px solid #ffffff;
      padding: 40px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }

    .dashboard-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #ff0000 0%, #ffffff 50%, #ff0000 100%);
    }

    .dashboard-title {
      color: #ffffff;
      margin-bottom: 30px;
    }

    .dashboard-title h1 {
      font-size: 32px;
      font-weight: 700;
      color: #ffffff !important;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .dashboard-title p {
      font-size: 16px;
      color: #cccccc;
      line-height: 1.6;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px;
      text-align: center;
      position: relative;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: #ff0000;
    }

    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 12px;
      color: #cccccc;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .risk-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 30px 0;
    }

    .risk-circle {
      width: 150px;
      height: 150px;
      border: 3px solid #333333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      position: relative;
      background: #000000;
      padding: 10px;
      box-sizing: border-box;
    }

    .risk-circle.high-risk {
      border-color: #ff0000;
      box-shadow: 0 0 30px rgba(255, 0, 0, 0.3);
    }

    .risk-circle.medium-risk {
      border-color: #ffffff;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
    }

    .risk-circle.low-risk {
      border-color: #ffffff;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
    }

    .risk-level {
      font-size: 10px;
      font-weight: 700;
      color: #ffffff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: center;
      line-height: 1.1;
      word-spacing: 2px;
      margin-top: 4px;
    }

    .risk-count {
      font-size: 32px;
      font-weight: 700;
      color: #ff0000;
      margin-bottom: 6px;
      line-height: 1;
    }

    .action-section {
      background: #000000;
      border: 2px solid #ff0000;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
      position: relative;
    }

    .action-section::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ff0000, #ffffff, #ff0000);
      z-index: -1;
      opacity: 0.1;
    }

    .action-section h2 {
      color: #ff0000 !important;
      font-size: 20px;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .action-section p {
      color: #cccccc;
      margin-bottom: 20px;
    }

    .action-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .nothing-btn {
      background: #ffffff;
      color: #000000;
      border: 2px solid #ffffff;
      padding: 12px 24px;
      font-family: 'PT Mono', monospace;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .nothing-btn:hover {
      background: #000000;
      color: #ffffff;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }

    .nothing-btn.danger {
      background: #ff0000;
      color: #ffffff;
      border-color: #ff0000;
    }

    .nothing-btn.danger:hover {
      background: #ffffff;
      color: #ff0000;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
    }

    .breaches-section {
      background: #000000;
      border: 1px solid #333333;
      margin-bottom: 30px;
    }

    .breaches-section h2 {
      color: #ffffff !important;
      padding: 24px;
      margin: 0;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid #333333;
    }

    .breaches-section > p {
      padding: 16px 24px;
      color: #cccccc;
      margin: 0;
      border-bottom: 1px solid #333333;
    }

    .table-filters {
      padding: 20px 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      border-bottom: 1px solid #333333;
    }

    .nothing-filter-btn {
      background: transparent;
      color: #cccccc;
      border: 1px solid #333333;
      padding: 8px 16px;
      font-family: 'PT Mono', monospace;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .nothing-filter-btn:hover {
      border-color: #ffffff;
      color: #ffffff;
    }

    .nothing-filter-btn.active {
      background: #ffffff;
      color: #000000;
      border-color: #ffffff;
    }

    .nothing-table {
      width: 100%;
      border-collapse: collapse;
      background: #000000;
    }

    .nothing-table th {
      background: #1a1a1a;
      color: #ffffff;
      padding: 16px 24px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid #333333;
    }

    .nothing-table td {
      padding: 16px 24px;
      border-bottom: 1px solid #1a1a1a;
      color: #cccccc;
      vertical-align: middle;
    }

    .nothing-table tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .source-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .source-icon {
      width: 40px;
      height: 40px;
      background: #1a1a1a;
      border: 1px solid #333333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .source-name {
      font-weight: 600;
      color: #ffffff;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .source-description {
      font-size: 11px;
      color: #666666;
      text-transform: uppercase;
    }

    .nothing-status-badge {
      padding: 6px 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 1px solid;
    }

    .status-breach {
      background: rgba(255, 0, 0, 0.1);
      color: #ff0000;
      border-color: #ff0000;
    }

    .status-clean {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border-color: #ffffff;
    }

    .status-error {
      background: rgba(255, 255, 255, 0.05);
      color: #cccccc;
      border-color: #666666;
    }

    .nothing-details-btn {
      background: transparent;
      border: 1px solid #333333;
      color: #cccccc;
      padding: 6px 12px;
      font-family: 'PT Mono', monospace;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .nothing-details-btn:hover {
      border-color: #ffffff;
      color: #ffffff;
    }

    .view-toggle-container {
      background: #000000;
      padding: 20px 0;
      text-align: center;
      border-bottom: 1px solid #333333;
      margin-bottom: 30px;
    }

    .view-toggle-buttons {
      display: inline-flex;
      border: 1px solid #333333;
      background: #000000;
    }

    .view-toggle-btn {
      background: transparent !important;
      color: #cccccc !important;
      border: none !important;
      padding: 12px 24px !important;
      font-family: 'PT Mono', monospace !important;
      font-size: 12px !important;
      text-transform: uppercase !important;
      letter-spacing: 1px !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      border-right: 1px solid #333333 !important;
    }

    .view-toggle-btn:last-child {
      border-right: none !important;
    }

    .view-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.05) !important;
      color: #ffffff !important;
    }

    .view-toggle-btn.active {
      background: #ffffff !important;
      color: #000000 !important;
    }

    /* Nothing OS Modal Styles */
    .nothing-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .nothing-modal-content {
      background: #000000;
      border: 2px solid #ffffff;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .nothing-modal-header {
      padding: 24px;
      border-bottom: 1px solid #333333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1a1a1a;
    }

    .nothing-modal-header h3 {
      color: #ffffff !important;
      margin: 0;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .nothing-modal-close {
      background: none;
      border: none;
      color: #cccccc;
      font-size: 24px;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .nothing-modal-close:hover {
      color: #ff0000;
    }

    .nothing-modal-body {
      padding: 24px;
      color: #ffffff;
    }

    /* Стили для отображения данных в модальных окнах */
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 8px 16px;
      color: #ffffff;
    }

    .data-label {
      font-weight: 600;
      color: #cccccc !important;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .data-value {
      color: #ffffff !important;
      font-family: 'PT Mono', monospace;
      word-break: break-all;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 8px;
      border-radius: 2px;
    }

    .data-value:empty::after {
      content: 'Нет данных';
      color: #666666;
      font-style: italic;
    }

    /* Nothing OS Animations */
    @keyframes nothing-pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
      70% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
    }

    .pulse-red {
      animation: nothing-pulse 2s infinite;
    }

    @keyframes nothing-glow {
      0%, 100% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.2); }
      50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.4); }
    }

    .glow-white {
      animation: nothing-glow 3s ease-in-out infinite;
    }

    /* Стили для результатов поиска по домену */
    .domain-results {
      margin-top: 20px;
    }

    .database-group {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .database-group h4 {
      color: #2c3e50;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-family: 'PT Mono', monospace;
      font-size: 16px;
      font-weight: bold;
      border-left: 4px solid #2c3e50;
    }

    .records-preview {
      margin-top: 15px;
    }

    .record-item {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      font-family: 'PT Mono', monospace;
    }

    .record-email {
      color: #ff6b6b;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 6px;
    }

    .record-details {
      margin: 8px 0;
    }

    .record-field {
      margin: 4px 0;
      padding: 3px 0;
      font-size: 12px;
      line-height: 1.4;
    }

    .record-field strong {
      color: #2c3e50;
      display: inline-block;
      min-width: 100px;
    }

    .password-hidden {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }

    .hash-preview {
      background: rgba(255, 206, 84, 0.2);
      color: #ffce54;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }

    .record-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .leak-source {
      background: rgba(44, 62, 80, 0.2);
      color: #2c3e50;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      text-transform: uppercase;
    }

    .db-stats {
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 5px;
    }

    .data-types-summary {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .data-type-badge {
      background: rgba(44, 62, 80, 0.2);
      color: #2c3e50;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
    }

    .data-type-badge.critical {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }

    .data-type-badge.warning {
      background: rgba(255, 206, 84, 0.2);
      color: #ffce54;
    }

    .leak-type {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .more-results {
      color: #cccccc;
      font-style: italic;
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>

<body>
  <!-- Header в стиле лендинга -->
  <header class="border-b-2 border-gray-200">
    <div class="container py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24">
            <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
          </svg>
          <span class="text-xl font-bold">DataTrace</span>
        </div>
        <div class="flex items-center space-x-4">
          <div id="userInfo" class="hidden">
            <span id="userEmail" class="text-sm"></span>
            <button id="logoutBtn" class="btn-secondary ml-2">Выйти</button>
          </div>
          <button id="corporateBtn" class="btn-primary">🏢 Корпоративный тариф</button>
          <button id="loginBtn" class="btn-secondary">Войти</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white max-w-md w-full p-6 border-2 border-black">
        <div class="flex justify-between items-center mb-6">
          <h2 id="authTitle" class="text-xl font-bold">Вход в систему</h2>
          <button id="closeAuthModal" class="text-2xl">&times;</button>
        </div>
        
        <div id="authError" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700"></div>
        <div id="authSuccess" class="hidden mb-4 p-3 bg-green-100 border border-green-400 text-green-700"></div>
        
        <form id="authForm">
          <div class="mb-4">
            <label class="block text-sm font-bold mb-2">Email</label>
            <input id="authEmail" type="email" class="input-field w-full" required>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-bold mb-2">Пароль</label>
            <input id="authPassword" type="password" class="input-field w-full" required>
          </div>
          
          <div class="mb-6">
            <button id="authSubmit" type="submit" class="btn-primary w-full">Войти</button>
          </div>
          
          <div class="text-center">
            <button id="authToggle" type="button" class="text-sm underline">
              Нет аккаунта? Зарегистрироваться
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="container py-16">
    <!-- Hero Section -->
    <div class="text-center mb-16">
      <h1 id="heroTitle" class="text-5xl font-bold text-black leading-tight mb-6">
        Поиск утечек данных
      </h1>
      <p id="heroDescription" class="text-xl text-gray-600 mb-8 max-w-2xl mx-auto">
        Проверим ваши персональные данные по всем доступным источникам утечек и предоставим детальный анализ
      </p>
    </div>

    <!-- Search Form -->
    <div class="max-w-4xl mx-auto">
      <!-- Mode Selection -->
      <div class="flex gap-3 mb-8 justify-center flex-wrap">
        <button id="modeLeaks" class="btn-secondary active">Поиск утечек</button>
        <button id="modePassword" class="btn-secondary">🔐 Проверить пароль</button>
      </div>

      <!-- Search Input -->
      <div id="searchInput" class="flex gap-4 mb-8 flex-wrap">
        <select id="field" class="select-field">
          <option value="phone">Телефон</option>
          <option value="email">Email</option>
          <option value="vk">VK</option>
          <option value="ok">Одноклассники</option>
          <option value="inn">ИНН</option>
          <option value="snils">СНИЛС</option>
        </select>
        <input id="q" type="text" placeholder="Например: +79990000000" class="input-field" />
        <button id="btn" class="btn-primary">Проверить</button>
      </div>

      <!-- Password Check Input -->
      <div id="passwordInput" class="hidden mb-8">
        <div class="max-w-2xl mx-auto">
          <div class="mb-4">
            <label class="block text-sm font-bold mb-2">Введите пароль для проверки</label>
            <div class="relative">
              <input id="passwordField" type="password" placeholder="Введите пароль..." class="input-field w-full pr-12" />
              <button id="togglePassword" type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-black">
                👁️
              </button>
            </div>
          </div>
          <div class="mb-4">
            <div id="passwordStrength" class="text-sm text-gray-600"></div>
          </div>
          <div class="text-center">
            <button id="checkPasswordBtn" class="btn-primary">🔐 Проверить пароль</button>
          </div>
          <div class="mt-4 text-xs text-gray-500 text-center">
            <p>⚠️ Пароль проверяется через зашифрованный хеш. Сам пароль не передается на сервер.</p>
          </div>
        </div>
      </div>

      <!-- Progress -->
      <div id="progressContainer" class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text">
          <span id="progressStatus">Ожидание...</span>
          <span id="progressPercent" class="progress-percent">0%</span>
        </div>
      </div>

      <!-- Results -->
      <div id="results"></div>
    </div>

    <!-- Footer Info -->
    <div class="footer-section">
      <div class="max-w-4xl mx-auto">
        <div class="footer-title">Удаление информации</div>
        <div class="footer-text">
          <div>1. Запустите бота для удаления данных</div>
          <div>2. Выберите "Мой профиль"</div>
          <div>3. Нажмите "Скрыть информацию"</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Corporate Interface -->
  <div id="corporateInterface" class="hidden">
    <!-- Corporate Header -->
    <header class="border-b-2 border-gray-200" style="background: linear-gradient(135deg, #1f2937 0%, #374151 100%);">
      <div class="container py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <svg class="h-8 w-8 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
            </svg>
            <span class="text-xl font-bold text-white">DataTrace Corporate</span>
          </div>
          <div class="flex items-center space-x-4">
            <div id="corporateUserInfo" class="hidden">
              <span id="corporateUserEmail" class="text-sm text-gray-300"></span>
              <button id="corporateLogoutBtn" class="btn-secondary ml-2" style="color: white; border-color: white;">Выйти</button>
            </div>
            <button id="backToMainBtn" class="btn-secondary" style="color: white; border-color: white;">← Назад</button>
            <button id="corporateLoginBtn" class="btn-primary" style="background: white; color: #1f2937;">Войти</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Corporate Main Content -->
    <div class="container py-16" style="background: linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%); min-height: calc(100vh - 80px);">
      <!-- Corporate Hero Section -->
      <div class="text-center mb-16">
        <div class="inline-flex items-center justify-center p-3 mb-6" style="background: linear-gradient(135deg, #1f2937 0%, #374151 100%); border-radius: 50%; width: 80px; height: 80px;">
          <svg class="h-10 w-10 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
        </div>
        <h1 class="text-5xl font-bold text-gray-900 leading-tight mb-6">
          Корпоративная безопасность
        </h1>
        <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">
          Профессиональный анализ утечек данных компаний, проверка сотрудников и комплексный мониторинг корпоративной информационной безопасности
        </p>
        
        <!-- Corporate Features -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 max-w-5xl mx-auto">
          <div class="p-6 bg-white border-2 border-gray-200 hover:border-gray-900 transition-colors">
            <div class="text-3xl mb-4">🏢</div>
            <h3 class="text-lg font-bold mb-2">Проверка компаний</h3>
            <p class="text-gray-600 text-sm">Полный анализ корпоративных данных и финансовой отчетности</p>
          </div>
          <div class="p-6 bg-white border-2 border-gray-200 hover:border-gray-900 transition-colors">
            <div class="text-3xl mb-4">👥</div>
            <h3 class="text-lg font-bold mb-2">Анализ сотрудников</h3>
            <p class="text-gray-600 text-sm">Проверка цифрового следа персонала и выявление рисков</p>
          </div>
          <div class="p-6 bg-white border-2 border-gray-200 hover:border-gray-900 transition-colors">
            <div class="text-3xl mb-4">📊</div>
            <h3 class="text-lg font-bold mb-2">Мониторинг 24/7</h3>
            <p class="text-gray-600 text-sm">Постоянное отслеживание новых утечек и угроз</p>
          </div>
        </div>
      </div>

      <!-- Corporate Search Form -->
      <div class="max-w-4xl mx-auto">
        <!-- Corporate Mode Selection -->
        <div class="flex gap-3 mb-8 justify-center flex-wrap">
          <button id="corpModeCompany" class="btn-secondary active">🏢 Проверить компанию</button>
          <button id="corpModeEmployee" class="btn-secondary">👤 Анализ сотрудника</button>
          <button id="corpModeDomain" class="btn-secondary">🌐 Поиск по домену</button>
          <button id="corpModeBatch" class="btn-secondary">📋 Массовая проверка</button>
        </div>

        <!-- Company Search Input -->
        <div id="corporateSearchInput" class="max-w-2xl mx-auto mb-8">
          <div class="bg-white p-8 border-2 border-gray-200 hover:border-gray-900 transition-colors">
            <h3 class="text-xl font-bold mb-6 text-center">Проверка компании</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold mb-2">ИНН компании</label>
                <input id="corporateInn" type="text" placeholder="Введите ИНН..." class="input-field w-full" />
              </div>
              <div>
                <label class="block text-sm font-bold mb-2">Название компании (опционально)</label>
                <input id="corporateName" type="text" placeholder="Например: ООО 'Рога и копыта'..." class="input-field w-full" />
              </div>
              <div class="text-center pt-4">
                <button id="corporateSearchBtn" class="btn-primary w-full">🔍 Начать анализ</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Employee Search Input -->
        <div id="employeeSearchInput" class="hidden max-w-2xl mx-auto mb-8">
          <div class="bg-white p-8 border-2 border-gray-200 hover:border-gray-900 transition-colors">
            <h3 class="text-xl font-bold mb-6 text-center">Анализ сотрудника</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold mb-2">Тип данных</label>
                <select id="employeeField" class="select-field w-full">
                  <option value="phone">Телефон</option>
                  <option value="email">Email</option>
                  <option value="fullname">ФИО</option>
                  <option value="vk">VK профиль</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-bold mb-2">Данные сотрудника</label>
                <input id="employeeData" type="text" placeholder="Введите данные..." class="input-field w-full" />
              </div>
              <div class="text-center pt-4">
                <button id="employeeSearchBtn" class="btn-primary w-full">🔍 Проверить сотрудника</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Domain Search Input -->
        <div id="domainSearchInput" class="hidden max-w-2xl mx-auto mb-8">
          <div class="bg-white p-8 border-2 border-gray-200 hover:border-gray-900 transition-colors">
            <h3 class="text-xl font-bold mb-6 text-center">Поиск корпоративных утечек по домену</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold mb-2">Корпоративный домен</label>
                <input id="domainName" type="text" placeholder="Например: company.com" class="input-field w-full" />
              </div>
              <div class="bg-blue-50 border border-blue-200 p-4 rounded">
                <div class="text-sm text-blue-800">
                  <strong>🔍 Что мы найдем:</strong>
                  <ul class="mt-2 list-disc list-inside text-blue-700">
                    <li>Все корпоративные email адреса в утечках</li>
                    <li>Пароли сотрудников из баз данных</li>
                    <li>Список затронутых баз утечек</li>
                    <li>Статистику по корпоративной безопасности</li>
                  </ul>
                </div>
              </div>
              <div class="text-center pt-4">
                <button id="domainSearchBtn" class="btn-primary w-full">🌐 Найти корпоративные утечки</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Batch Search Input -->
        <div id="batchSearchInput" class="hidden max-w-2xl mx-auto mb-8">
          <div class="bg-white p-8 border-2 border-gray-200 hover:border-gray-900 transition-colors">
            <h3 class="text-xl font-bold mb-6 text-center">Массовая проверка</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold mb-2">Список для проверки</label>
                <textarea id="batchData" placeholder="Введите данные (по одному на строку):&#10;+79991234567&#10;ivan@company.com&#10;+79995556677" class="input-field w-full h-32 resize-none"></textarea>
              </div>
              <div class="text-xs text-gray-500">
                💡 Поддерживаются: телефоны, email, ИНН. Максимум 100 записей за раз.
              </div>
              <div class="text-center pt-4">
                <button id="batchSearchBtn" class="btn-primary w-full">📊 Запустить массовую проверку</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Corporate Progress -->
        <div id="corporateProgressContainer" class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="corporateProgressFill"></div>
          </div>
          <div class="progress-text">
            <span id="corporateProgressStatus">Ожидание...</span>
            <span id="corporateProgressPercent" class="progress-percent">0%</span>
          </div>
        </div>

        <!-- Corporate Results -->
        <div id="corporateResults"></div>
      </div>

      <!-- Corporate Footer -->
      <div class="footer-section" style="background: linear-gradient(135deg, #1f2937 0%, #374151 100%);">
        <div class="max-w-4xl mx-auto">
          <div class="footer-title" style="color: white;">Корпоративная поддержка</div>
          <div class="footer-text" style="color: #d1d5db;">
            <div>📞 Техподдержка: +7 (800) 123-45-67</div>
            <div>📧 Email: corporate@datatrace.ru</div>
            <div>🕐 Работаем 24/7 для корпоративных клиентов</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Основные элементы
    const q = document.getElementById('q');
    const fieldSel = document.getElementById('field');
    const btn = document.getElementById('btn');
    const modeLeaks = document.getElementById('modeLeaks');
    const modePassword = document.getElementById('modePassword');
    const results = document.getElementById('results');
    
    // Password check elements
    const searchInput = document.getElementById('searchInput');
    const passwordInput = document.getElementById('passwordInput');
    const passwordField = document.getElementById('passwordField');
    const togglePassword = document.getElementById('togglePassword');
    const passwordStrength = document.getElementById('passwordStrength');
    const checkPasswordBtn = document.getElementById('checkPasswordBtn');

    // Authentication elements
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');
    const authModal = document.getElementById('authModal');
    const closeAuthModal = document.getElementById('closeAuthModal');
    const authForm = document.getElementById('authForm');
    const authTitle = document.getElementById('authTitle');
    const authSubmit = document.getElementById('authSubmit');
    const authToggle = document.getElementById('authToggle');
    const authError = document.getElementById('authError');
    const authSuccess = document.getElementById('authSuccess');

    // Authentication state
    let currentUser = null;
    let authToken = null;
    let isLoginMode = true;

    // Переключение режимов
    let currentMode = 'leaks';

    // ===== ФУНКЦИИ ДЛЯ РАБОТЫ С УТЕЧКАМИ (определяем в начале) =====
    window.displayLeakResultsBySources = async function(sourceResults) {
      console.log('🎨 Displaying results with Nothing OS dashboard option');
      
      if (!sourceResults || sourceResults.length === 0) {
        results.innerHTML = '<div class="result-card"><div style="color: #dc2626;">Нет данных для отображения</div></div>';
        return;
      }

      // Переключатель режимов отображения в стиле Nothing OS
      const viewToggle = document.createElement('div');
      viewToggle.className = 'view-toggle-container';
      viewToggle.innerHTML = `
        <div class="view-toggle-buttons">
          <button id="listViewBtn" class="view-toggle-btn active">СПИСОК ИСТОЧНИКОВ</button>
          <button id="dashboardViewBtn" class="view-toggle-btn">ДАШБОРД</button>
        </div>
      `;
      
      results.innerHTML = '';
      results.appendChild(viewToggle);
      
      const resultsContainer = document.createElement('div');
      resultsContainer.id = 'resultsContainer';
      results.appendChild(resultsContainer);

      // По умолчанию показываем список
      showNothingListView(sourceResults, resultsContainer);

      // Обработчики переключения
      document.getElementById('listViewBtn').addEventListener('click', () => {
        switchNothingView('list', sourceResults, resultsContainer);
      });
      
      document.getElementById('dashboardViewBtn').addEventListener('click', () => {
        switchNothingView('dashboard', sourceResults, resultsContainer);
      });
    };

    function switchNothingView(viewType, sourceResults, container) {
      document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
      
      if (viewType === 'dashboard') {
        document.getElementById('dashboardViewBtn').classList.add('active');
        window.displayNothingDashboard(sourceResults);
      } else {
        document.getElementById('listViewBtn').classList.add('active');
        showNothingListView(sourceResults, container);
      }
    }

    function showNothingListView(sourceResults, container) {
      container.innerHTML = '';
      
      // Проверяем есть ли данные для AI анализа
      const hasAnyData = sourceResults.some(result => 
        result.ok && result.items && window.checkIfSourceHasLeakData(result, result.name)
      );

      // AI анализ блок
      if (hasAnyData) {
        const aiAnalysisContainer = document.createElement('div');
        aiAnalysisContainer.className = 'result-card';
        aiAnalysisContainer.style.textAlign = 'center';
        aiAnalysisContainer.style.backgroundColor = '#f8fafc';
        aiAnalysisContainer.style.border = '2px dashed #cbd5e1';
        
        aiAnalysisContainer.innerHTML = `
          <div style="padding: 20px;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">🤖 Анализ ИИ</div>
            <div style="color: #64748b; margin-bottom: 15px;">
              Получите детальный анализ найденных утечек, оценку критичности и рекомендации по безопасности
            </div>
            <button id="getAIAnalysis" class="btn-primary" style="margin: 0 auto;">
              📊 Получить ИИ анализ
            </button>
            <div id="aiAnalysisResult" style="display: none; margin-top: 20px;"></div>
          </div>
        `;
        
        container.appendChild(aiAnalysisContainer);

        document.getElementById('getAIAnalysis').addEventListener('click', async () => {
          await performAIAnalysis(sourceResults);
        });
      }

      // Стандартный список источников  
      sourceResults.forEach((result, index) => {
        const sourceName = result.name || `Источник ${index + 1}`;
        let status = 'success';
        
        if (result.error) {
          status = 'warning';
        } else if (result.ok && result.items) {
          const hasData = window.checkIfSourceHasLeakData(result, sourceName);
          if (hasData) {
            status = 'danger';
          }
        }
        
        const item = createResultItem(sourceName, status, result.items || result.error, false, sourceName);
        container.appendChild(item);
      });
    };

    // Функция выполнения ИИ анализа
    async function performAIAnalysis(sourceResults) {
      // Ищем кнопку AI анализа (может быть в списке или дашборде)
      let button = document.getElementById('getAIAnalysis') || document.getElementById('nothingAIBtn');
      let resultDiv = document.getElementById('aiAnalysisResult');
      
      // Если кнопка в дашборде, создаем контейнер для результата
      if (!resultDiv && button && button.id === 'nothingAIBtn') {
        resultDiv = document.createElement('div');
        resultDiv.id = 'aiAnalysisResult';
        resultDiv.style.marginTop = '20px';
        button.parentNode.appendChild(resultDiv);
      }
      
      if (button) {
        button.disabled = true;
        button.innerHTML = '🔄 Анализируем данные...';
      }
      
      try {
        // Устанавливаем большой таймаут для DeepSeek V3 анализа (120 секунд)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000);
        
        const response = await fetch('/api/ai-leak-analysis', {
          method: 'POST',
          headers: createAuthHeaders(),
          body: JSON.stringify({
            query: q.value.trim(),
            field: fieldSel.value,
            results: sourceResults
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        const data = await response.json();
        
        if (data.ok && data.analysis) {
          displayAIAnalysis(data.analysis, resultDiv);
          if (button) {
            button.style.display = 'none';
          }
          if (resultDiv) {
            resultDiv.style.display = 'block';
          }
        } else {
          throw new Error(data.error || 'Ошибка анализа');
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          console.error('AI Analysis timeout after 120 seconds');
          if (button) button.innerHTML = '⏱️ Таймаут анализа (120с)';
        } else {
          console.error('AI Analysis error:', error);
          if (button) button.innerHTML = '❌ Ошибка анализа';
        }
        if (button) button.disabled = false;
        
        setTimeout(() => {
          if (button) {
            const isNothingBtn = button.id === 'nothingAIBtn';
            button.innerHTML = isNothingBtn ? '🤖 АНАЛИЗ УГРОЗ ИИ' : '📊 Получить ИИ анализ';
          }
        }, 3000);
      }
    }

    // Функция отображения ИИ анализа
    function convertMarkdownTablesToHTML(content) {
      // Правильное регулярное выражение для markdown таблиц от DeepSeek V3
      const tableRegex = /(\|[^\n]*\|\s*\n)+/g;
      
      return content.replace(tableRegex, (match) => {
        console.log('🔍 Found markdown table:', match);
        
        const lines = match.trim().split('\n').filter(line => line.includes('|') && line.trim().length > 0);
        
        if (lines.length < 2) {
          console.log('❌ Not enough lines for table');
          return match;
        }
        
        // Первая строка - заголовки
        const headerLine = lines[0];
        const headerCells = headerLine.split('|')
          .map(cell => cell.trim())
          .filter(cell => cell.length > 0);
        
        console.log('📋 Header cells:', headerCells);
        
        // Находим строку с разделителями (может быть вторая или любая с --- или |---|)
        let dataStartIndex = 1;
        for (let i = 1; i < lines.length; i++) {
          if (lines[i].includes('---') || lines[i].includes(':---') || lines[i].includes('---|') || lines[i].includes('|---')) {
            dataStartIndex = i + 1;
            break;
          }
        }
        
        // Остальные строки - данные
        const dataRows = lines.slice(dataStartIndex)
          .map(line => {
            const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell.length > 0);
            return cells;
          })
          .filter(row => row.length > 0);
        
        console.log('📊 Data rows:', dataRows);
        
        // Создаем HTML таблицу
        let html = '<table style="width: 100%; border-collapse: collapse; margin: 16px 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;">';
        
        // Заголовки
        if (headerCells.length > 0) {
          html += '<thead><tr>';
          headerCells.forEach(header => {
            html += `<th style="background: #f8fafc; font-weight: 600; color: #374151; padding: 12px; border: 1px solid #e2e8f0; text-align: left;">${header}</th>`;
          });
          html += '</tr></thead>';
        }
        
        // Данные
        if (dataRows.length > 0) {
          html += '<tbody>';
          dataRows.forEach(row => {
            html += '<tr>';
            row.forEach(cell => {
              html += `<td style="padding: 12px; border: 1px solid #e2e8f0; color: #374151; vertical-align: top;">${cell}</td>`;
            });
            html += '</tr>';
          });
          html += '</tbody>';
        }
        
        html += '</table>';
        console.log('✅ Generated HTML table');
        return html;
      });
    }

    function displayAIAnalysis(analysis, container) {
      console.log('🎯 displayAIAnalysis called!');
      console.log('📊 Analysis type:', typeof analysis);
      console.log('📝 Analysis preview:', typeof analysis === 'string' ? analysis.substring(0, 200) + '...' : analysis);
      console.log('📦 Container element:', container);
      
      let html = '<div style="text-align: left; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">';
      
      // Проверяем тип анализа - строка (DeepSeek V3) или объект (старый формат)
      if (typeof analysis === 'string') {
        // DeepSeek V3 возвращает готивый текст - конвертируем markdown в HTML
        // 🔧 ВАЖНО: Сначала конвертируем таблицы (пока есть \n), потом остальное!
        let htmlContent = convertMarkdownTablesToHTML(analysis);
        
        // Потом делаем остальные замены
        htmlContent = htmlContent
          .replace(/\n/g, '<br>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/### (.*?)(<br>|$)/g, '<h3 style="color: #1f2937; margin: 20px 0 10px 0; font-size: 18px; font-weight: 600;">$1</h3>')
          .replace(/## (.*?)(<br>|$)/g, '<h2 style="color: #1f2937; margin: 24px 0 12px 0; font-size: 20px; font-weight: 700;">$1</h2>')
          .replace(/# (.*?)(<br>|$)/g, '<h1 style="color: #1f2937; margin: 28px 0 14px 0; font-size: 24px; font-weight: 800;">$1</h1>');

        html += `
          <div style="color: #374151; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            ${htmlContent}
          </div>
        `;
      } else if (typeof analysis === 'object' && analysis !== null) {
        // Старый объектный формат - оставляем как есть для совместимости
        
        // Уровень критичности
        if (analysis.risk_level) {
          const riskColors = {
            'low': '#16a34a',
            'medium': '#d97706', 
            'high': '#dc2626',
            'critical': '#991b1b'
          };
          const riskTexts = {
            'low': 'Низкий',
            'medium': 'Средний',
            'high': 'Высокий', 
            'critical': 'Критический'
          };
          
          html += `
            <div style="margin-bottom: 20px;">
              <div style="font-weight: 600; margin-bottom: 8px;">🚨 Уровень риска:</div>
              <div style="color: ${riskColors[analysis.risk_level] || '#6b7280'}; font-weight: 600; font-size: 16px;">
                ${riskTexts[analysis.risk_level] || analysis.risk_level}
              </div>
            </div>
          `;
        }

        // Сайты для смены паролей
        if (analysis.security_recommendations?.password_change_sites?.length > 0) {
          html += `
            <div style="margin-bottom: 20px;">
              <div style="font-weight: 600; margin-bottom: 8px;">🔐 Смените пароли на сайтах:</div>
              <ul style="list-style: none; padding-left: 0;">
          `;
          analysis.security_recommendations.password_change_sites.forEach(site => {
            html += `<li style="margin-bottom: 4px; color: #dc2626;">• ${site}</li>`;
          });
          html += '</ul></div>';
        }

        // Краткая сводка
        if (analysis.summary) {
          html += `
            <div style="margin-bottom: 20px;">
              <div style="font-weight: 600; margin-bottom: 8px;">📋 Краткая сводка:</div>
              <div style="color: #374151; line-height: 1.5;">${analysis.summary}</div>
            </div>
          `;
        }

        // Рекомендации
        if (analysis.security_recommendations?.immediate_actions?.length > 0) {
          html += `
            <div>
              <div style="font-weight: 600; margin-bottom: 8px;">⚡ Рекомендуемые действия:</div>
              <ul style="list-style: none; padding-left: 0;">
          `;
          analysis.security_recommendations.immediate_actions.forEach(action => {
            html += `<li style="margin-bottom: 4px; color: #059669;">• ${action}</li>`;
          });
          html += '</ul></div>';
        }
      } else {
        // Fallback для неожиданного формата
        html += `
          <div style="color: #dc2626; font-weight: 600;">
            ❌ Ошибка: неожиданный формат анализа
          </div>
          <pre style="background: #f3f4f6; padding: 10px; border-radius: 4px; margin-top: 10px; overflow-x: auto;">
            ${JSON.stringify(analysis, null, 2)}
          </pre>
        `;
      }

      html += '</div>';
      container.innerHTML = html;
      
      console.log('✅ HTML content set!');
      console.log('📏 HTML length:', html.length);
      console.log('👁️ Container visibility:', container.style.display);
      console.log('🎨 Final HTML preview:', html.substring(0, 300) + '...');
    }

    // Функция стандартного отображения результатов
    function displayStandardLeakResults(sourceResults, aiSummary) {
      results.innerHTML = '';
      
      sourceResults.forEach((result, index) => {
        const sourceName = result.name || `Источник ${index + 1}`;
        
        // Определяем статус на основе найденных данных
        let status = 'success'; // По умолчанию зеленый (нет утечек)
        
        if (result.error) {
          status = 'warning'; // Желтый (ошибка источника)
        } else if (result.ok && result.items) {
          // Проверяем, есть ли данные в результатах
          const hasData = window.checkIfSourceHasLeakData(result, sourceName);
          if (hasData) {
            status = 'danger'; // Красный (найдены утечки)
          }
        }
        
        let displayData = result.items || result.error;
        
        // Если есть обработанные данные от AI, используем их
        if (aiSummary && result.ok && result.items) {
          displayData = window.formatAIDataForLeakSource(result.items, sourceName, aiSummary);
        }
        
        const item = createResultItem(sourceName, status, displayData, false, sourceName);
        results.appendChild(item);
      });
    }

    window.checkIfSourceHasLeakData = function(result, sourceName) {
      if (!result.ok || !result.items) {
        console.log(`❌ ${sourceName}: result.ok=${result.ok}, result.items=`, result.items);
        return false;
      }
      
      // Диагностика для отладки
      console.log(`🔍 Checking ${sourceName}:`, { 
        ok: result.ok, 
        itemsType: typeof result.items, 
        itemsKeys: typeof result.items === 'object' ? Object.keys(result.items) : 'N/A',
        itemsLength: Array.isArray(result.items) ? result.items.length : 'N/A'
      });
      
      // Проверяем каждый источник на наличие данных
      switch (sourceName) {
        case 'ITP':
          // Проверяем новый формат (массив нормализованных записей)
          if (Array.isArray(result.items) && result.items.length > 0) {
            console.log(`🎯 ITP has normalized data: ${result.items.length} records`);
            return true;
          }
          // Проверяем старый формат (объект с группами)
          const hasITPData = result.items && typeof result.items === 'object' && Object.keys(result.items).length > 0;
          console.log(`🎯 ITP has data: ${hasITPData}`, result.items);
          return hasITPData;
        case 'Dyxless':
          return Array.isArray(result.items) && result.items.length > 0;
        case 'LeakOsint':
          return Array.isArray(result.items) && result.items.length > 0;
        case 'Usersbox':
          return Array.isArray(result.items) && result.items.length > 0;
        case 'Vektor':
          return result.items && (Array.isArray(result.items) ? result.items.length > 0 : Object.keys(result.items).length > 0);
        default:
          return false;
      }
    };

    // ===== ФУНКЦИЯ ДЛЯ ФОРМАТИРОВАНИЯ ДАННЫХ ИИ =====
    window.formatAIDataForLeakSource = function(originalData, sourceName, aiSummary) {
      const formattedData = {};
      
      // Если есть обработанные ИИ данные для этого источника, используем их
      if (aiSummary && aiSummary.sources && aiSummary.sources[sourceName]) {
        const sourceInfo = aiSummary.sources[sourceName];
        
        // Показываем количество записей
        if (sourceInfo.foundCount) {
          formattedData['📊 Найдено записей'] = sourceInfo.foundCount;
        }
        
        // Показываем базы данных
        if (sourceInfo.databases && sourceInfo.databases.length > 0) {
          formattedData['🗄️ Базы данных'] = sourceInfo.databases.join(', ');
        }
        
        // Показываем все обработанные записи от ИИ
        if (sourceInfo.records && Array.isArray(sourceInfo.records)) {
          sourceInfo.records.forEach((record, index) => {
            if (record && typeof record === 'object') {
              const recordInfo = [];
              
              // Форматируем каждую запись
              if (record.email) recordInfo.push(`📧 ${record.email}`);
              if (record.phone) recordInfo.push(`📞 ${record.phone}`);
              if (record.name) recordInfo.push(`👤 ${record.name}`);
              if (record.username) recordInfo.push(`🔑 ${record.username}`);
              if (record.password) recordInfo.push(`🔐 ${record.password.substring(0, 8)}...`);
              if (record.database) recordInfo.push(`🗄️ ${record.database}`);
              if (record.source) recordInfo.push(`🔗 ${record.source}`);
              if (record.date) recordInfo.push(`📅 ${record.date}`);
              
              if (recordInfo.length > 0) {
                formattedData[`📄 Запись ${index + 1}`] = recordInfo.join(' | ');
              }
            } else if (typeof record === 'string') {
              formattedData[`📄 Запись ${index + 1}`] = record;
            }
          });
        }
        
        // Добавляем заметки ИИ
        if (sourceInfo.notes) {
          formattedData['📝 Анализ ИИ'] = sourceInfo.notes;
        }
        
        // Если есть обработанные данные, возвращаем их
        if (Object.keys(formattedData).length > 1) { // больше 1 потому что может быть только счетчик
          return formattedData;
        }
      }
      
      // Если нет ИИ данных, используем оригинальные данные
      if (originalData && typeof originalData === 'object') {
        switch (sourceName) {
          case 'ITP':
            formatITPData(originalData, formattedData);
            break;
          case 'Dyxless':
            formatDyxlessData(originalData, formattedData);
            break;
          case 'LeakOsint':
            formatLeakOsintData(originalData, formattedData);
            break;
          case 'Usersbox':
            formatUsersboxData(originalData, formattedData);
            break;
          case 'Vektor':
            formatVektorData(originalData, formattedData);
            break;
          default:
            Object.assign(formattedData, originalData);
        }
      }
      
      return Object.keys(formattedData).length > 0 ? formattedData : originalData;
    };

    function formatITPData(data, formattedData) {
      if (!data || typeof data !== 'object') return;
      
      // Если data это массив нормализованных записей
      if (Array.isArray(data)) {
        formattedData['📊 Общая информация'] = `Найдено ${data.length} записей в базах данных`;
        
        // Показываем каждую запись в структурированном виде
        data.forEach((record, index) => {
          if (record && typeof record === 'object') {
            const userName = record.name || 'Пользователь';
            const dbName = record.dbName || record.source_database || 'Неизвестная БД';
            
            // Заголовок записи
            const recordTitle = `📄 Запись ${index + 1}: ${userName}`;
            let recordContent = [];
            
            // Основная информация
            recordContent.push('🔹 Основная информация:');
            if (record.dataProvider || record._original?.data_provider) {
              recordContent.push(`  � Источник данных: ${record.dataProvider || record._original.data_provider}`);
            }
            recordContent.push(`  💾 База данных: ${dbName}`);
            
            if (record.name) recordContent.push(`  � Имя: ${record.name}`);
            if (record.email) recordContent.push(`  📧 Email: ${record.email}`);
            if (record.phone) recordContent.push(`  📱 Телефон: ${record.phone}`);
            if (record.address) recordContent.push(`  🏠 Адрес: ${record.address}`);
            if (record.birthDate) recordContent.push(`  🎂 Дата рождения: ${record.birthDate}`);
            if (record.gender) recordContent.push(`  ⚧️ Пол: ${record.gender}`);
            if (record.isVip !== undefined) {
              recordContent.push(`  ⭐ VIP статус: ${record.isVip ? 'Да' : 'Нет'}`);
            }
            
            // Учетные записи и безопасность
            const original = record._original;
            if (original?.accounts && Array.isArray(original.accounts) && original.accounts.length > 0) {
              recordContent.push('');
              recordContent.push('🔐 Учетные записи:');
              original.accounts.forEach(account => {
                if (account.title) recordContent.push(`  🏷️ Сервис: ${account.title}`);
                if (account.login) recordContent.push(`  👨‍💻 Логин: ${account.login}`);
                if (account.password) recordContent.push(`  🔑 Пароль: ${account.password}`);
                if (account.password_hash) recordContent.push(`  🔐 Хеш пароля: ${account.password_hash}`);
                if (account.id) recordContent.push(`  🆔 ID: ${account.id}`);
                if (account.url) recordContent.push(`  🌐 URL: ${account.url}`);
              });
            }
            
            // Финансовая информация
            if (original?.financials && Array.isArray(original.financials) && original.financials.length > 0) {
              recordContent.push('');
              recordContent.push('💳 Финансовая информация:');
              original.financials.forEach(financial => {
                if (financial.title) recordContent.push(`  🏦 Банк: ${financial.title}`);
                if (financial.card_number) recordContent.push(`  💳 Номер карты: ${financial.card_number}`);
                if (financial.date && financial.date !== 'undefined') recordContent.push(`  📅 Дата: ${financial.date}`);
              });
            }
            
            // Документы
            if (original?.documents && Array.isArray(original.documents) && original.documents.length > 0) {
              recordContent.push('');
              recordContent.push('📄 Документы:');
              original.documents.forEach(doc => {
                if (doc.type !== undefined) {
                  const docType = doc.type === 0 ? 'Паспорт' : doc.type === 1 ? 'СНИЛС' : `Тип ${doc.type}`;
                  recordContent.push(`  📋 Тип: ${docType}`);
                }
                if (doc.serial) recordContent.push(`  🔢 Номер: ${doc.serial}`);
                if (doc.authority) recordContent.push(`  🏛️ Орган выдачи: ${doc.authority}`);
                if (doc.country) recordContent.push(`  🌍 Страна: ${doc.country}`);
                if (doc.date_issue) recordContent.push(`  � Дата выдачи: ${doc.date_issue}`);
              });
            }
            
            // Телеграм и социальные сети
            if (record.telegramId) {
              recordContent.push('');
              recordContent.push('📱 Социальные сети:');
              recordContent.push(`  📱 Telegram ID: ${record.telegramId}`);
            }
            
            // Дополнительные имена
            if (record.additionalNames && Array.isArray(record.additionalNames)) {
              recordContent.push('');
              recordContent.push('👥 Дополнительные имена:');
              record.additionalNames.forEach(name => {
                recordContent.push(`  📝 ${name}`);
              });
            }
            
            // Дополнительная информация
            const additionalInfo = [];
            if (record.actuality) additionalInfo.push(`📅 Актуальность данных: ${record.actuality}`);
            if (record.createdDate) additionalInfo.push(`� Дата создания: ${record.createdDate}`);
            if (record.phoneCarrier) additionalInfo.push(`📶 Оператор связи: ${record.phoneCarrier}`);
            if (record.phoneRegion) additionalInfo.push(`🌍 Регион: ${record.phoneRegion}`);
            if (record.crmId) additionalInfo.push(`🔢 CRM ID: ${record.crmId}`);
            if (record.senderInn) additionalInfo.push(`🏢 ИНН отправителя: ${record.senderInn}`);
            if (record.senderName) additionalInfo.push(`👔 Отправитель: ${record.senderName}`);
            if (record.postalCode) additionalInfo.push(`📮 Индекс: ${record.postalCode}`);
            if (record.notes) additionalInfo.push(`� Заметки: ${record.notes.substring(0, 100)}...`);
            
            if (additionalInfo.length > 0) {
              recordContent.push('');
              recordContent.push('🔹 Дополнительно:');
              additionalInfo.forEach(info => recordContent.push(`  ${info}`));
            }
            
            formattedData[recordTitle] = recordContent.join('\n');
          }
        });
        
        return;
      }
      
      // Обработка старого формата (если data это объект с группами)
      for (const [groupName, groupData] of Object.entries(data)) {
        if (groupData && groupData.data && Array.isArray(groupData.data)) {
          formattedData[`📁 ${groupName}`] = `${groupData.data.length} записей`;
          
          // Показываем первые несколько записей
          groupData.data.slice(0, 3).forEach((record, index) => {
            if (record && typeof record === 'object') {
              const recordInfo = [];
              if (record.phone) recordInfo.push(`📞 ${record.phone}`);
              if (record.email) recordInfo.push(`📧 ${record.email}`);
              if (record.name) recordInfo.push(`👤 ${record.name}`);
              if (record.address) recordInfo.push(`🏠 ${record.address}`);
              
              if (recordInfo.length > 0) {
                formattedData[`  └ Запись ${index + 1}`] = recordInfo.join(', ');
              }
            }
          });
          
          if (groupData.data.length > 3) {
            formattedData[`  └ ...`] = `и еще ${groupData.data.length - 3} записей`;
          }
        }
      }
    }

    function formatDyxlessData(data, formattedData) {
      if (!Array.isArray(data)) return;
      
      formattedData['📊 Всего записей'] = data.length;
      
      // Группируем по базам данных
      const databases = {};
      data.forEach(record => {
        if (record && record.database) {
          if (!databases[record.database]) {
            databases[record.database] = [];
          }
          databases[record.database].push(record);
        }
      });
      
      // Показываем данные по базам
      for (const [dbName, records] of Object.entries(databases)) {
        formattedData[`🗄️ База: ${dbName}`] = `${records.length} записей`;
        
        // Показываем первые записи
        records.slice(0, 2).forEach((record, index) => {
          const recordInfo = [];
          if (record.email) recordInfo.push(`📧 ${record.email}`);
          if (record.phone) recordInfo.push(`📞 ${record.phone}`);
          if (record.name) recordInfo.push(`👤 ${record.name}`);
          if (record.password) recordInfo.push(`🔑 ${record.password.substring(0, 10)}...`);
          
          if (recordInfo.length > 0) {
            formattedData[`  └ ${index + 1}`] = recordInfo.join(', ');
          }
        });
      }
    }

    function formatLeakOsintData(data, formattedData) {
      if (!Array.isArray(data)) return;
      
      formattedData['📊 Найдено баз'] = data.length;
      
      data.forEach((leak, index) => {
        if (leak && leak.db) {
          formattedData[`🗄️ База: ${leak.db}`] = leak.info || 'Информация о базе';
          
          if (leak.data && Array.isArray(leak.data)) {
            formattedData[`  └ Записей в базе`] = leak.data.length;
            
            // Показываем первые записи
            leak.data.slice(0, 2).forEach((record, recordIndex) => {
              if (typeof record === 'string') {
                formattedData[`  └ ${recordIndex + 1}`] = record;
              } else if (typeof record === 'object') {
                const recordInfo = [];
                Object.entries(record).forEach(([key, value]) => {
                  if (value && typeof value === 'string') {
                    recordInfo.push(`${key}: ${value}`);
                  }
                });
                if (recordInfo.length > 0) {
                  formattedData[`  └ ${recordIndex + 1}`] = recordInfo.join(', ');
                }
              }
            });
          }
        }
      });
    }

    function formatUsersboxData(data, formattedData) {
      if (!Array.isArray(data)) {
        console.log('⚠️ Usersbox data is not an array:', data);
        return;
      }
      
      console.log('📊 Processing Usersbox data:', data.length, 'sources');
      
      data.forEach((sourceData, sourceIndex) => {
        if (!sourceData || typeof sourceData !== 'object') {
          console.log(`⚠️ Invalid source data at index ${sourceIndex}`);
          return;
        }

        const sourceName = sourceData.source || `Source ${sourceIndex + 1}`;
        const items = sourceData.items || [];
        const count = sourceData.count || items.length;
        const hitsCount = sourceData.hitsCount || count;

        console.log(`� Processing source "${sourceName}" with ${items.length} items`);

        // Заголовок источника
        const sourceHeader = `${sourceName}`;
        formattedData[sourceHeader] = `Найдено: ${hitsCount} записей, показано: ${items.length}`;

        // Обрабатываем каждую запись
        items.forEach((record, recordIndex) => {
          if (!record || typeof record !== 'object') return;

          // ID записи
          if (record._id) {
            const idKey = recordIndex === 0 ? '_id:' : `_id: (${recordIndex + 1})`;
            if (typeof record._id === 'string') {
              formattedData[idKey] = `{"$oid":"${record._id}"}`;
            } else {
              formattedData[idKey] = JSON.stringify(record._id);
            }
          }

          // Персональные данные
          if (record.fullName) {
            formattedData['full_name:'] = record.fullName;
          }
          if (record.firstName) {
            formattedData['first_name:'] = record.firstName;
          }
          if (record.lastName) {
            formattedData['last_name:'] = record.lastName;
          }
          if (record.name) {
            formattedData['name:'] = record.name;
          }
          if (record.contactPerson) {
            formattedData['contact_person:'] = record.contactPerson;
          }
          if (record.surName) {
            formattedData['sur_name:'] = record.surName;
          }
          if (record.patronymic) {
            formattedData['patronymic:'] = record.patronymic;
          }

          // Даты
          if (record.birthDate) {
            formattedData['birth_date:'] = record.birthDate;
          }
          if (record.birthday) {
            formattedData['birthday:'] = record.birthday;
          }
          if (record.createdAt) {
            formattedData['created_at:'] = record.createdAt;
          }
          if (record.deliveredAt) {
            formattedData['delivered_at:'] = record.deliveredAt;
          }
          if (record.date) {
            formattedData['date:'] = record.date;
          }
          if (record.deliveryDate) {
            formattedData['delivery_date:'] = record.deliveryDate;
          }
          if (record.datRecognize) {
            formattedData['dat_recognize:'] = record.datRecognize;
          }
          if (record.datProcess) {
            formattedData['dat_process:'] = record.datProcess;
          }
          if (record.updated) {
            formattedData['updated:'] = record.updated;
          }
          if (record.moderationTime) {
            formattedData['moderation_time:'] = record.moderationTime;
          }

          // Контакты
          if (record.phone && record.phone.length > 0) {
            if (record.phone.length === 1) {
              formattedData['phone:'] = record.phone[0];
            } else {
              formattedData['phones:'] = JSON.stringify(record.phone);
            }
          }
          if (record.email && record.email.length > 0) {
            if (record.email.length === 1) {
              formattedData['email:'] = record.email[0];
            } else {
              formattedData['emails:'] = JSON.stringify(record.email);
            }
          }

          // Адреса
          if (record.addresses) {
            formattedData['addresses:'] = JSON.stringify(record.addresses);
          }
          if (record.address) {
            formattedData['address:'] = record.address;
          }
          if (record.addressFact) {
            formattedData['address_fact:'] = record.addressFact;
          }
          if (record.addressReal) {
            formattedData['address_real:'] = record.addressReal;
          }

          // География
          if (record.area) formattedData['area:'] = record.area;
          if (record.city) formattedData['city:'] = record.city;
          if (record.country) formattedData['country:'] = record.country;
          if (record.street) formattedData['street:'] = record.street;
          if (record.house) formattedData['house:'] = record.house;
          if (record.postalCode) formattedData['postal_code:'] = record.postalCode;
          if (record.timezone) formattedData['timezone:'] = record.timezone;
          if (record.fiasId) formattedData['fias_id:'] = record.fiasId;
          if (record.fiasAddr) formattedData['fias_addr:'] = record.fiasAddr;
          if (record.longitude) formattedData['longitude:'] = record.longitude;
          if (record.latitude) formattedData['latitude:'] = record.latitude;
          if (record.floor) formattedData['floor:'] = record.floor;
          if (record.intercom) formattedData['intercom:'] = record.intercom;
          if (record.title) formattedData['title:'] = record.title;

          // Точка выдачи
          if (record.pickupPoint) {
            formattedData['pickup_point:'] = record.pickupPoint;
          }

          // Банковские данные
          if (record.accounts) {
            formattedData['accounts:'] = JSON.stringify(record.accounts);
          }
          if (record.accountNumber) {
            formattedData['account_number:'] = record.accountNumber;
          }
          if (record.cards) {
            formattedData['cards:'] = JSON.stringify(record.cards);
          }
          if (record.inn) {
            formattedData['inn:'] = record.inn;
          }
          if (record.citizenship) {
            formattedData['citizenship:'] = record.citizenship;
          }
          if (record.gender) {
            formattedData['gender:'] = record.gender;
          }

          // Финансовые данные
          if (record.shippingCost) {
            formattedData['shipping_cost:'] = record.shippingCost;
          }
          if (record.price) {
            formattedData['price:'] = record.price;
          }
          if (record.amount) {
            formattedData['amount:'] = record.amount;
          }
          if (record.currency) {
            formattedData['currency:'] = record.currency;
          }

          // Заказы и продукты
          if (record.products) {
            formattedData['products:'] = JSON.stringify(record.products);
          }
          if (record.firstOrder) {
            formattedData['first_order:'] = record.firstOrder;
          }
          if (record.platform) {
            formattedData['platform:'] = record.platform;
          }
          if (record.paid) {
            formattedData['paid:'] = record.paid;
          }
          if (record.deliveryCityId) {
            formattedData['delivery_city_id:'] = record.deliveryCityId;
          }
          if (record.status) {
            formattedData['status:'] = record.status;
          }

          // Спортивные данные
          if (record.wantReceiveInfo) {
            formattedData['want_receive_info:'] = record.wantReceiveInfo;
          }
          if (record.langCode) {
            formattedData['lang_code:'] = record.langCode;
          }
          if (record.cashier) {
            formattedData['cashier:'] = record.cashier;
          }
          if (record.hasSign) {
            formattedData['has_sign:'] = record.hasSign;
          }

          // Профессиональные данные
          if (record.recovery) {
            formattedData['recovery:'] = record.recovery;
          }
          if (record.token) {
            formattedData['token:'] = record.token;
          }
          if (record.stage) {
            formattedData['stage:'] = record.stage;
          }
          if (record.time) {
            formattedData['time:'] = record.time;
          }
          if (record.userInfo) {
            formattedData['user_info:'] = record.userInfo;
          }
          if (record.geo) {
            formattedData['geo:'] = record.geo;
          }
          if (record.work) {
            formattedData['work:'] = record.work;
          }
          if (record.place) {
            formattedData['place:'] = record.place;
          }
          if (record.industry) {
            formattedData['industry:'] = record.industry;
          }
          if (record.position) {
            formattedData['position:'] = record.position;
          }
          if (record.ogrn) {
            formattedData['ogrn:'] = record.ogrn;
          }
          if (record.year) {
            formattedData['year:'] = record.year;
          }
          if (record.month) {
            formattedData['month:'] = record.month;
          }
          if (record.day) {
            formattedData['day:'] = record.day;
          }
          if (record.passport) {
            formattedData['passport:'] = record.passport;
          }
          if (record.docs) {
            formattedData['docs:'] = record.docs;
          }
          if (record.snils) {
            formattedData['snils:'] = record.snils;
          }
          if (record.snilsDop) {
            formattedData['snils_dop:'] = record.snilsDop;
          }
          if (record.idDocName) {
            formattedData['idDocName:'] = record.idDocName;
          }
          if (record.idDoc) {
            formattedData['idDoc:'] = record.idDoc;
          }
          if (record.images) {
            formattedData['images:'] = record.images;
          }
          if (record.login) {
            formattedData['login:'] = record.login;
          }
          if (record.moderation) {
            formattedData['moderation:'] = record.moderation;
          }
          if (record.isModerated) {
            formattedData['is_moderated:'] = record.isModerated;
          }

          // Yandex Eda данные
          if (record.userId) {
            formattedData['user_id:'] = record.userId;
          }
          if (record.yandexUid) {
            formattedData['yandex_uid:'] = record.yandexUid;
          }
          if (record.app) {
            formattedData['app:'] = record.app;
          }
          if (record.userAgent) {
            formattedData['user_agent:'] = record.userAgent;
          }
          if (record.payment) {
            formattedData['payment:'] = record.payment;
          }
          if (record.service) {
            formattedData['service:'] = record.service;
          }

          // Пароли и другие чувствительные данные
          if (record.password) {
            formattedData['password:'] = record.password;
          }

          // Комментарии
          if (record.comment) {
            formattedData['comment:'] = record.comment;
          }

          // Score
          if (record._score) {
            formattedData['_score:'] = record._score;
          }
        });
      });
    }

    function formatVektorData(data, formattedData) {
      if (Array.isArray(data)) {
        formattedData['📊 Всего записей'] = data.length;
        
        data.slice(0, 5).forEach((record, index) => {
          if (typeof record === 'string') {
            formattedData[`📄 ${index + 1}`] = record;
          } else if (typeof record === 'object') {
            const recordInfo = [];
            Object.entries(record).forEach(([key, value]) => {
              if (value) recordInfo.push(`${key}: ${value}`);
            });
            if (recordInfo.length > 0) {
              formattedData[`📄 ${index + 1}`] = recordInfo.join(', ');
            }
          }
        });
      } else if (typeof data === 'object') {
        Object.entries(data).forEach(([key, value]) => {
          if (value) {
            formattedData[key] = Array.isArray(value) ? value.join(', ') : value;
          }
        });
      }
    }

    function formatLeakOsintData(data, formattedData) {
      if (!Array.isArray(data) || data.length === 0) {
        formattedData['📄 Результат'] = 'Нет данных для отображения';
        return;
      }
      
      console.log('🔧 formatLeakOsintData processing records:', data.length);
      
      // Добавляем общую информацию
      formattedData['📊 Всего записей'] = data.length;
      
      // Обрабатываем каждую запись
      data.forEach((record, index) => {
        if (record && typeof record === 'object') {
          const recordTitle = `📄 Запись ${index + 1}`;
          let recordInfo = '';
          
          // Информация о базе данных
          if (record.database) {
            recordInfo += `База данных: ${record.database}\n`;
          }
          if (record.databaseInfo) {
            recordInfo += `Описание базы данных: ${record.databaseInfo}\n\n`;
          }
          
          // Если есть записи данных, показываем их
          if (record.records && Array.isArray(record.records)) {
            recordInfo += `Данные:\n`;
            
            record.records.forEach((dataRecord, dataIndex) => {
              if (dataIndex > 0) recordInfo += '\n';
              
              // Основная информация
              if (dataRecord.fullName) recordInfo += `ФИО: ${dataRecord.fullName}\n`;
              if (dataRecord.firstName) recordInfo += `Имя: ${dataRecord.firstName}\n`;
              if (dataRecord.lastName) recordInfo += `Фамилия: ${dataRecord.lastName}\n`;
              if (dataRecord.middleName) recordInfo += `Отчество: ${dataRecord.middleName}\n`;
              if (dataRecord.nickName) recordInfo += `Никнейм: ${dataRecord.nickName}\n`;
              
              // Контакты
              if (dataRecord.phone) recordInfo += `Телефон: ${dataRecord.phone}\n`;
              if (dataRecord.email) recordInfo += `Email: ${dataRecord.email}\n`;
              
              // Адрес
              if (dataRecord.address) recordInfo += `Адрес: ${dataRecord.address}\n`;
              if (dataRecord.pointAddress) recordInfo += `Адрес пункта выдачи: ${dataRecord.pointAddress}\n`;
              if (dataRecord.region) recordInfo += `Регион: ${dataRecord.region}\n`;
              if (dataRecord.city) recordInfo += `Город: ${dataRecord.city}\n`;
              if (dataRecord.rusStreet) recordInfo += `Улица: ${dataRecord.rusStreet}\n`;
              if (dataRecord.house) recordInfo += `Дом: ${dataRecord.house}\n`;
              if (dataRecord.postCode) recordInfo += `Почтовый индекс: ${dataRecord.postCode}\n`;
              
              // Документы
              if (dataRecord.passport) recordInfo += `Паспорт: ${dataRecord.passport}\n`;
              if (dataRecord.snils) recordInfo += `СНИЛС: ${dataRecord.snils}\n`;
              if (dataRecord.inn) recordInfo += `ИНН: ${dataRecord.inn}\n`;
              
              // Личная информация
              if (dataRecord.birthDate) recordInfo += `Дата рождения: ${dataRecord.birthDate}\n`;
              if (dataRecord.gender) recordInfo += `Пол: ${dataRecord.gender}\n`;
              if (dataRecord.citizenship) recordInfo += `Гражданство: ${dataRecord.citizenship}\n`;
              
              // Финансы
              if (dataRecord.amount) recordInfo += `Сумма заказа: ${dataRecord.amount}\n`;
              if (dataRecord.price) recordInfo += `Цена: ${dataRecord.price}\n`;
              if (dataRecord.balance) recordInfo += `Баланс: ${dataRecord.balance}\n`;
              if (dataRecord.hasCards) recordInfo += `Наличие карт: ${dataRecord.hasCards}\n`;
              
              // Товары и заказы
              if (dataRecord.product) recordInfo += `Товар: ${dataRecord.product}\n`;
              if (dataRecord.product2) recordInfo += `Товар 2: ${dataRecord.product2}\n`;
              if (dataRecord.product3) recordInfo += `Товар 3: ${dataRecord.product3}\n`;
              
              // Компания
              if (dataRecord.company) recordInfo += `Компания: ${dataRecord.company}\n`;
              if (dataRecord.nameCompany) recordInfo += `Название компании: ${dataRecord.nameCompany}\n`;
              
              // Даты
              if (dataRecord.date) recordInfo += `Дата: ${dataRecord.date}\n`;
              if (dataRecord.dateUnix) recordInfo += `Дата: ${dataRecord.dateUnix}\n`;
              if (dataRecord.deliveryDate) recordInfo += `Дата доставки: ${dataRecord.deliveryDate}\n`;
              if (dataRecord.regDate) recordInfo += `Дата регистрации: ${dataRecord.regDate}\n`;
              if (dataRecord.regDateUnix) recordInfo += `Дата регистрации: ${dataRecord.regDateUnix}\n`;
              if (dataRecord.lastActive) recordInfo += `Последняя активность: ${dataRecord.lastActive}\n`;
              
              // Технические данные
              if (dataRecord.os) recordInfo += `ОС: ${dataRecord.os}\n`;
              if (dataRecord.deliveryType) recordInfo += `Тип доставки: ${dataRecord.deliveryType}\n`;
              if (dataRecord.paymentType) recordInfo += `Тип оплаты: ${dataRecord.paymentType}\n`;
              if (dataRecord.status) recordInfo += `Статус: ${dataRecord.status}\n`;
              if (dataRecord.clientType) recordInfo += `Тип клиента: ${dataRecord.clientType}\n`;
              
              // Дополнительная информация
              if (dataRecord.description) recordInfo += `Описание: ${dataRecord.description}\n`;
              if (dataRecord.comment) recordInfo += `Комментарий: ${dataRecord.comment}\n`;
              if (dataRecord.text) recordInfo += `Текст: ${dataRecord.text}\n`;
              if (dataRecord.tags) recordInfo += `Теги: ${dataRecord.tags}\n`;
              if (dataRecord.vkId) recordInfo += `VK ID: ${dataRecord.vkId}\n`;
              if (dataRecord.password) recordInfo += `Пароль: ${dataRecord.password}\n`;
            });
          }
          
          // Убираем последний перенос строки и добавляем запись
          if (recordInfo) {
            formattedData[recordTitle] = recordInfo.trim();
          }
        }
      });
      
      console.log('✅ formatLeakOsintData: Processed', data.length, 'records');
    }

    function displayFinanceData(bodyId, financeData) {
      const bodyEl = document.getElementById(bodyId);
      if (!bodyEl || !financeData) return;
      
      console.log('📊 Displaying finance data:', financeData);
      
      let financeHtml = '<div style="margin-top: 20px; border-top: 2px solid #e5e7eb; padding-top: 16px;">';
      financeHtml += '<h4 style="color: #1f2937; font-weight: 600; margin-bottom: 12px;">💰 Финансовая информация</h4>';
      
      // Информация о компании
      if (financeData.company) {
        financeHtml += '<div style="margin-bottom: 16px;">';
        financeHtml += '<h5 style="color: #374151; font-weight: 600; margin-bottom: 8px;">Компания</h5>';
        financeHtml += formatResultData(financeData.company);
        financeHtml += '</div>';
      }
      
      // Финансовые данные по годам
      if (financeData.data && typeof financeData.data === 'object') {
        financeHtml += '<div style="margin-bottom: 16px;">';
        financeHtml += '<h5 style="color: #374151; font-weight: 600; margin-bottom: 8px;">Финансовые показатели</h5>';
        
        const years = Object.keys(financeData.data).sort((a, b) => b - a); // Сортируем по убыванию
        
        if (years.length > 0) {
          // Показываем последние 3 года
          const recentYears = years.slice(0, 3);
          
          recentYears.forEach(year => {
            const yearData = financeData.data[year];
            if (yearData && typeof yearData === 'object') {
              financeHtml += `<div style="margin-bottom: 12px; padding: 8px; background: #f9fafb; border-radius: 4px;">`;
              financeHtml += `<h6 style="color: #1f2937; font-weight: 600; margin-bottom: 8px;">📅 ${year} год</h6>`;
              
              // Форматируем основные финансовые показатели
              const formattedYearData = formatFinancialIndicators(yearData);
              financeHtml += formatResultData(formattedYearData);
              
              financeHtml += '</div>';
            }
          });
          
          if (years.length > 3) {
            financeHtml += `<div style="color: #6b7280; font-style: italic;">И еще данные за ${years.length - 3} лет(а)</div>`;
          }
        } else {
          financeHtml += '<div style="color: #6b7280;">Нет доступных финансовых данных</div>';
        }
        
        financeHtml += '</div>';
      }
      
      // Ссылки на официальные отчеты
      if (financeData['bo.nalog.ru'] && financeData['bo.nalog.ru']['Отчет']) {
        const reports = financeData['bo.nalog.ru']['Отчет'];
        financeHtml += '<div style="margin-bottom: 16px;">';
        financeHtml += '<h5 style="color: #374151; font-weight: 600; margin-bottom: 8px;">📋 Официальные отчеты ФНС</h5>';
        
        Object.entries(reports).forEach(([year, url]) => {
          financeHtml += `<div style="margin-bottom: 4px;">`;
          financeHtml += `<a href="${url}" target="_blank" style="color: #2563eb; text-decoration: underline;">`;
          financeHtml += `📄 Отчет за ${year} год</a>`;
          financeHtml += `</div>`;
        });
        
        financeHtml += '</div>';
      }
      
      financeHtml += '</div>';
      
      bodyEl.innerHTML += financeHtml;
    }
    
    function formatFinancialIndicators(yearData) {
      const formatted = {};
      
      // Основные показатели с расшифровкой кодов
      const indicators = {
        '1100': 'Итого по разделу I (внеоборотные активы)',
        '1200': 'Итого по разделу II (оборотные активы)', 
        '1600': 'БАЛАНС (актив)',
        '1300': 'Итого по разделу III (капитал и резервы)',
        '1400': 'Итого по разделу IV (долгосрочные обязательства)',
        '1500': 'Итого по разделу V (краткосрочные обязательства)',
        '1700': 'БАЛАНС (пассив)',
        '2110': 'Выручка',
        '2200': 'Прибыль (убыток) от продаж',
        '2300': 'Прибыль (убыток) до налогообложения',
        '2400': 'Чистая прибыль (убыток)'
      };
      
      Object.entries(indicators).forEach(([code, description]) => {
        if (yearData[code] !== undefined && yearData[code] !== null) {
          const value = Number(yearData[code]);
          if (!isNaN(value)) {
            // Форматируем крупные суммы
            formatted[description] = formatCurrency(value);
          }
        }
      });
      
      return formatted;
    }
    
    function formatCurrency(value) {
      if (Math.abs(value) >= 1000000) {
        return `${(value / 1000000).toFixed(1)} млн руб.`;
      } else if (Math.abs(value) >= 1000) {
        return `${(value / 1000).toFixed(0)} тыс. руб.`;
      } else {
        return `${value} руб.`;
      }
    }

    // Функции прогресса
    function showProgress() {
      document.getElementById('progressContainer').style.display = 'block';
      resetProgress();
    }

    function hideProgress() {
      document.getElementById('progressContainer').style.display = 'none';
    }

    function resetProgress() {
      const fill = document.getElementById('progressFill');
      const percent = document.getElementById('progressPercent');
      const status = document.getElementById('progressStatus');
      
      fill.style.width = '0%';
      percent.textContent = '0%';
      status.textContent = 'Инициализация...';
    }

    function updateProgress(percentage, statusText) {
      const fill = document.getElementById('progressFill');
      const percent = document.getElementById('progressPercent');
      const status = document.getElementById('progressStatus');
      
      fill.style.width = percentage + '%';
      percent.textContent = Math.round(percentage) + '%';
      status.textContent = statusText;
    }

    // Создание элементов результатов
    function createResultItem(title, status, data, isOpen = false, sourceName = null) {
      const item = document.createElement('div');
      item.className = `result-card ${isOpen ? 'open' : ''}`;
      
      const statusClass = status === 'success' ? 'status-clean' : 
                         status === 'danger' ? 'status-found' : 'status-error';
      const statusText = status === 'success' ? 'Чисто' : 
                        status === 'danger' ? 'Найдено' : 'Ошибка';

      // Используем правильный форматтер для каждого источника
      let formattedData;
      if (typeof data === 'string') {
        formattedData = data;
      } else if (sourceName) {
        console.log('🎯 createResultItem: Using source-specific formatter for', sourceName);
        formattedData = formatResultDataBySource(data, sourceName);
      } else {
        console.log('🎯 createResultItem: Using default formatter (no sourceName)');
        formattedData = formatResultData(data);
      }

      item.innerHTML = `
        <div class="result-header" onclick="toggleResult(this)">
          <div class="result-title">${title}</div>
          <div class="flex items-center gap-3">
            <span class="status-badge ${statusClass}">${statusText}</span>
            <span class="caret">▶</span>
          </div>
        </div>
        <div class="result-body">
          ${formattedData}
        </div>
      `;

      return item;
    }

    // Функция переключения результата
    function toggleResult(header) {
      const card = header.closest('.result-card');
      card.classList.toggle('open');
    }

    // Функция форматирования данных результата
    function formatResultDataBySource(data, sourceName) {
      console.log('🎯 formatResultDataBySource called for:', sourceName, {
        dataType: typeof data,
        isArray: Array.isArray(data),
        length: Array.isArray(data) ? data.length : 'not array'
      });
      
      switch(sourceName) {
        case 'ITP':
          console.log('🔍 Using ITP formatter');
          return formatITPResultData(data);
        case 'Dyxless':
          console.log('🔍 Using Dyxless formatter (fallback to JSON for now)');
          return formatResultData(data);
        case 'LeakOsint':
          console.log('🔍 Using LeakOsint formatter');
          return formatLeakOsintResultData(data);
        case 'Usersbox':
          console.log('🔍 Using Usersbox formatter');
          return formatUsersboxResultData(data);
        case 'Vektor':
          console.log('🔍 Using Vektor formatter (fallback to JSON for now)');
          return formatResultData(data);
        case 'Snusbase':
          console.log('🔍 Using Snusbase formatter (fallback to JSON for now)');
          return formatResultData(data);
        default:
          console.log('🔍 Using default JSON formatter for:', sourceName);
          return formatResultData(data);
      }
    }

    function formatITPResultData(data) {
      console.log('🔧 formatITPResultData called with:', {
        dataType: typeof data,
        isArray: Array.isArray(data),
        length: Array.isArray(data) ? data.length : 'not array',
        keys: data && typeof data === 'object' ? Object.keys(data).slice(0, 3) : 'no keys'
      });
      
      if (!data) {
        console.log('❌ formatITPResultData: No data provided');
        return '<div style="color: #6b7280;">Нет данных</div>';
      }
      
      const formattedData = {};
      formatITPData(data, formattedData);
      
      console.log('✅ formatITPResultData: Formatted data keys:', Object.keys(formattedData));
      
      // Специальное форматирование для ITP данных с правильными переносами строк
      let html = '<div style="font-family: monospace; line-height: 1.6; white-space: pre-line;">';
      
      for (const [key, value] of Object.entries(formattedData)) {
        if (value !== null && value !== undefined && value !== '') {
          const formattedValue = Array.isArray(value) ? value.join('\n') : String(value);
          html += `<div style="margin-bottom: 20px;"><strong>${key}</strong>\n${formattedValue}</div>`;
        }
      }
      
      html += '</div>';
      
      console.log('📋 formatITPResultData: Final result length:', html ? html.length : 'null');
      
      return html;
    }

    function formatLeakOsintResultData(data) {
      console.log('🔧 formatLeakOsintResultData called with:', {
        dataType: typeof data,
        isArray: Array.isArray(data),
        length: Array.isArray(data) ? data.length : 'not array',
        keys: data && typeof data === 'object' ? Object.keys(data).slice(0, 3) : 'no keys'
      });
      
      if (!data) {
        console.log('❌ formatLeakOsintResultData: No data provided');
        return '<div style="color: #6b7280;">Нет данных</div>';
      }
      
      const formattedData = {};
      formatLeakOsintData(data, formattedData);
      
      console.log('✅ formatLeakOsintResultData: Formatted data keys:', Object.keys(formattedData));
      
      // Специальное форматирование для LeakOsint данных с правильными переносами строк
      let html = '<div style="font-family: monospace; line-height: 1.6; white-space: pre-line;">';
      
      for (const [key, value] of Object.entries(formattedData)) {
        if (value !== null && value !== undefined && value !== '') {
          const formattedValue = Array.isArray(value) ? value.join('\n') : String(value);
          html += `<div style="margin-bottom: 20px;"><strong>${key}</strong>\n${formattedValue}</div>`;
        }
      }
      
      html += '</div>';
      
      console.log('📋 formatLeakOsintResultData: Final result length:', html ? html.length : 'null');
      
      return html;
    }

    function formatUsersboxResultData(data) {
      console.log('🔧 formatUsersboxResultData called with:', {
        dataType: typeof data,
        isArray: Array.isArray(data),
        length: Array.isArray(data) ? data.length : 'not array',
        keys: data && typeof data === 'object' ? Object.keys(data).slice(0, 3) : 'no keys'
      });
      
      if (!data) {
        console.log('❌ formatUsersboxResultData: No data provided');
        return '<div style="color: #6b7280;">Нет данных</div>';
      }
      
      const formattedData = {};
      formatUsersboxData(data, formattedData);
      
      console.log('✅ formatUsersboxResultData: Formatted data keys:', Object.keys(formattedData));
      
      // Специальное форматирование для Usersbox данных с правильными переносами строк
      let html = '<div style="font-family: monospace; line-height: 1.6; white-space: pre-line;">';
      
      for (const [key, value] of Object.entries(formattedData)) {
        if (value !== null && value !== undefined && value !== '') {
          const formattedValue = Array.isArray(value) ? value.join('\n') : String(value);
          html += `<div style="margin-bottom: 20px;"><strong>${key}</strong>\n${formattedValue}</div>`;
        }
      }
      
      html += '</div>';
      
      console.log('📋 formatUsersboxResultData: Final result length:', html ? html.length : 'null');
      
      return html;
    }

    function formatResultData(data) {
      if (!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
        return '<div style="color: #6b7280; font-style: italic;">Нет данных</div>';
      }

      if (typeof data === 'string') {
        return data;
      }

      let html = '<div class="data-grid">';
      
      for (const [key, value] of Object.entries(data)) {
        if (value !== null && value !== undefined && value !== '') {
          const formattedValue = Array.isArray(value) ? value.join(', ') : 
                                 typeof value === 'object' ? JSON.stringify(value, null, 2) : 
                                 String(value);
          
          html += `
            <div class="data-label">${key}</div>
            <div class="data-value">${formattedValue}</div>
          `;
        }
      }
      
      html += '</div>';
      return html;
    }

    // Helper function для создания заголовков с авторизацией
    function createAuthHeaders() {
      const headers = {
        'Content-Type': 'application/json'
      };
      
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      
      return headers;
    }

    // Основная функция поиска
    async function performSearch() {
      if (currentMode === 'password') {
        // Password mode uses its own button and logic
        return;
      }
      
      const query = q.value.trim();
      if (!query) {
        alert('Введите данные для поиска');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Поиск...';
      results.innerHTML = '';
      showProgress();

      try {
        await performLeakSearch(query);
      } catch (error) {
        console.error('Ошибка поиска:', error);
        hideProgress();
        results.innerHTML = `<div class="result-card"><div style="color: #dc2626;">${error.message}</div></div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Проверить';
      }
    }

    // Поиск утечек (новая логика с кнопкой ИИ)
    async function performLeakSearch(query) {
      console.log('🔍 Starting leak search for:', query);
      
      const allResults = [];
      const sources = [
        { name: 'ITP', step: 1 },
        { name: 'Dyxless', step: 2 },
        { name: 'LeakOsint', step: 3 },
        { name: 'Usersbox', step: 4 },
        { name: 'Vektor', step: 5 }
      ];

      // Последовательный поиск по источникам
      for (const source of sources) {
        updateProgress((source.step / sources.length) * 90, `Поиск в ${source.name}...`);
        
        try {
          const response = await fetch('/api/leak-search-step', {
            method: 'POST',
            headers: createAuthHeaders(),
            body: JSON.stringify({
              query: query,
              field: fieldSel.value,
              step: source.step
            })
          });

          const stepData = await response.json();
          
          if (stepData.result) {
            console.log(`✅ ${source.name} completed:`, stepData.result);
            console.log(`📊 ${source.name} response structure:`, {
              ok: stepData.result.ok,
              itemsType: typeof stepData.result.items,
              itemsKeys: typeof stepData.result.items === 'object' ? Object.keys(stepData.result.items) : 'N/A',
              error: stepData.result.error
            });
            // Добавляем имя источника к результату
            allResults.push({ name: source.name, ...stepData.result });
          } else {
            console.log(`❌ ${source.name} failed:`, stepData.error);
            allResults.push({ name: source.name, ok: false, error: stepData.error });
          }
        } catch (error) {
          console.error(`💥 Error in ${source.name}:`, error);
          allResults.push({ name: source.name, ok: false, error: error.message });
        }
        
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      // Сразу показываем сырые результаты
      updateProgress(100, 'Завершено');
      setTimeout(() => {
        hideProgress();
        window.displayLeakResultsBySources(allResults);
      }, 500);
    }

    // Поиск компаний (старая логика без изменений)
    async function performCompanySearch(query) {
      console.log('🏢 Starting company search for:', query);
      
      const allResults = [];
      const sources = [
        { name: 'Datanewton', step: 1 },
        { name: 'Checko', step: 2 }
      ];

      // Последовательный поиск по источникам компаний
      for (let i = 0; i < sources.length; i++) {
        const source = sources[i];
        const progress = 25 + (i * 25);
        
        updateProgress(progress, `Поиск в ${source.name}...`);
        
        try {
          const response = await fetch('/api/company-search-step', {
            method: 'POST',
            headers: createAuthHeaders(),
            body: JSON.stringify({ inn: query, step: source.step })
          });

          const stepData = await response.json();
          
          if (response.ok && stepData.result) {
            allResults.push(stepData.result);
            console.log(`✅ ${source.name} completed:`, stepData.result);
          } else {
            console.log(`❌ ${source.name} failed:`, stepData.error);
            allResults.push({ name: source.name, ok: false, error: stepData.error });
          }
        } catch (error) {
          console.error(`💥 Error in ${source.name}:`, error);
          allResults.push({ name: source.name, ok: false, error: error.message });
        }
        
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      // Для компаний показываем стандартные результаты (без ИИ кнопки)
      updateProgress(100, 'Завершено');
      setTimeout(() => {
        hideProgress();
        displayCompanyResults(allResults);
      }, 500);
    }

    // Форматирование данных компаний (нормализатор для красивого отображения)
    function formatCompanyData(data, sourceName) {
      if (!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
        return '<div style="color: #6b7280; font-style: italic;">Нет данных</div>';
      }

      if (typeof data === 'string') {
        return data;
      }

      let html = '<div class="data-grid">';
      
      // Основная информация о компании
      if (data.name || data.fullName) {
        html += `
          <div class="data-label">🏢 Название</div>
          <div class="data-value">${data.name || data.fullName}</div>
        `;
      }
      
      if (data.inn) {
        html += `
          <div class="data-label">🆔 ИНН</div>
          <div class="data-value">${data.inn}</div>
        `;
      }
      
      if (data.kpp) {
        html += `
          <div class="data-label">🏛️ КПП</div>
          <div class="data-value">${data.kpp}</div>
        `;
      }
      
      if (data.ogrn) {
        html += `
          <div class="data-label">📋 ОГРН</div>
          <div class="data-value">${data.ogrn}</div>
        `;
      }
      
      if (data.address) {
        html += `
          <div class="data-label">📍 Адрес</div>
          <div class="data-value">${data.address}</div>
        `;
      }
      
      if (data.ceo || data.director) {
        html += `
          <div class="data-label">👨‍💼 Руководитель</div>
          <div class="data-value">${data.ceo || data.director}</div>
        `;
      }
      
      if (data.status) {
        html += `
          <div class="data-label">📊 Статус</div>
          <div class="data-value">${data.status}</div>
        `;
      }
      
      if (data.registrationDate) {
        html += `
          <div class="data-label">📅 Дата регистрации</div>
          <div class="data-value">${data.registrationDate}</div>
        `;
      }
      
      // Финансовые данные
      if (data.revenue) {
        html += `
          <div class="data-label">💰 Выручка</div>
          <div class="data-value">${formatCurrency(data.revenue)}</div>
        `;
      }
      
      if (data.profit) {
        html += `
          <div class="data-label">📈 Прибыль</div>
          <div class="data-value">${formatCurrency(data.profit)}</div>
        `;
      }
      
      if (data.employees) {
        html += `
          <div class="data-label">👥 Сотрудники</div>
          <div class="data-value">${data.employees}</div>
        `;
      }
      
      // Контактная информация
      if (data.phone) {
        html += `
          <div class="data-label">📞 Телефон</div>
          <div class="data-value">${data.phone}</div>
        `;
      }
      
      if (data.email) {
        html += `
          <div class="data-label">📧 Email</div>
          <div class="data-value">${data.email}</div>
        `;
      }
      
      if (data.website) {
        html += `
          <div class="data-label">🌐 Сайт</div>
          <div class="data-value"><a href="${data.website}" target="_blank" style="color: #2563eb;">${data.website}</a></div>
        `;
      }
      
      // Если есть финансовые данные отдельно
      if (data.finance && typeof data.finance === 'object') {
        html += '</div>';
        html += '<div style="margin-top: 20px; border-top: 2px solid #e5e7eb; padding-top: 16px;">';
        html += '<h4 style="color: #1f2937; font-weight: 600; margin-bottom: 12px;">💰 Финансовая информация</h4>';
        html += formatResultData(data.finance);
        return html;
      }
      
      // Если остались другие поля
      const processedFields = ['name', 'fullName', 'inn', 'kpp', 'ogrn', 'address', 'ceo', 'director', 'status', 'registrationDate', 'revenue', 'profit', 'employees', 'phone', 'email', 'website', 'finance'];
      
      for (const [key, value] of Object.entries(data)) {
        if (!processedFields.includes(key) && value !== null && value !== undefined && value !== '') {
          const formattedValue = Array.isArray(value) ? value.join(', ') : 
                                 typeof value === 'object' ? JSON.stringify(value, null, 2) : 
                                 String(value);
          
          html += `
            <div class="data-label">${key}</div>
            <div class="data-value">${formattedValue}</div>
          `;
        }
      }
      
      html += '</div>';
      return html;
    }

    // Отображение результатов компаний (стандартная логика)
    function displayCompanyResults(companyResults) {
      results.innerHTML = '';
      
      if (!companyResults || companyResults.length === 0) {
        results.innerHTML = '<div class="result-card"><div style="color: #dc2626;">Нет данных для отображения</div></div>';
        return;
      }

      companyResults.forEach((result, index) => {
        const sourceName = result.name || `Источник ${index + 1}`;
        let status = 'success';
        
        if (result.error) {
          status = 'warning';
        } else if (result.ok && result.items) {
          // Для компаний считаем успехом наличие любых данных
          status = 'success';
        }
        
        // Используем formatCompanyData для красивого отображения
        const formattedData = formatCompanyData(result.items || {}, sourceName);
        const item = createResultItem(sourceName, status, formattedData);
        results.appendChild(item);
      });
    }

    // Обработчики событий
    btn.addEventListener('click', () => {
      console.log('Button clicked! Current mode:', currentMode);
      console.log('Button element:', btn);
      console.log('Query input:', q);
      performSearch();
    });
    
    q.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        console.log('Enter pressed! Current mode:', currentMode);
        performSearch();
      }
    });

    // Обработчики для переключения режимов
    modeLeaks.addEventListener('click', () => {
      setMode('leaks');
    });
    
    modePassword.addEventListener('click', () => {
      setMode('password');
    });

    // Функция переключения режимов
    function setMode(mode) {
      currentMode = mode;
      
      // Убираем активный класс со всех кнопок
      modeLeaks.classList.remove('active');
      modePassword.classList.remove('active');
      
      // Добавляем активный класс к выбранной кнопке
      if (mode === 'leaks') {
        modeLeaks.classList.add('active');
        searchInput.style.display = 'block';
        searchInput.style.justifyContent = 'flex-start';
        passwordInput.style.display = 'none';
        fieldSel.style.display = 'inline-block';
        fieldSel.value = 'phone'; // Устанавливаем телефон по умолчанию
        q.placeholder = 'Например: +79990000000';
        q.value = '';
      } else if (mode === 'password') {
        modePassword.classList.add('active');
        searchInput.style.display = 'none';
        passwordInput.style.display = 'block';
        fieldSel.style.display = 'none';
      }
      
      // Очищаем результаты при смене режима
      results.innerHTML = '';
    }

    // Глобальная функция для переключения результатов
    window.toggleResult = toggleResult;

    // AI Loading функции
    function showAILoading() {
      const overlay = document.getElementById('aiLoadingOverlay');
      if (overlay) {
        overlay.style.display = 'flex';
      }
    }

    function hideAILoading() {
      const overlay = document.getElementById('aiLoadingOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }

    function updateAIStatus(message) {
      const statusElement = document.querySelector('#aiLoadingOverlay .loading-text');
      if (statusElement) {
        statusElement.textContent = message;
      }
    }

    // Делаем функции доступными глобально
    window.showAILoading = showAILoading;
    window.hideAILoading = hideAILoading;
    window.updateAIStatus = updateAIStatus;

    // ===== ОБРАБОТЧИКИ ДЛЯ РЕЖИМА ПРОВЕРКИ ПАРОЛЕЙ =====

    // Переключение видимости пароля (используем уже объявленные переменные)
    if (togglePassword && passwordField) {
      togglePassword.addEventListener('click', () => {
        const type = passwordField.type === 'password' ? 'text' : 'password';
        passwordField.type = type;
        togglePassword.textContent = type === 'password' ? '👁️' : '🙈';
      });
    }

    // Анализ силы пароля при вводе
    if (passwordField && passwordStrength) {
      passwordField.addEventListener('input', () => {
        const password = passwordField.value;
        const strength = analyzePasswordStrength(password);
        passwordStrength.innerHTML = strength.html;
      });
    }

    // Обработчик кнопки проверки пароля
    if (checkPasswordBtn) {
      checkPasswordBtn.addEventListener('click', async () => {
        const password = passwordField.value.trim();
        
        if (!password) {
          alert('Введите пароль для проверки');
          return;
        }
        
        if (password.length < 1 || password.length > 200) {
          alert('Длина пароля должна быть от 1 до 200 символов');
          return;
        }
        
        await checkPasswordSecurity(password);
      });
    }

    // Проверка пароля при нажатии Enter
    if (passwordField) {
      passwordField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          checkPasswordBtn.click();
        }
      });
    }

    // Функция анализа силы пароля
    function analyzePasswordStrength(password) {
      if (!password) {
        return { score: 0, html: '' };
      }
      
      let score = 0;
      let feedback = [];
      
      // Длина
      if (password.length >= 8) score += 20;
      else feedback.push('Длина менее 8 символов');
      
      if (password.length >= 12) score += 10;
      if (password.length >= 16) score += 10;
      
      // Символы
      if (/[a-z]/.test(password)) score += 10;
      else feedback.push('Нет строчных букв');
      
      if (/[A-Z]/.test(password)) score += 10;
      else feedback.push('Нет заглавных букв');
      
      if (/[0-9]/.test(password)) score += 10;
      else feedback.push('Нет цифр');
      
      if (/[^a-zA-Z0-9]/.test(password)) score += 20;
      else feedback.push('Нет специальных символов');
      
      // Уникальность
      const uniqueChars = new Set(password).size;
      if (uniqueChars >= password.length * 0.7) score += 10;
      
      // Определяем уровень
      let level, color, emoji;
      if (score < 30) {
        level = 'Слабый';
        color = '#dc2626';
        emoji = '🔴';
      } else if (score < 60) {
        level = 'Средний';
        color = '#f59e0b';
        emoji = '🟡';
      } else if (score < 80) {
        level = 'Хороший';
        color = '#10b981';
        emoji = '🟢';
      } else {
        level = 'Отличный';
        color = '#059669';
        emoji = '💚';
      }
      
      let html = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <span>${emoji}</span>
          <span style="color: ${color}; font-weight: 600;">Сила пароля: ${level}</span>
          <span style="color: #6b7280;">(${score}/100)</span>
        </div>
      `;
      
      if (feedback.length > 0) {
        html += `<div style="color: #6b7280; font-size: 12px;">💡 ${feedback.join(', ')}</div>`;
      }
      
      return { score, html };
    }

    // Функция проверки пароля через API
    async function checkPasswordSecurity(password) {
      const button = checkPasswordBtn;
      const originalText = button.textContent;
      
      button.disabled = true;
      button.textContent = '🔄 Проверяем...';
      
      try {
        console.log('🔐 Starting password security check...');
        
        const response = await fetch('/api/password-check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error?.message || 'Ошибка проверки пароля');
        }
        
        displayPasswordResults(data, password);
        
      } catch (error) {
        console.error('Password check error:', error);
        
        results.innerHTML = `
          <div class="result-card">
            <div style="color: #dc2626;">
              <strong>❌ Ошибка проверки</strong><br>
              ${error.message || 'Не удалось проверить пароль. Попробуйте позже.'}
            </div>
          </div>
        `;
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    // Функция отображения результатов проверки пароля
    function displayPasswordResults(data, password) {
      let html = '';
      
      if (data.ok === false) {
        html = `
          <div class="result-card">
            <div style="color: #dc2626;">
              <strong>❌ Сервис недоступен</strong><br>
              ${data.error?.message || 'Проверка паролей временно недоступна'}
            </div>
          </div>
        `;
      } else if (data.isCompromised) {
        html = `
          <div class="result-card">
            <div class="result-header">
              <div class="result-title">🚨 Пароль скомпрометирован</div>
              <span class="status-badge status-found">Найден</span>
            </div>
            <div class="result-body" style="display: block;">
              <div class="data-grid">
                <div class="data-label">🔴 Статус</div>
                <div class="data-value">Пароль найден в базах утечек</div>
                
                <div class="data-label">📊 Количество утечек</div>
                <div class="data-value">${data.breachCount || 'Неизвестно'}</div>
                
                <div class="data-label">⚠️ Уровень риска</div>
                <div class="data-value" style="color: #dc2626; font-weight: 600;">ВЫСОКИЙ</div>
                
                <div class="data-label">💡 Рекомендация</div>
                <div class="data-value">
                  <strong style="color: #dc2626;">Немедленно смените этот пароль!</strong><br>
                  Используйте уникальный пароль длиной минимум 12 символов с комбинацией букв, цифр и специальных символов.
                </div>
              </div>
              
              <div style="margin-top: 16px; padding: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px;">
                <strong style="color: #dc2626;">🔥 Критично:</strong> Этот пароль уже известен злоумышленникам и может использоваться для атак на ваши аккаунты.
              </div>
            </div>
          </div>
        `;
      } else {
        html = `
          <div class="result-card">
            <div class="result-header">
              <div class="result-title">✅ Пароль безопасен</div>
              <span class="status-badge status-clean">Чисто</span>
            </div>
            <div class="result-body" style="display: block;">
              <div class="data-grid">
                <div class="data-label">🟢 Статус</div>
                <div class="data-value">Пароль не найден в известных утечках</div>
                
                <div class="data-label">🔍 Проверено баз</div>
                <div class="data-value">DeHashed (крупнейшая база утечек)</div>
                
                <div class="data-label">⭐ Уровень риска</div>
                <div class="data-value" style="color: #059669; font-weight: 600;">НИЗКИЙ</div>
                
                <div class="data-label">💡 Рекомендация</div>
                <div class="data-value">
                  Пароль выглядит безопасным, но рекомендуем:<br>
                  • Использовать уникальные пароли для каждого сайта<br>
                  • Включить двухфакторную аутентификацию<br>
                  • Регулярно менять пароли (раз в 6-12 месяцев)
                </div>
              </div>
              
              <div style="margin-top: 16px; padding: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px;">
                <strong style="color: #059669;">✨ Отлично:</strong> Этот пароль не обнаружен в известных базах утечек данных.
              </div>
            </div>
          </div>
        `;
      }
      
      // Добавляем анализ силы пароля
      const strength = analyzePasswordStrength(password);
      html += `
        <div class="result-card">
          <div class="result-header">
            <div class="result-title">📊 Анализ силы пароля</div>
          </div>
          <div class="result-body" style="display: block;">
            ${strength.html}
            
            <div style="margin-top: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px;">💡 Советы для создания надежного пароля:</div>
              <ul style="margin: 0; padding-left: 16px; color: #6b7280;">
                <li>Используйте минимум 12 символов</li>
                <li>Комбинируйте буквы разного регистра</li>
                <li>Добавляйте цифры и спецсимволы (!@#$%^&*)</li>
                <li>Избегайте личной информации</li>
                <li>Используйте менеджер паролей</li>
              </ul>
            </div>
          </div>
        </div>
      `;
      
      results.innerHTML = html;
    }

    // Nothing OS Dashboard Functions
    window.displayNothingDashboard = function(sourceResults) {
      console.log('🎨 Creating Nothing OS dashboard for:', sourceResults);
      
      const dashboardData = analyzeNothingDashboardData(sourceResults);
      
      document.getElementById('resultsContainer').innerHTML = `
        <div class="dashboard-container">
          <!-- Header Section -->
          <div class="dashboard-header">
            <div class="dashboard-title">
              <h1>Анализ безопасности</h1>
              <p>КОМПЛЕКСНОЕ СКАНИРОВАНИЕ ЦИФРОВОГО СЛЕДА ЗАВЕРШЕНО</p>
              <p>ОБНАРУЖЕНО <strong>${dashboardData.totalBreaches}</strong> УТЕЧЕК ДАННЫХ В <strong>${dashboardData.affectedSources}</strong> ИСТОЧНИКАХ</p>
            </div>
            
            <!-- Stats Grid -->
            <div class="dashboard-stats">
              <div class="stat-card ${dashboardData.foundBreaches > 0 ? 'pulse-red' : ''}">
                <div class="stat-number">${dashboardData.foundBreaches}</div>
                <div class="stat-label">НАЙДЕНО УТЕЧЕК</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${dashboardData.cleanSources}</div>
                <div class="stat-label">ЧИСТЫХ ИСТОЧНИКОВ</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${dashboardData.totalBreaches}</div>
                <div class="stat-label">ВСЕГО ЗАПИСЕЙ</div>
              </div>
              <div class="stat-card ${dashboardData.errorSources > 0 ? 'pulse-red' : ''}">
                <div class="stat-number">${dashboardData.errorSources}</div>
                <div class="stat-label">ОШИБОК СКАНИРОВАНИЯ</div>
              </div>
            </div>
            
            <!-- Risk Indicator -->
            <div class="risk-indicator">
              <div class="risk-circle ${getRiskClass(dashboardData)}">
                <div class="risk-count">${dashboardData.foundBreaches}</div>
                <div class="risk-level">${getRiskLevel(dashboardData)}</div>
              </div>
            </div>
          </div>

          <!-- Action Section -->
          ${dashboardData.foundBreaches > 0 ? `
          <div class="action-section">
            <h2>ТРЕБУЮТСЯ НЕМЕДЛЕННЫЕ ДЕЙСТВИЯ</h2>
            <p>ВАШИ ДАННЫЕ СКОМПРОМЕТИРОВАНЫ. СЛЕДУЙТЕ ПРОТОКОЛУ БЕЗОПАСНОСТИ.</p>
            <div class="action-buttons">
              <button id="nothingFixBtn" class="nothing-btn danger">
                🚨 ЗАПУСТИТЬ ПРОТОКОЛ БЕЗОПАСНОСТИ
              </button>
              <button id="nothingAIBtn" class="nothing-btn">
                🤖 АНАЛИЗ УГРОЗ ИИ
              </button>
            </div>
          </div>
          ` : `
          <div class="action-section">
            <h2>СТАТУС СИСТЕМЫ: БЕЗОПАСНО</h2>
            <p>НЕМЕДЛЕННЫХ УГРОЗ НЕ ОБНАРУЖЕНО. ПРОДОЛЖАЙТЕ МОНИТОРИНГ.</p>
            <div class="action-buttons">
              <button id="nothingAIBtn" class="nothing-btn">
                📊 ДЕТАЛЬНЫЙ АНАЛИЗ
              </button>
            </div>
          </div>
          `}

          <!-- Data Table -->
          <div class="breaches-section">
            <h2>РЕЗУЛЬТАТЫ АНАЛИЗА ИСТОЧНИКОВ</h2>
            <p>ПРОВЕРЕНО ${sourceResults.length} БАЗ ДАННЫХ НА НАЛИЧИЕ ЦИФРОВЫХ СЛЕДОВ</p>
            
            <div class="table-filters">
              <button class="nothing-filter-btn active" data-filter="all">
                ВСЕ ИСТОЧНИКИ (${sourceResults.length})
              </button>
              <button class="nothing-filter-btn" data-filter="breaches">
                СКОМПРОМЕТИРОВАНЫ (${dashboardData.foundBreaches})
              </button>
              <button class="nothing-filter-btn" data-filter="clean">
                БЕЗОПАСНЫ (${dashboardData.cleanSources})
              </button>
              <button class="nothing-filter-btn" data-filter="errors">
                ОШИБКИ (${dashboardData.errorSources})
              </button>
            </div>
            
            <table class="nothing-table">
              <thead>
                <tr>
                  <th>БАЗА ДАННЫХ ИСТОЧНИКА</th>
                  <th>ДАТА СКАНИРОВАНИЯ</th>
                  <th>СТАТУС</th>
                  <th>ДЕЙСТВИЕ</th>
                </tr>
              </thead>
              <tbody>
                ${generateNothingTableRows(sourceResults)}
              </tbody>
            </table>
          </div>
        </div>
      `;

      setupNothingDashboardHandlers(sourceResults);
    };

    function analyzeNothingDashboardData(sourceResults) {
      let totalBreaches = 0;
      let foundBreaches = 0;
      let cleanSources = 0;
      let errorSources = 0;
      let affectedSources = 0;

      sourceResults.forEach(result => {
        if (result.error) {
          errorSources++;
        } else if (result.ok && result.items) {
          const hasData = window.checkIfSourceHasLeakData(result, result.name);
          if (hasData) {
            foundBreaches++;
            affectedSources++;
            
            if (result.name === 'ITP' && typeof result.items === 'object') {
              Object.values(result.items).forEach(db => {
                if (db.data) totalBreaches += db.data.length;
              });
            } else if (Array.isArray(result.items)) {
              totalBreaches += result.items.length;
            } else {
              totalBreaches += 1;
            }
          } else {
            cleanSources++;
          }
        }
      });

      return {
        totalBreaches,
        foundBreaches,
        cleanSources,
        errorSources,
        affectedSources
      };
    }

    function getRiskClass(data) {
      if (data.foundBreaches >= 3) return 'high-risk';
      if (data.foundBreaches >= 1) return 'medium-risk';
      return 'low-risk';
    }

    function getRiskLevel(data) {
      if (data.foundBreaches >= 3) return 'ВЫСОКИЙ РИСК';
      if (data.foundBreaches >= 1) return 'РИСК ОБНАРУЖЕН';
      return 'БЕЗОПАСНО';
    }

    function generateNothingTableRows(sourceResults) {
      return sourceResults.map(result => {
        const sourceName = result.name || 'UNKNOWN';
        const currentDate = new Date().toLocaleDateString('en-US');
        
        let status, statusClass, statusText;
        
        if (result.error) {
          status = 'ERROR';
          statusClass = 'status-error';
          statusText = 'ОШИБКА СКАНИРОВАНИЯ';
        } else if (result.ok && result.items) {
          const hasData = window.checkIfSourceHasLeakData(result, sourceName);
          if (hasData) {
            status = 'COMPROMISED';
            statusClass = 'status-breach';
            statusText = 'ДАННЫЕ НАЙДЕНЫ';
          } else {
            status = 'SECURE';
            statusClass = 'status-clean';
            statusText = 'УГРОЗ НЕТ';
          }
        } else {
          status = 'UNKNOWN';
          statusClass = 'status-error';
          statusText = 'НЕТ ДАННЫХ';
        }

        return `
          <tr class="table-row" data-status="${statusClass}">
            <td>
              <div class="source-info">
                <div class="source-icon">${getNothingSourceIcon(sourceName)}</div>
                <div>
                  <div class="source-name">${sourceName}</div>
                  <div class="source-description">${getNothingSourceDescription(sourceName)}</div>
                </div>
              </div>
            </td>
            <td>${currentDate}</td>
            <td>
              <span class="nothing-status-badge ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td>
              <button class="nothing-details-btn" onclick="showNothingSourceDetails('${sourceName}', ${JSON.stringify(result).replace(/"/g, '&quot;')})">
                ПОДРОБНЕЕ
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getNothingSourceIcon(sourceName) {
      const icons = {
        'ITP': '◉',
        'Dyxless': '◎', 
        'LeakOsint': '⊙',
        'Usersbox': '⊗',
        'Vektor': '⊘'
      };
      return icons[sourceName] || '○';
    }

    function getNothingSourceDescription(sourceName) {
      const descriptions = {
        'ITP': 'БАЗА РАЗВЕДДАННЫХ',
        'Dyxless': 'КОЛЛЕКЦИЯ УТЕЧЕК',
        'LeakOsint': 'OSINT РЕПОЗИТОРИЙ',
        'Usersbox': 'АРХИВ ПОЛЬЗОВАТЕЛЕЙ',
        'Vektor': 'ВЕКТОРНАЯ БАЗА'
      };
      return descriptions[sourceName] || 'ИСТОЧНИК ДАННЫХ';
    }

    function setupNothingDashboardHandlers(sourceResults) {
      // Fix button
      const fixBtn = document.getElementById('nothingFixBtn');
      if (fixBtn) {
        fixBtn.addEventListener('click', () => {
          showNothingFixProtocol(sourceResults);
        });
      }

      // AI button
      const aiBtn = document.getElementById('nothingAIBtn');
      if (aiBtn) {
        aiBtn.addEventListener('click', async () => {
          await performAIAnalysis(sourceResults);
        });
      }

      // Filter buttons
      document.querySelectorAll('.nothing-filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.nothing-filter-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          
          const filter = e.target.dataset.filter;
          filterNothingTable(filter);
        });
      });
    }

    function filterNothingTable(filter) {
      const rows = document.querySelectorAll('.table-row');
      
      rows.forEach(row => {
        const status = row.dataset.status;
        
        if (filter === 'all') {
          row.style.display = '';
        } else if (filter === 'breaches' && status === 'status-breach') {
          row.style.display = '';
        } else if (filter === 'clean' && status === 'status-clean') {
          row.style.display = '';
        } else if (filter === 'errors' && status === 'status-error') {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    window.showNothingSourceDetails = function(sourceName, result) {
      const modal = document.createElement('div');
      modal.className = 'nothing-modal';
      modal.innerHTML = `
        <div class="nothing-modal-content">
          <div class="nothing-modal-header">
            <h3>${getNothingSourceIcon(sourceName)} ${sourceName} - ДЕТАЛЬНЫЕ РЕЗУЛЬТАТЫ СКАНИРОВАНИЯ</h3>
            <button class="nothing-modal-close" onclick="this.closest('.nothing-modal').remove()">×</button>
          </div>
          <div class="nothing-modal-body">
            ${formatResultDataBySource(result.items || result.error, sourceName)}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    };

    function showNothingFixProtocol(sourceResults) {
      const modal = document.createElement('div');
      modal.className = 'nothing-modal';
      modal.innerHTML = `
        <div class="nothing-modal-content">
          <div class="nothing-modal-header">
            <h2>🚨 ПРОТОКОЛ БЕЗОПАСНОСТИ ЗАПУЩЕН</h2>
            <button class="nothing-modal-close" onclick="this.closest('.nothing-modal').remove()">×</button>
          </div>
          <div class="nothing-modal-body">
            <div style="margin-bottom: 24px;">
              <h3 style="color: #ff0000; margin-bottom: 16px;">ФАЗА 1: НЕМЕДЛЕННАЯ ИЗОЛЯЦИЯ</h3>
              <ul style="list-style: none; padding: 0;">
                <li style="padding: 8px 0; border-bottom: 1px solid #333;">🔐 СМЕНИТЕ ВСЕ ПАРОЛИ АККАУНТОВ</li>
                <li style="padding: 8px 0; border-bottom: 1px solid #333;">📱 ВКЛЮЧИТЕ 2FA НА ВСЕХ СЕРВИСАХ</li>
                <li style="padding: 8px 0; border-bottom: 1px solid #333;">🏦 ПРОВЕРЬТЕ ФИНАНСОВЫЕ АККАУНТЫ</li>
                <li style="padding: 8px 0; border-bottom: 1px solid #333;">📧 ЗАЩИТИТЕ EMAIL АККАУНТЫ</li>
              </ul>
              <button class="nothing-btn" style="margin-top: 16px;" onclick="nextProtocolPhase(this)">
                ФАЗА 1 ЗАВЕРШЕНА
              </button>
            </div>
            
            <div style="margin-bottom: 24px; display: none;" data-phase="2">
              <h3 style="color: #ffffff; margin-bottom: 16px;">ФАЗА 2: НАСТРОЙКА МОНИТОРИНГА</h3>
              <ul style="list-style: none; padding: 0;">
                <li style="padding: 8px 0; border-bottom: 1px solid #333;">🔔 НАСТРОЙТЕ УВЕДОМЛЕНИЯ О УТЕЧКАХ</li>
                <li style="padding: 8px 0; border-bottom: 1px solid #333;">📊 ПОДКЛЮЧИТЕ КРЕДИТНЫЙ МОНИТОРИНГ</li>
                <li style="padding: 8px 0; border-bottom: 1px solid #333;">👀 ВКЛЮЧИТЕ УВЕДОМЛЕНИЯ АККАУНТОВ</li>
                <li style="padding: 8px 0; border-bottom: 1px solid #333;">🔄 ЗАПЛАНИРУЙТЕ РЕГУЛЯРНЫЕ СКАНИРОВАНИЯ</li>
              </ul>
              <button class="nothing-btn" style="margin-top: 16px;" onclick="nextProtocolPhase(this)">
                ПРОТОКОЛ ЗАВЕРШЕН
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    window.nextProtocolPhase = function(button) {
      const currentPhase = button.closest('[data-phase], div:not([data-phase])');
      const nextPhase = document.querySelector('[data-phase="2"]');
      
      if (nextPhase && nextPhase.style.display === 'none') {
        currentPhase.style.display = 'none';
        nextPhase.style.display = 'block';
      } else {
        document.querySelector('.nothing-modal').remove();
        alert('🎯 ПРОТОКОЛ БЕЗОПАСНОСТИ ЗАВЕРШЕН. ВАШ ЦИФРОВОЙ СЛЕД ТЕПЕРЬ ЗАЩИЩЕН.');
      }
    };

    // ===== КОРПОРАТИВНЫЙ ИНТЕРФЕЙС =====
    
    // Элементы корпоративного интерфейса
    const corporateBtn = document.getElementById('corporateBtn');
    const corporateInterface = document.getElementById('corporateInterface');
    const backToMainBtn = document.getElementById('backToMainBtn');
    
    // Корпоративные режимы
    const corpModeCompany = document.getElementById('corpModeCompany');
    const corpModeEmployee = document.getElementById('corpModeEmployee');
    const corpModeDomain = document.getElementById('corpModeDomain');
    const corpModeBatch = document.getElementById('corpModeBatch');
    
    // Корпоративные формы
    const corporateSearchInput = document.getElementById('corporateSearchInput');
    const employeeSearchInput = document.getElementById('employeeSearchInput');
    const domainSearchInput = document.getElementById('domainSearchInput');
    const batchSearchInput = document.getElementById('batchSearchInput');
    
    // Корпоративные кнопки поиска
    const corporateSearchBtn = document.getElementById('corporateSearchBtn');
    const employeeSearchBtn = document.getElementById('employeeSearchBtn');
    const domainSearchBtn = document.getElementById('domainSearchBtn');
    const batchSearchBtn = document.getElementById('batchSearchBtn');
    
    // Корпоративные элементы прогресса и результатов
    const corporateProgressContainer = document.getElementById('corporateProgressContainer');
    const corporateProgressFill = document.getElementById('corporateProgressFill');
    const corporateProgressStatus = document.getElementById('corporateProgressStatus');
    const corporateProgressPercent = document.getElementById('corporateProgressPercent');
    const corporateResults = document.getElementById('corporateResults');
    
    let currentCorporateMode = 'company';
    
    // Переключение на корпоративный интерфейс
    if (corporateBtn) {
      corporateBtn.addEventListener('click', () => {
        showCorporateInterface();
      });
    }
    
    // Возврат к основному интерфейсу
    if (backToMainBtn) {
      backToMainBtn.addEventListener('click', () => {
        showMainInterface();
      });
    }
    
    // Переключение корпоративных режимов
    if (corpModeCompany) {
      corpModeCompany.addEventListener('click', () => {
        setCorporateMode('company');
      });
    }
    
    if (corpModeEmployee) {
      corpModeEmployee.addEventListener('click', () => {
        setCorporateMode('employee');
      });
    }
    
    if (corpModeDomain) {
      corpModeDomain.addEventListener('click', () => {
        setCorporateMode('domain');
      });
    }
    
    if (corpModeBatch) {
      corpModeBatch.addEventListener('click', () => {
        setCorporateMode('batch');
      });
    }
    
    // Обработчики корпоративного поиска
    if (corporateSearchBtn) {
      corporateSearchBtn.addEventListener('click', () => {
        performCorporateCompanySearch();
      });
    }
    
    if (employeeSearchBtn) {
      employeeSearchBtn.addEventListener('click', () => {
        performEmployeeSearch();
      });
    }
    
    if (domainSearchBtn) {
      domainSearchBtn.addEventListener('click', () => {
        performDomainSearch();
      });
    }
    
    if (batchSearchBtn) {
      batchSearchBtn.addEventListener('click', () => {
        performBatchSearch();
      });
    }
    
    // Функция показа корпоративного интерфейса
    function showCorporateInterface() {
      // Скрываем основной интерфейс полностью
      document.querySelector('header').style.display = 'none';
      document.querySelector('body > div.container').style.display = 'none';
      
      // Показываем корпоративный интерфейс как отдельную страницу
      corporateInterface.style.display = 'block';
      corporateInterface.style.position = 'fixed';
      corporateInterface.style.top = '0';
      corporateInterface.style.left = '0';
      corporateInterface.style.width = '100%';
      corporateInterface.style.height = '100vh';
      corporateInterface.style.zIndex = '9999';
      corporateInterface.style.backgroundColor = '#ffffff';
      corporateInterface.style.overflow = 'auto';
      
      // Устанавливаем режим по умолчанию
      setCorporateMode('company');
      
      console.log('🏢 Switched to corporate interface as separate page');
    }
    
    // Функция показа основного интерфейса
    function showMainInterface() {
      // Показываем основной интерфейс
      document.querySelector('header').style.display = 'block';
      document.querySelector('body > div.container').style.display = 'block';
      
      // Скрываем корпоративный интерфейс
      corporateInterface.style.display = 'none';
      corporateInterface.style.position = '';
      corporateInterface.style.top = '';
      corporateInterface.style.left = '';
      corporateInterface.style.width = '';
      corporateInterface.style.height = '';
      corporateInterface.style.zIndex = '';
      corporateInterface.style.backgroundColor = '';
      corporateInterface.style.overflow = '';
      
      console.log('🏠 Switched back to main interface');
    }
    
    // Функция переключения корпоративных режимов
    function setCorporateMode(mode) {
      currentCorporateMode = mode;
      
      // Убираем активный класс со всех кнопок
      document.querySelectorAll('#corporateInterface .btn-secondary').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Скрываем все формы
      corporateSearchInput.style.display = 'none';
      employeeSearchInput.style.display = 'none';
      domainSearchInput.style.display = 'none';
      batchSearchInput.style.display = 'none';
      
      // Показываем нужную форму и активируем кнопку
      if (mode === 'company') {
        corpModeCompany.classList.add('active');
        corporateSearchInput.style.display = 'block';
      } else if (mode === 'employee') {
        corpModeEmployee.classList.add('active');
        employeeSearchInput.style.display = 'block';
      } else if (mode === 'domain') {
        corpModeDomain.classList.add('active');
        domainSearchInput.style.display = 'block';
      } else if (mode === 'batch') {
        corpModeBatch.classList.add('active');
        batchSearchInput.style.display = 'block';
      }
      
      // Очищаем результаты
      corporateResults.innerHTML = '';
      hideCorporateProgress();
      
      console.log(`🔄 Corporate mode set to: ${mode}`);
    }
    
    // Функции прогресса для корпоративного интерфейса
    function showCorporateProgress() {
      corporateProgressContainer.style.display = 'block';
      resetCorporateProgress();
    }
    
    function hideCorporateProgress() {
      corporateProgressContainer.style.display = 'none';
    }
    
    function resetCorporateProgress() {
      corporateProgressFill.style.width = '0%';
      corporateProgressPercent.textContent = '0%';
      corporateProgressStatus.textContent = 'Инициализация...';
    }
    
    function updateCorporateProgress(percentage, statusText) {
      corporateProgressFill.style.width = percentage + '%';
      corporateProgressPercent.textContent = Math.round(percentage) + '%';
      corporateProgressStatus.textContent = statusText;
    }
    
    // Поиск компании в корпоративном режиме
    async function performCorporateCompanySearch() {
      const inn = document.getElementById('corporateInn').value.trim();
      const name = document.getElementById('corporateName').value.trim();
      
      if (!inn && !name) {
        alert('Введите ИНН или название компании');
        return;
      }
      
      corporateSearchBtn.disabled = true;
      corporateSearchBtn.textContent = '🔄 Анализируем...';
      corporateResults.innerHTML = '';
      showCorporateProgress();
      
      try {
        console.log('🏢 Starting corporate company search:', { inn, name });
        
        updateCorporateProgress(25, 'Поиск основной информации...');
        
        const response = await fetch('/api/company-search', {
          method: 'POST',
          headers: createAuthHeaders(),
          body: JSON.stringify({
            query: inn || name,
            mode: 'corporate'
          })
        });
        
        updateCorporateProgress(75, 'Обработка результатов...');
        
        const data = await response.json();
        
        updateCorporateProgress(100, 'Завершено');
        
        setTimeout(() => {
          hideCorporateProgress();
          displayCorporateCompanyResults(data, inn, name);
        }, 500);
        
      } catch (error) {
        console.error('Corporate company search error:', error);
        hideCorporateProgress();
        corporateResults.innerHTML = `
          <div class="result-card">
            <div style="color: #dc2626;">
              <strong>❌ Ошибка поиска</strong><br>
              ${error.message}
            </div>
          </div>
        `;
      } finally {
        corporateSearchBtn.disabled = false;
        corporateSearchBtn.textContent = '🔍 Начать анализ';
      }
    }
    
    // Поиск сотрудника
    async function performEmployeeSearch() {
      const field = document.getElementById('employeeField').value;
      const data = document.getElementById('employeeData').value.trim();
      
      if (!data) {
        alert('Введите данные сотрудника');
        return;
      }
      
      employeeSearchBtn.disabled = true;
      employeeSearchBtn.textContent = '🔄 Проверяем...';
      corporateResults.innerHTML = '';
      showCorporateProgress();
      
      try {
        console.log('👤 Starting employee search:', { field, data });
        
        // Используем тот же API что и для обычного поиска утечек
        const allResults = [];
        const sources = [
          { name: 'ITP', step: 1 },
          { name: 'Dyxless', step: 2 },
          { name: 'LeakOsint', step: 3 },
          { name: 'Usersbox', step: 4 },
          { name: 'Vektor', step: 5 }
        ];

        for (const source of sources) {
          updateCorporateProgress((source.step / sources.length) * 90, `Проверка в ${source.name}...`);
          
          try {
            const response = await fetch('/api/leak-search-step', {
              method: 'POST',
              headers: createAuthHeaders(),
              body: JSON.stringify({
                query: data,
                field: field,
                step: source.step,
                mode: 'employee'
              })
            });

            const stepData = await response.json();
            
            if (stepData.result) {
              allResults.push({ name: source.name, ...stepData.result });
            } else {
              allResults.push({ name: source.name, ok: false, error: stepData.error });
            }
          } catch (error) {
            console.error(`Error in ${source.name}:`, error);
            allResults.push({ name: source.name, ok: false, error: error.message });
          }
          
          await new Promise(resolve => setTimeout(resolve, 300));
        }
        
        updateCorporateProgress(100, 'Завершено');
        
        setTimeout(() => {
          hideCorporateProgress();
          displayEmployeeResults(allResults, data, field);
        }, 500);
        
      } catch (error) {
        console.error('Employee search error:', error);
        hideCorporateProgress();
        corporateResults.innerHTML = `
          <div class="result-card">
            <div style="color: #dc2626;">
              <strong>❌ Ошибка проверки</strong><br>
              ${error.message}
            </div>
          </div>
        `;
      } finally {
        employeeSearchBtn.disabled = false;
        employeeSearchBtn.textContent = '🔍 Проверить сотрудника';
      }
    }
    
    // Поиск по домену через Snusbase
    async function performDomainSearch() {
      const domain = document.getElementById('domainName').value.trim();
      
      if (!domain) {
        alert('Введите домен для поиска');
        return;
      }
      
      // Простая валидация домена
      const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?\.[a-zA-Z]{2,}$/;
      if (!domainRegex.test(domain)) {
        alert('Введите корректный домен (например: company.com)');
        return;
      }
      
      domainSearchBtn.disabled = true;
      domainSearchBtn.textContent = '🔄 Ищем утечки...';
      corporateResults.innerHTML = '';
      showCorporateProgress();
      
      try {
        console.log('🌐 Starting domain search for:', domain);
        
        updateCorporateProgress(10, 'Подключение к Snusbase...');
        
        // Вызываем API для поиска по домену
        const response = await fetch('/api/snusbase/domain-search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ domain })
        });
        
        updateCorporateProgress(50, 'Обработка результатов...');
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        updateCorporateProgress(80, 'Анализ данных...');
        
        // Отображаем результаты
        displayDomainResults(data, domain);
        updateCorporateProgress(100, 'Поиск завершен');
        
        setTimeout(() => {
          hideCorporateProgress();
        }, 1000);
        
      } catch (error) {
        console.error('❌ Domain search error:', error);
        corporateResults.innerHTML = `
          <div class="alert alert-error">
            <strong>Ошибка поиска:</strong> ${error.message}
          </div>
        `;
        hideCorporateProgress();
      } finally {
        domainSearchBtn.disabled = false;
        domainSearchBtn.textContent = '🔍 Найти утечки';
      }
    }
    
    // Отображение результатов поиска по домену
    function displayDomainResults(data, domain) {
      if (!data.results || data.results.length === 0) {
        corporateResults.innerHTML = `
          <div class="alert alert-info">
            <h3>🎉 Отличные новости!</h3>
            <p>По домену <strong>${domain}</strong> утечек не найдено.</p>
          </div>
        `;
        return;
      }
      
      // Группируем результаты по базам данных
      const groupedResults = {};
      data.results.forEach(result => {
        const dbName = result.database || 'Неизвестная база';
        if (!groupedResults[dbName]) {
          groupedResults[dbName] = [];
        }
        groupedResults[dbName].push(result);
      });
      
      let html = `
        <div class="alert alert-warning">
          <h3>🚨 Найдены утечки для домена ${domain}</h3>
          <p>Обнаружено <strong>${data.results.length}</strong> записей в <strong>${Object.keys(groupedResults).length}</strong> базах данных.</p>
        </div>
        
        <div class="domain-results">
      `;
      
      // Отображаем результаты по каждой базе
      Object.entries(groupedResults).forEach(([dbName, results]) => {
        // Анализируем типы данных в этой базе
        const dataTypes = {
          emails: results.filter(r => r.email).length,
          passwords: results.filter(r => r.password).length,
          hashes: results.filter(r => r.hash).length,
          names: results.filter(r => r.name).length,
          phones: results.filter(r => r.phone).length,
          addresses: results.filter(r => r.address || r.city || r.country).length
        };
        
        html += `
          <div class="database-group">
            <h4>📊 База данных: ${dbName}</h4>
            <div class="db-stats">
              <p><strong>Найдено записей:</strong> ${results.length}</p>
              <div class="data-types-summary">
                ${dataTypes.emails > 0 ? `<span class="data-type-badge">📧 Email: ${dataTypes.emails}</span>` : ''}
                ${dataTypes.names > 0 ? `<span class="data-type-badge">👤 Имена: ${dataTypes.names}</span>` : ''}
                ${dataTypes.phones > 0 ? `<span class="data-type-badge">📱 Телефоны: ${dataTypes.phones}</span>` : ''}
                ${dataTypes.passwords > 0 ? `<span class="data-type-badge critical">🔑 Пароли: ${dataTypes.passwords}</span>` : ''}
                ${dataTypes.hashes > 0 ? `<span class="data-type-badge warning">🔐 Хеши: ${dataTypes.hashes}</span>` : ''}
                ${dataTypes.addresses > 0 ? `<span class="data-type-badge">🏠 Адреса: ${dataTypes.addresses}</span>` : ''}
              </div>
            </div>
            
            <div class="records-preview">
        `;
        
        // Показываем первые 5 записей
        results.slice(0, 5).forEach(record => {
          html += `
            <div class="record-item">
              <div class="record-email">📧 ${record.email || 'Email скрыт'}</div>
              <div class="record-details">
                ${record.name ? `<div class="record-field"><strong>👤 Имя:</strong> ${record.name}</div>` : ''}
                ${record.phone ? `<div class="record-field"><strong>📱 Телефон:</strong> ${record.phone}</div>` : ''}
                ${record.password ? `<div class="record-field"><strong>🔑 Пароль:</strong> <span class="password-hidden">${record.password.length > 20 ? record.password.substring(0, 20) + '...' : record.password}</span></div>` : ''}
                ${record.hash ? `<div class="record-field"><strong>🔐 Хеш:</strong> <span class="hash-preview">${record.hash.substring(0, 16)}...</span></div>` : ''}
                ${record.address ? `<div class="record-field"><strong>🏠 Адрес:</strong> ${record.address}</div>` : ''}
                ${record.city ? `<div class="record-field"><strong>🏙️ Город:</strong> ${record.city}</div>` : ''}
                ${record.country ? `<div class="record-field"><strong>🌍 Страна:</strong> ${record.country}</div>` : ''}
                ${record.birthdate && record.birthdate !== '0000-00-00' ? `<div class="record-field"><strong>🎂 Дата рождения:</strong> ${record.birthdate}</div>` : ''}
                ${record.gender ? `<div class="record-field"><strong>⚧️ Пол:</strong> ${record.gender}</div>` : ''}
                ${record.job ? `<div class="record-field"><strong>💼 Работа:</strong> ${record.job}</div>` : ''}
                ${record.company ? `<div class="record-field"><strong>🏢 Компания:</strong> ${record.company}</div>` : ''}
                ${record.created ? `<div class="record-field"><strong>📅 Дата создания:</strong> ${new Date(record.created).toLocaleDateString('ru-RU')}</div>` : ''}
                ${record.lastip ? `<div class="record-field"><strong>🌐 Последний IP:</strong> ${record.lastip}</div>` : ''}
                ${record.username ? `<div class="record-field"><strong>👨‍💻 Имя пользователя:</strong> ${record.username}</div>` : ''}
              </div>
              <div class="record-meta">
                <span class="leak-source">Источник: ${record.database || 'Неизвестно'}</span>
              </div>
            </div>
          `;
        });
        
        if (results.length > 5) {
          html += `<p class="more-results">... и еще ${results.length - 5} записей</p>`;
        }
        
        html += `
            </div>
          </div>
        `;
      });
      
      html += `</div>`;
      
      corporateResults.innerHTML = html;
    }
    
    // Массовая проверка
    async function performBatchSearch() {
      const batchData = document.getElementById('batchData').value.trim();
      
      if (!batchData) {
        alert('Введите данные для массовой проверки');
        return;
      }
      
      const lines = batchData.split('\n').filter(line => line.trim().length > 0);
      
      if (lines.length === 0) {
        alert('Нет данных для проверки');
        return;
      }
      
      if (lines.length > 100) {
        alert('Максимум 100 записей за раз');
        return;
      }
      
      batchSearchBtn.disabled = true;
      batchSearchBtn.textContent = '🔄 Обрабатываем...';
      corporateResults.innerHTML = '';
      showCorporateProgress();
      
      try {
        console.log('📋 Starting batch search for', lines.length, 'items');
        
        const batchResults = [];
        
        for (let i = 0; i < lines.length; i++) {
          const item = lines[i].trim();
          const progress = (i / lines.length) * 100;
          
          updateCorporateProgress(progress, `Проверяем ${i + 1} из ${lines.length}: ${item.substring(0, 20)}...`);
          
          // Определяем тип данных автоматически
          const field = detectDataType(item);
          
          try {
            // Быстрая проверка только в одном источнике для массовой проверки
            const response = await fetch('/api/leak-search-step', {
              method: 'POST',
              headers: createAuthHeaders(),
              body: JSON.stringify({
                query: item,
                field: field,
                step: 1, // Только ITP для быстроты
                mode: 'batch'
              })
            });

            const stepData = await response.json();
            batchResults.push({
              query: item,
              field: field,
              result: stepData.result || { ok: false, error: stepData.error }
            });
            
          } catch (error) {
            batchResults.push({
              query: item,
              field: field,
              result: { ok: false, error: error.message }
            });
          }
          
          // Пауза между запросами
          await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        updateCorporateProgress(100, 'Завершено');
        
        setTimeout(() => {
          hideCorporateProgress();
          displayBatchResults(batchResults);
        }, 500);
        
      } catch (error) {
        console.error('Batch search error:', error);
        hideCorporateProgress();
        corporateResults.innerHTML = `
          <div class="result-card">
            <div style="color: #dc2626;">
              <strong>❌ Ошибка массовой проверки</strong><br>
              ${error.message}
            </div>
          </div>
        `;
      } finally {
        batchSearchBtn.disabled = false;
        batchSearchBtn.textContent = '📊 Запустить массовую проверку';
      }
    }
    
    // Функция определения типа данных
    function detectDataType(data) {
      if (/^\+?[0-9\s\-\(\)]{10,}$/.test(data)) {
        return 'phone';
      } else if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data)) {
        return 'email';
      } else if (/^\d{10,12}$/.test(data)) {
        return 'inn';
      } else if (/vk\.com|vkontakte\.ru/.test(data)) {
        return 'vk';
      } else {
        return 'email'; // По умолчанию
      }
    }
    
    // Функции отображения результатов
    function displayCorporateCompanyResults(data, inn, name) {
      const searchQuery = inn || name;
      
      corporateResults.innerHTML = `
        <div class="result-card" style="border: 2px solid #1f2937;">
          <div class="result-header">
            <div class="result-title">🏢 Корпоративный анализ: ${searchQuery}</div>
            <span class="status-badge ${data.success ? 'status-clean' : 'status-error'}">
              ${data.success ? 'Завершен' : 'Ошибка'}
            </span>
          </div>
          <div class="result-body" style="display: block;">
            ${data.success ? formatResultData(data.result || {}) : `<div style="color: #dc2626;">${data.error}</div>`}
          </div>
        </div>
        
        <div class="mt-8 p-6 bg-gray-50 border-2 border-gray-200">
          <h3 class="text-lg font-bold mb-4">🎯 Дополнительные корпоративные функции</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button class="btn-secondary w-full" onclick="alert('🚧 Функция в разработке')">
              📊 Финансовый анализ
            </button>
            <button class="btn-secondary w-full" onclick="alert('🚧 Функция в разработке')">
              👥 Анализ руководства
            </button>
            <button class="btn-secondary w-full" onclick="alert('🚧 Функция в разработке')">
              🔍 Углубленная проверка
            </button>
            <button class="btn-secondary w-full" onclick="alert('🚧 Функция в разработке')">
              📈 Мониторинг изменений
            </button>
          </div>
        </div>
      `;
    }
    
    function displayEmployeeResults(results, query, field) {
      let html = `
        <div class="result-card" style="border: 2px solid #1f2937;">
          <div class="result-header">
            <div class="result-title">👤 Анализ сотрудника: ${query}</div>
            <span class="status-badge status-clean">Завершен</span>
          </div>
          <div class="result-body" style="display: block;">
            <div class="data-grid">
              <div class="data-label">🔍 Тип данных</div>
              <div class="data-value">${getFieldName(field)}</div>
              <div class="data-label">📊 Проверено источников</div>
              <div class="data-value">${results.length}</div>
            </div>
          </div>
        </div>
      `;
      
      // Добавляем результаты по источникам
      results.forEach(result => {
        const sourceName = result.name;
        let status = 'success';
        
        if (result.error) {
          status = 'warning';
        } else if (result.ok && result.items) {
          const hasData = window.checkIfSourceHasLeakData(result, sourceName);
          if (hasData) {
            status = 'danger';
          }
        }
        
        const item = createResultItem(`👤 ${sourceName}`, status, result.items || result.error);
        html += item.outerHTML;
      });
      
      corporateResults.innerHTML = html;
    }
    
    function displayBatchResults(results) {
      const totalItems = results.length;
      const foundItems = results.filter(r => r.result.ok && r.result.items).length;
      const errorItems = results.filter(r => !r.result.ok).length;
      
      let html = `
        <div class="result-card" style="border: 2px solid #1f2937;">
          <div class="result-header">
            <div class="result-title">📊 Результаты массовой проверки</div>
            <span class="status-badge status-clean">Завершено</span>
          </div>
          <div class="result-body" style="display: block;">
            <div class="data-grid">
              <div class="data-label">📝 Всего проверено</div>
              <div class="data-value">${totalItems}</div>
              <div class="data-label">🚨 Найдено утечек</div>
              <div class="data-value" style="color: ${foundItems > 0 ? '#dc2626' : '#059669'};">${foundItems}</div>
              <div class="data-label">❌ Ошибок</div>
              <div class="data-value">${errorItems}</div>
              <div class="data-label">✅ Безопасно</div>
              <div class="data-value">${totalItems - foundItems - errorItems}</div>
            </div>
          </div>
        </div>
      `;
      
      // Детальные результаты
      results.forEach((item, index) => {
        let status = 'success';
        let statusText = 'Чисто';
        
        if (!item.result.ok) {
          status = 'warning';
          statusText = 'Ошибка';
        } else if (item.result.items && window.checkIfSourceHasLeakData(item.result, 'ITP')) {
          status = 'danger';
          statusText = 'Найдено';
        }
        
        html += `
          <div class="result-card">
            <div class="result-header" onclick="toggleResult(this)">
              <div class="result-title">${index + 1}. ${item.query} (${getFieldName(item.field)})</div>
              <div class="flex items-center gap-3">
                <span class="status-badge ${status === 'success' ? 'status-clean' : status === 'danger' ? 'status-found' : 'status-error'}">${statusText}</span>
                <span class="caret">▶</span>
              </div>
            </div>
            <div class="result-body">
              ${typeof item.result.items === 'string' ? item.result.items : 
                (() => {
                  // В массовой проверке все данные приходят от ITP
                  const sourceName = 'ITP';
                  console.log('🎯 Batch result formatting for source:', sourceName, {
                    itemsType: typeof item.result.items,
                    itemsLength: Array.isArray(item.result.items) ? item.result.items.length : 'not array'
                  });
                  return formatResultDataBySource(item.result.items || item.result.error, sourceName);
                })()}
            </div>
          </div>
        `;
      });
      
      corporateResults.innerHTML = html;
    }
    
    function getFieldName(field) {
      const fieldNames = {
        'phone': 'Телефон',
        'email': 'Email',
        'fullname': 'ФИО',
        'vk': 'VK профиль',
        'inn': 'ИНН'
      };
      return fieldNames[field] || field;
    }
  </script>

  <!-- AI Loading Overlay -->
  <div id="aiLoadingOverlay" class="ai-loading-overlay">
    <div class="ai-loading-content">
      <div class="ai-loading-title">🤖 Обработка данных ИИ</div>
      <div class="ai-loading-subtitle">Анализируем найденную информацию...</div>
      
      <div class="ai-spinner"></div>
      
      <div class="ai-progress-dots">
        <div class="ai-dot"></div>
        <div class="ai-dot"></div>
        <div class="ai-dot"></div>
      </div>
      
      <div id="aiStatusText" class="ai-status-text">Подготовка данных для анализа</div>
    </div>
  </div>

</body>
</html>