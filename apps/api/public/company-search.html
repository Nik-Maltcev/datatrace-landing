<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const CompanySearch = () => {
          const [inn, setInn] = useState('');
          const [loadingStage, setLoadingStage] = useState('idle'); // "idle" | "searching" | "processing" | "done" | "error"
          const [resultHTML, setResultHTML] = useState('');
          const [errorMessage, setErrorMessage] = useState('');

          // –í–∞–ª–∏–¥–∞—Ü–∏—è –ò–ù–ù
          const validateINN = (innValue) => {
            const cleanINN = innValue.replace(/\D/g, '');
            return cleanINN.length === 10 || cleanINN.length === 12;
          };

          // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ò–ù–ù –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
          const formatINN = (value) => {
            const digits = value.replace(/\D/g, '');
            return digits.slice(0, 12);
          };

          // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞
          const handleSearch = async () => {
            if (!validateINN(inn)) {
              setErrorMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ò–ù–ù (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä)');
              setLoadingStage('error');
              return;
            }

            try {
              // –≠—Ç–∞–ø 1: –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏
              setLoadingStage('searching');
              setErrorMessage('');
              setResultHTML('');

              const companyResponse = await fetch(`/api/company?inn=${inn}`, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                },
              });

              if (!companyResponse.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ API: ${companyResponse.status} ${companyResponse.statusText}`);
              }

              const companyData = await companyResponse.json();

              // –≠—Ç–∞–ø 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ OpenAI
              setLoadingStage('processing');

              const openaiResponse = await fetch('/api/openai/format-company', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  prompt: `–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π. –ù–∞ –≤—Ö–æ–¥ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å JSON-–æ—Ç–≤–µ—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–º–ø–∞–Ω–∏–∏ (–ò–ù–ù, –û–ì–†–ù, –Ω–∞–∑–≤–∞–Ω–∏–µ, –∞–¥—Ä–µ—Å, –û–ö–í–≠–î—ã, –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥—Ä.).

–ó–∞–¥–∞—á–∞: –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —ç—Ç–æ—Ç JSON –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏ –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî HTML —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª—è–º–∏, –Ω–æ —Å –∫–ª–∞—Å—Å–∞–º–∏ Tailwind CSS (–Ω–∞–ø—Ä–∏–º–µ—Ä, <div class="p-4 bg-white rounded-lg shadow">).

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –ü–µ—Ä–≤–∞—è —Å–µ–∫—Ü–∏—è ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–ø–æ–ª–Ω–æ–µ + —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–µ) –∫—Ä—É–ø–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º, –Ω–∏–∂–µ –ò–ù–ù, –û–ì–†–ù, –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –≤–æ–∑—Ä–∞—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏.
2. –í—Ç–æ—Ä–∞—è —Å–µ–∫—Ü–∏—è ‚Äî –∞–¥—Ä–µ—Å —Å –∏–∫–æ–Ω–∫–æ–π üìç, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π.
3. –¢—Ä–µ—Ç—å—è —Å–µ–∫—Ü–∏—è ‚Äî —Å—Ç–∞—Ç—É—Å –∫–æ–º–ø–∞–Ω–∏–∏, –≤—ã–¥–µ–ª–∏—Ç—å —Ü–≤–µ—Ç–æ–º (–∑–µ–ª—ë–Ω—ã–π –¥–ª—è "–î–µ–π—Å—Ç–≤—É–µ—Ç", –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è "–õ–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–∞").
4. –ß–µ—Ç–≤—ë—Ä—Ç–∞—è —Å–µ–∫—Ü–∏—è ‚Äî –û—Å–Ω–æ–≤–Ω–æ–π –û–ö–í–≠–î (–ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É), –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ ‚Äî –≤ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–º —Å–ø–∏—Å–∫–µ.
5. –ü—è—Ç–∞—è —Å–µ–∫—Ü–∏—è ‚Äî —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–∏ (–§–ò–û, –¥–æ–ª–∂–Ω–æ—Å—Ç—å).
6. –®–µ—Å—Ç–∞—è —Å–µ–∫—Ü–∏—è ‚Äî –∫–æ–Ω—Ç–∞–∫—Ç—ã (email ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π mailto:, —Ç–µ–ª–µ—Ñ–æ–Ω ‚Äî tel:, —Å–∞–π—Ç ‚Äî —Å—Å—ã–ª–∫–∞).
7. –°–µ–¥—å–º–∞—è —Å–µ–∫—Ü–∏—è ‚Äî –∫–∞–ø–∏—Ç–∞–ª –∏ –≤–ª–∞–¥–µ–ª—å—Ü—ã.
8. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–µ–∫—Ü–∏—é.
9. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π HTML (–Ω–∏–∫–∞–∫–∏—Ö script).

–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ HTML-–∫–æ–¥–æ–º.

–í–æ—Ç JSON: ${JSON.stringify(companyData)}`,
                  model: 'gpt-5'
                }),
              });

              if (!openaiResponse.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ OpenAI API: ${openaiResponse.status}`);
              }

              const openaiData = await openaiResponse.json();
              
              // –≠—Ç–∞–ø 3: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
              setResultHTML(openaiData.html || openaiData.content || '');
              setLoadingStage('done');

            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:', error);
              setErrorMessage(error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
              setLoadingStage('error');
            }
          };

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
          const handleKeyPress = (e) => {
            if (e.key === 'Enter' && loadingStage === 'idle') {
              handleSearch();
            }
          };

          // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
          const resetSearch = () => {
            setLoadingStage('idle');
            setResultHTML('');
            setErrorMessage('');
          };

          // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
          const getStatusMessage = () => {
            switch (loadingStage) {
              case 'searching':
                return '–ò–¥—ë—Ç –ø–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...';
              case 'processing':
                return '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...';
              case 'error':
                return errorMessage;
              default:
                return '';
            }
          };

          // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
          const getStatusIcon = () => {
            switch (loadingStage) {
              case 'searching':
              case 'processing':
                return React.createElement('svg', {
                  className: "animate-spin h-5 w-5 text-blue-500",
                  xmlns: "http://www.w3.org/2000/svg",
                  fill: "none",
                  viewBox: "0 0 24 24"
                }, [
                  React.createElement('circle', {
                    key: 'circle',
                    className: "opacity-25",
                    cx: "12",
                    cy: "12",
                    r: "10",
                    stroke: "currentColor",
                    strokeWidth: "4"
                  }),
                  React.createElement('path', {
                    key: 'path',
                    className: "opacity-75",
                    fill: "currentColor",
                    d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  })
                ]);
              case 'error':
                return React.createElement('svg', {
                  className: "h-5 w-5 text-red-500",
                  xmlns: "http://www.w3.org/2000/svg",
                  viewBox: "0 0 20 20",
                  fill: "currentColor"
                }, React.createElement('path', {
                  fillRule: "evenodd",
                  d: "M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",
                  clipRule: "evenodd"
                }));
              case 'done':
                return React.createElement('svg', {
                  className: "h-5 w-5 text-green-500",
                  xmlns: "http://www.w3.org/2000/svg",
                  viewBox: "0 0 20 20",
                  fill: "currentColor"
                }, React.createElement('path', {
                  fillRule: "evenodd",
                  d: "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",
                  clipRule: "evenodd"
                }));
              default:
                return null;
            }
          };

          return React.createElement('div', {
            className: "min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8"
          }, React.createElement('div', {
            className: "max-w-4xl mx-auto"
          }, [
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            React.createElement('div', {
              key: 'header',
              className: "text-center mb-8"
            }, [
              React.createElement('h1', {
                key: 'title',
                className: "text-3xl font-bold text-gray-900 sm:text-4xl"
              }, '–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏'),
              React.createElement('p', {
                key: 'subtitle',
                className: "mt-2 text-lg text-gray-600"
              }, '–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏')
            ]),

            // –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞
            React.createElement('div', {
              key: 'form',
              className: "bg-white shadow-lg rounded-lg p-6 mb-8"
            }, React.createElement('div', {
              className: "flex flex-col sm:flex-row gap-4"
            }, [
              React.createElement('div', {
                key: 'input-group',
                className: "flex-1"
              }, [
                React.createElement('label', {
                  key: 'label',
                  htmlFor: "inn",
                  className: "block text-sm font-medium text-gray-700 mb-2"
                }, '–ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏'),
                React.createElement('input', {
                  key: 'input',
                  id: "inn",
                  type: "text",
                  value: inn,
                  onChange: (e) => setInn(formatINN(e.target.value)),
                  onKeyPress: handleKeyPress,
                  placeholder: "–ù–∞–ø—Ä–∏–º–µ—Ä: 7707083893",
                  disabled: loadingStage === 'searching' || loadingStage === 'processing',
                  className: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed text-lg",
                  maxLength: "12"
                })
              ]),
              React.createElement('div', {
                key: 'button-group',
                className: "flex flex-col justify-end"
              }, React.createElement('button', {
                onClick: handleSearch,
                disabled: loadingStage === 'searching' || loadingStage === 'processing' || !inn.trim(),
                className: "px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200 text-lg"
              }, loadingStage === 'searching' || loadingStage === 'processing' ? '–ü–æ–∏—Å–∫...' : '–ü–æ–∏—Å–∫'))
            ])),

            // –°—Ç–∞—Ç—É—Å
            (loadingStage !== 'idle' && loadingStage !== 'done') ? React.createElement('div', {
              key: 'status',
              className: "bg-white shadow-lg rounded-lg p-6 mb-8"
            }, [
              React.createElement('div', {
                key: 'status-content',
                className: "flex items-center justify-center space-x-3"
              }, [
                getStatusIcon(),
                React.createElement('span', {
                  key: 'status-text',
                  className: `text-lg font-medium ${loadingStage === 'error' ? 'text-red-600' : 'text-blue-600'}`
                }, getStatusMessage())
              ]),
              loadingStage === 'error' ? React.createElement('div', {
                key: 'retry',
                className: "mt-4 text-center"
              }, React.createElement('button', {
                onClick: resetSearch,
                className: "px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200"
              }, '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞')) : null
            ]) : null,

            // –†–µ–∑—É–ª—å—Ç–∞—Ç
            (loadingStage === 'done' && resultHTML) ? React.createElement('div', {
              key: 'result',
              className: "bg-white shadow-lg rounded-lg overflow-hidden"
            }, [
              React.createElement('div', {
                key: 'result-header',
                className: "p-6 border-b border-gray-200 flex items-center justify-between"
              }, [
                React.createElement('div', {
                  key: 'result-title',
                  className: "flex items-center space-x-2"
                }, [
                  getStatusIcon(),
                  React.createElement('h2', {
                    key: 'title',
                    className: "text-xl font-semibold text-gray-900"
                  }, '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏')
                ]),
                React.createElement('button', {
                  key: 'new-search',
                  onClick: resetSearch,
                  className: "px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200"
                }, '–ù–æ–≤—ã–π –ø–æ–∏—Å–∫')
              ]),
              React.createElement('div', {
                key: 'result-content',
                className: "p-6",
                dangerouslySetInnerHTML: { __html: resultHTML }
              })
            ]) : null,

            // –ü–æ–¥—Å–∫–∞–∑–∫–∏
            loadingStage === 'idle' ? React.createElement('div', {
              key: 'hints',
              className: "bg-blue-50 border border-blue-200 rounded-lg p-4"
            }, React.createElement('div', {
              className: "flex"
            }, [
              React.createElement('div', {
                key: 'icon',
                className: "flex-shrink-0"
              }, React.createElement('svg', {
                className: "h-5 w-5 text-blue-400",
                xmlns: "http://www.w3.org/2000/svg",
                viewBox: "0 0 20 20",
                fill: "currentColor"
              }, React.createElement('path', {
                fillRule: "evenodd",
                d: "M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",
                clipRule: "evenodd"
              }))),
              React.createElement('div', {
                key: 'content',
                className: "ml-3"
              }, [
                React.createElement('h3', {
                  key: 'title',
                  className: "text-sm font-medium text-blue-800"
                }, '–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å'),
                React.createElement('div', {
                  key: 'list',
                  className: "mt-2 text-sm text-blue-700"
                }, React.createElement('ul', {
                  className: "list-disc list-inside space-y-1"
                }, [
                  React.createElement('li', { key: '1' }, '–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏ (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä)'),
                  React.createElement('li', { key: '2' }, '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–∏—Å–∫" –∏–ª–∏ –∫–ª–∞–≤–∏—à—É Enter'),
                  React.createElement('li', { key: '3' }, '–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'),
                  React.createElement('li', { key: '4' }, '–ü–æ–ª—É—á–∏—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –æ –∫–æ–º–ø–∞–Ω–∏–∏')
                ]))
              ])
            ])) : null
          ]));
        };

        ReactDOM.render(React.createElement(CompanySearch), document.getElementById('root'));
    </script>
</body>
</html>