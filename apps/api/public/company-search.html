<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск информации о компании</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const CompanySearch = () => {
          const [inn, setInn] = useState('');
          const [loadingStage, setLoadingStage] = useState('idle'); // "idle" | "searching" | "processing" | "done" | "error"
          const [resultHTML, setResultHTML] = useState('');
          const [errorMessage, setErrorMessage] = useState('');

          // Валидация ИНН
          const validateINN = (innValue) => {
            const cleanINN = innValue.replace(/\D/g, '');
            return cleanINN.length === 10 || cleanINN.length === 12;
          };

          // Форматирование ИНН для отображения
          const formatINN = (value) => {
            const digits = value.replace(/\D/g, '');
            return digits.slice(0, 12);
          };

          // Основная функция поиска
          const handleSearch = async () => {
            if (!validateINN(inn)) {
              setErrorMessage('Введите корректный ИНН (10 или 12 цифр)');
              setLoadingStage('error');
              return;
            }

            try {
              // Этап 1: Поиск информации о компании
              setLoadingStage('searching');
              setErrorMessage('');
              setResultHTML('');

              const companyResponse = await fetch(`/api/company?inn=${inn}`, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                },
              });

              if (!companyResponse.ok) {
                throw new Error(`Ошибка API: ${companyResponse.status} ${companyResponse.statusText}`);
              }

              const companyData = await companyResponse.json();

              // Этап 2: Нормализация данных
              setLoadingStage('processing');

              console.log('Нормализация данных компании...');
              const normalizedData = normalizeCompanyData(companyData.results || []);
              console.log('Нормализованные данные:', normalizedData);
              
              // Этап 3: Отображение результата
              const generatedHTML = generateCompanyHTML(normalizedData, inn);
              console.log('HTML сгенерирован, длина:', generatedHTML.length);
              setResultHTML(generatedHTML);
              setLoadingStage('done');

            } catch (error) {
              console.error('Ошибка при поиске:', error);
              setErrorMessage(error.message || 'Произошла неизвестная ошибка');
              setLoadingStage('error');
            }
          };

          // Обработка Enter в поле ввода
          const handleKeyPress = (e) => {
            if (e.key === 'Enter' && loadingStage === 'idle') {
              handleSearch();
            }
          };

          // Сброс состояния для нового поиска
          const resetSearch = () => {
            setLoadingStage('idle');
            setResultHTML('');
            setErrorMessage('');
          };

          // Получение текста статуса
          const getStatusMessage = () => {
            switch (loadingStage) {
              case 'searching':
                return 'Идёт поиск информации...';
              case 'processing':
                return 'Нормализация данных...';
              case 'error':
                return errorMessage;
              default:
                return '';
            }
          };

          // Получение иконки статуса
          const getStatusIcon = () => {
            switch (loadingStage) {
              case 'searching':
              case 'processing':
                return React.createElement('svg', {
                  className: "animate-spin h-5 w-5 text-blue-500",
                  xmlns: "http://www.w3.org/2000/svg",
                  fill: "none",
                  viewBox: "0 0 24 24"
                }, [
                  React.createElement('circle', {
                    key: 'circle',
                    className: "opacity-25",
                    cx: "12",
                    cy: "12",
                    r: "10",
                    stroke: "currentColor",
                    strokeWidth: "4"
                  }),
                  React.createElement('path', {
                    key: 'path',
                    className: "opacity-75",
                    fill: "currentColor",
                    d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  })
                ]);
              case 'error':
                return React.createElement('svg', {
                  className: "h-5 w-5 text-red-500",
                  xmlns: "http://www.w3.org/2000/svg",
                  viewBox: "0 0 20 20",
                  fill: "currentColor"
                }, React.createElement('path', {
                  fillRule: "evenodd",
                  d: "M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",
                  clipRule: "evenodd"
                }));
              case 'done':
                return React.createElement('svg', {
                  className: "h-5 w-5 text-green-500",
                  xmlns: "http://www.w3.org/2000/svg",
                  viewBox: "0 0 20 20",
                  fill: "currentColor"
                }, React.createElement('path', {
                  fillRule: "evenodd",
                  d: "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",
                  clipRule: "evenodd"
                }));
              default:
                return null;
            }
          };

          // Функция нормализации данных компании
          const normalizeCompanyData = (results) => {
            const normalized = {
              company: {
                name: null,
                fullName: null,
                shortName: null,
                inn: inn,
                ogrn: null,
                kpp: null,
                status: null,
                address: null,
                activity: null,
                registrationDate: null,
                charterCapital: null,
                contacts: { phones: [], emails: [], sites: [] }
              },
              ceo: { name: null, position: null },
              okved: { main: null, additional: [] },
              riskFlags: [],
              sources: []
            };

            for (const result of results || []) {
              if (!result.ok || !result.items) {
                normalized.sources.push({ name: result.name, status: 'error', error: result.error });
                continue;
              }

              normalized.sources.push({ name: result.name, status: 'success' });
              const items = result.items;

              if (result.name === 'Datanewton') {
                const data = items.data?.counterparty || items;
                if (data) {
                  normalized.company.shortName = normalized.company.shortName || data.short_name;
                  normalized.company.fullName = normalized.company.fullName || data.full_name;
                  normalized.company.name = normalized.company.name || data.short_name || data.full_name;
                  normalized.company.ogrn = normalized.company.ogrn || data.ogrn;
                  normalized.company.kpp = normalized.company.kpp || data.kpp;
                  normalized.company.status = normalized.company.status || data.status_string;
                  normalized.company.registrationDate = normalized.company.registrationDate || data.registration_date;
                  
                  if (data.address_block?.line_address) {
                    normalized.company.address = data.address_block.line_address;
                  }
                  if (data.okved_block?.main_okved) {
                    normalized.okved.main = {
                      code: data.okved_block.main_okved.code,
                      text: data.okved_block.main_okved.value
                    };
                  }
                  if (data.manager_block) {
                    normalized.ceo.name = data.manager_block.manager_name;
                    normalized.ceo.position = data.manager_block.manager_position;
                  }
                  if (data.contact_block) {
                    normalized.company.contacts.phones = data.contact_block.phones || [];
                    normalized.company.contacts.emails = data.contact_block.emails || [];
                    normalized.company.contacts.sites = data.contact_block.sites || [];
                  }
                }
              } else if (result.name === 'Checko') {
                normalized.company.name = normalized.company.name || items.name?.short || items.name?.full;
                normalized.company.fullName = normalized.company.fullName || items.name?.full;
                normalized.company.shortName = normalized.company.shortName || items.name?.short;
                normalized.company.ogrn = normalized.company.ogrn || items.ogrn;
                normalized.company.status = normalized.company.status || items.status?.name;
                normalized.company.address = normalized.company.address || items.address?.value;
                normalized.company.charterCapital = normalized.company.charterCapital || items.charterCapital?.value;
                
                if (items.okved?.main) {
                  normalized.okved.main = {
                    code: items.okved.main.code,
                    text: items.okved.main.value
                  };
                }
                if (items.director?.name) {
                  normalized.ceo.name = items.director.name;
                  normalized.ceo.position = 'Генеральный директор';
                }
              }
            }

            return normalized;
          };

          // Функция генерации HTML
          const generateCompanyHTML = (data, searchInn) => {
            const company = data.company;
            const ceo = data.ceo;
            const okved = data.okved;
            
            let html = '<div class="space-y-6">';
            
            // Заголовок компании
            html += '<div class="border-b pb-4">';
            html += `<h1 class="text-2xl font-bold text-gray-900 mb-2">${company.name || 'Название не найдено'}</h1>`;
            if (company.fullName && company.fullName !== company.name) {
              html += `<p class="text-lg text-gray-600 mb-3">${company.fullName}</p>`;
            }
            
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">';
            html += `<div><span class="font-medium text-gray-700">ИНН:</span> <span class="text-gray-900">${company.inn || searchInn}</span></div>`;
            if (company.ogrn) {
              html += `<div><span class="font-medium text-gray-700">ОГРН:</span> <span class="text-gray-900">${company.ogrn}</span></div>`;
            }
            if (company.kpp) {
              html += `<div><span class="font-medium text-gray-700">КПП:</span> <span class="text-gray-900">${company.kpp}</span></div>`;
            }
            if (company.registrationDate) {
              html += `<div><span class="font-medium text-gray-700">Дата регистрации:</span> <span class="text-gray-900">${company.registrationDate}</span></div>`;
            }
            html += '</div></div>';
            
            // Статус
            if (company.status) {
              const isActive = company.status.toLowerCase().includes('действ');
              const statusColor = isActive ? 'text-green-700 bg-green-100' : 'text-red-700 bg-red-100';
              html += `<div class="flex items-center space-x-2">`;
              html += `<span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">${company.status}</span>`;
              html += '</div>';
            }
            
            // Адрес
            if (company.address) {
              html += '<div class="flex items-start space-x-2">';
              html += '<span class="text-lg">📍</span>';
              html += `<div><span class="font-medium text-gray-700">Адрес:</span><br><span class="text-gray-900">${company.address}</span></div>`;
              html += '</div>';
            }
            
            // Деятельность
            if (okved.main) {
              html += '<div>';
              html += '<h3 class="font-medium text-gray-700 mb-2">Основная деятельность:</h3>';
              html += `<div class="bg-gray-50 p-3 rounded">`;
              if (okved.main.code) {
                html += `<div class="text-sm text-gray-600 mb-1">Код ОКВЭД: ${okved.main.code}</div>`;
              }
              html += `<div class="text-gray-900">${okved.main.text}</div>`;
              html += '</div></div>';
            }
            
            // Руководитель
            if (ceo.name) {
              html += '<div>';
              html += '<h3 class="font-medium text-gray-700 mb-2">Руководство:</h3>';
              html += '<div class="bg-gray-50 p-3 rounded">';
              html += `<div class="font-medium text-gray-900">${ceo.name}</div>`;
              if (ceo.position) {
                html += `<div class="text-sm text-gray-600">${ceo.position}</div>`;
              }
              html += '</div></div>';
            }
            
            // Контакты
            const contacts = company.contacts;
            if (contacts.phones.length > 0 || contacts.emails.length > 0 || contacts.sites.length > 0) {
              html += '<div>';
              html += '<h3 class="font-medium text-gray-700 mb-2">Контакты:</h3>';
              html += '<div class="bg-gray-50 p-3 rounded space-y-2">';
              
              if (contacts.phones.length > 0) {
                html += '<div><span class="text-sm text-gray-600">Телефоны:</span><br>';
                contacts.phones.forEach(phone => {
                  html += `<a href="tel:${phone}" class="text-blue-600 hover:text-blue-800 mr-3">${phone}</a>`;
                });
                html += '</div>';
              }
              
              if (contacts.emails.length > 0) {
                html += '<div><span class="text-sm text-gray-600">Email:</span><br>';
                contacts.emails.forEach(email => {
                  html += `<a href="mailto:${email}" class="text-blue-600 hover:text-blue-800 mr-3">${email}</a>`;
                });
                html += '</div>';
              }
              
              if (contacts.sites.length > 0) {
                html += '<div><span class="text-sm text-gray-600">Сайты:</span><br>';
                contacts.sites.forEach(site => {
                  const url = site.startsWith('http') ? site : `https://${site}`;
                  html += `<a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 mr-3">${site}</a>`;
                });
                html += '</div>';
              }
              
              html += '</div></div>';
            }
            
            // Капитал
            if (company.charterCapital) {
              html += '<div>';
              html += '<h3 class="font-medium text-gray-700 mb-2">Уставный капитал:</h3>';
              html += `<div class="bg-gray-50 p-3 rounded text-gray-900">${company.charterCapital}</div>`;
              html += '</div>';
            }
            
            // Источники данных
            html += '<div class="border-t pt-4">';
            html += '<h3 class="font-medium text-gray-700 mb-2">Источники данных:</h3>';
            html += '<div class="flex flex-wrap gap-2">';
            data.sources.forEach(source => {
              const statusColor = source.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
              html += `<span class="px-2 py-1 rounded text-xs ${statusColor}">${source.name}</span>`;
            });
            html += '</div></div>';
            
            html += '</div>';
            return html;
          };

          return React.createElement('div', {
            className: "min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8"
          }, React.createElement('div', {
            className: "max-w-4xl mx-auto"
          }, [
            // Заголовок
            React.createElement('div', {
              key: 'header',
              className: "text-center mb-8"
            }, [
              React.createElement('h1', {
                key: 'title',
                className: "text-3xl font-bold text-gray-900 sm:text-4xl"
              }, 'Поиск информации о компании'),
              React.createElement('p', {
                key: 'subtitle',
                className: "mt-2 text-lg text-gray-600"
              }, 'Введите ИНН для получения подробной информации')
            ]),

            // Форма поиска
            React.createElement('div', {
              key: 'form',
              className: "bg-white shadow-lg rounded-lg p-6 mb-8"
            }, React.createElement('div', {
              className: "flex flex-col sm:flex-row gap-4"
            }, [
              React.createElement('div', {
                key: 'input-group',
                className: "flex-1"
              }, [
                React.createElement('label', {
                  key: 'label',
                  htmlFor: "inn",
                  className: "block text-sm font-medium text-gray-700 mb-2"
                }, 'ИНН компании'),
                React.createElement('input', {
                  key: 'input',
                  id: "inn",
                  type: "text",
                  value: inn,
                  onChange: (e) => setInn(formatINN(e.target.value)),
                  onKeyPress: handleKeyPress,
                  placeholder: "Например: 7707083893",
                  disabled: loadingStage === 'searching' || loadingStage === 'processing',
                  className: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed text-lg",
                  maxLength: "12"
                })
              ]),
              React.createElement('div', {
                key: 'button-group',
                className: "flex flex-col justify-end"
              }, React.createElement('button', {
                onClick: handleSearch,
                disabled: loadingStage === 'searching' || loadingStage === 'processing' || !inn.trim(),
                className: "px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200 text-lg"
              }, loadingStage === 'searching' || loadingStage === 'processing' ? 'Поиск...' : 'Поиск'))
            ])),

            // Статус
            (loadingStage !== 'idle' && loadingStage !== 'done') ? React.createElement('div', {
              key: 'status',
              className: "bg-white shadow-lg rounded-lg p-6 mb-8"
            }, [
              React.createElement('div', {
                key: 'status-content',
                className: "flex items-center justify-center space-x-3"
              }, [
                getStatusIcon(),
                React.createElement('span', {
                  key: 'status-text',
                  className: `text-lg font-medium ${loadingStage === 'error' ? 'text-red-600' : 'text-blue-600'}`
                }, getStatusMessage())
              ]),
              loadingStage === 'error' ? React.createElement('div', {
                key: 'retry',
                className: "mt-4 text-center"
              }, React.createElement('button', {
                onClick: resetSearch,
                className: "px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200"
              }, 'Попробовать снова')) : null
            ]) : null,

            // Результат
            (loadingStage === 'done' && resultHTML) ? React.createElement('div', {
              key: 'result',
              className: "bg-white shadow-lg rounded-lg overflow-hidden"
            }, [
              React.createElement('div', {
                key: 'result-header',
                className: "p-6 border-b border-gray-200 flex items-center justify-between"
              }, [
                React.createElement('div', {
                  key: 'result-title',
                  className: "flex items-center space-x-2"
                }, [
                  getStatusIcon(),
                  React.createElement('h2', {
                    key: 'title',
                    className: "text-xl font-semibold text-gray-900"
                  }, 'Информация о компании')
                ]),
                React.createElement('button', {
                  key: 'new-search',
                  onClick: resetSearch,
                  className: "px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200"
                }, 'Новый поиск')
              ]),
              React.createElement('div', {
                key: 'result-content',
                className: "p-6",
                dangerouslySetInnerHTML: { __html: resultHTML }
              })
            ]) : null,

            // Подсказки
            loadingStage === 'idle' ? React.createElement('div', {
              key: 'hints',
              className: "bg-blue-50 border border-blue-200 rounded-lg p-4"
            }, React.createElement('div', {
              className: "flex"
            }, [
              React.createElement('div', {
                key: 'icon',
                className: "flex-shrink-0"
              }, React.createElement('svg', {
                className: "h-5 w-5 text-blue-400",
                xmlns: "http://www.w3.org/2000/svg",
                viewBox: "0 0 20 20",
                fill: "currentColor"
              }, React.createElement('path', {
                fillRule: "evenodd",
                d: "M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",
                clipRule: "evenodd"
              }))),
              React.createElement('div', {
                key: 'content',
                className: "ml-3"
              }, [
                React.createElement('h3', {
                  key: 'title',
                  className: "text-sm font-medium text-blue-800"
                }, 'Как использовать'),
                React.createElement('div', {
                  key: 'list',
                  className: "mt-2 text-sm text-blue-700"
                }, React.createElement('ul', {
                  className: "list-disc list-inside space-y-1"
                }, [
                  React.createElement('li', { key: '1' }, 'Введите ИНН компании (10 или 12 цифр)'),
                  React.createElement('li', { key: '2' }, 'Нажмите кнопку "Поиск" или клавишу Enter'),
                  React.createElement('li', { key: '3' }, 'Дождитесь обработки информации'),
                  React.createElement('li', { key: '4' }, 'Получите структурированный отчет о компании')
                ]))
              ])
            ])) : null
          ]));
        };

        ReactDOM.render(React.createElement(CompanySearch), document.getElementById('root'));
    </script>
</body>
</html>