<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DataTrace — Проверка утечек</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
      background: #0f1115;
      color: #e6e8ef;
    }

    .container {
      max-width: 880px;
      margin: 48px auto;
      padding: 0 20px;
    }

    .card {
      background: #141824;
      border: 1px solid #23283b;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    h1 {
      font-size: 26px;
      margin: 0 0 12px;
      letter-spacing: 0.2px;
    }

    p.muted {
      color: #a3acc3;
      margin: 0 0 20px;
    }

    .row {
      display: flex;
      gap: 12px;
    }

    input[type="text"] {
      flex: 1;
      background: #0f1320;
      color: #e6e8ef;
      border: 1px solid #2a3046;
      border-radius: 12px;
      padding: 14px 16px;
      outline: none;
      font-size: 15px;
    }

    input[type="text"]:focus {
      border-color: #415bff;
      box-shadow: 0 0 0 4px rgba(65, 91, 255, 0.12);
    }

    button {
      background: #415bff;
      color: #fff;
      border: 0;
      padding: 14px 18px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      min-width: 160px;
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .progress {
      margin: 16px 0 4px;
      height: 8px;
      background: #0f1320;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #2a3046;
    }

    .bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #5b7bff, #7c4dff);
      transition: width .35s ease;
    }

    .small {
      font-size: 12px;
      color: #9aa3ba;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .item {
      background: #101524;
      border: 1px solid #23283b;
      border-radius: 12px;
      padding: 16px;
    }

    .item h3 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .ok {
      color: #6dd193;
    }

    .err {
      color: #ff8080;
    }

    .head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      cursor: pointer;
    }

    .titlewrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .caret {
      color: #9aa3ba;
      transition: transform .2s ease;
      user-select: none;
    }

    .item.open .caret {
      transform: rotate(90deg);
    }

    .body {
      display: none;
      margin-top: 10px;
    }

    .item.open .body {
      display: block;
    }

    .mini-btn {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #2a3046;
      background: #0f1320;
      color: #e6e8ef;
      cursor: pointer;
    }

    .mini-btn:hover {
      border-color: #415bff;
    }

    .mini-btn.danger {
      border-color: rgba(255, 128, 128, 0.45);
      color: #ffb0b0;
    }

    .remove-panel {
      margin: 8px 0 4px;
      padding: 10px;
      border: 1px dashed rgba(255, 128, 128, 0.45);
      background: rgba(255, 128, 128, 0.06);
      border-radius: 10px;
    }

    .remove-panel .step {
      font-size: 13px;
      color: #e6e8ef;
    }

    .badge {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #2a3046;
      margin-left: 8px;
    }

    /* found -> red */
    .badge.found {
      background: rgba(255, 128, 128, 0.12);
      color: #ff8080;
      border-color: rgba(255, 128, 128, 0.35);
    }

    /* empty (нет данных) -> green */
    .badge.empty {
      background: rgba(109, 209, 147, 0.12);
      color: #6dd193;
      border-color: rgba(109, 209, 147, 0.35);
    }

    /* errors remain red */
    .badge.err {
      background: rgba(255, 128, 128, 0.12);
      color: #ff8080;
      border-color: rgba(255, 128, 128, 0.35);
    }

    .rows {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .rowx {
      background: #0f1320;
      border: 1px solid #2a3046;
      border-radius: 10px;
      padding: 10px;
    }

    .rowx .title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip {
      font-size: 12px;
      background: #0b1020;
      border: 1px solid #2a3046;
      color: #c9d2ea;
      padding: 2px 8px;
      border-radius: 999px;
    }

    details {
      margin-top: 10px;
    }

    details summary {
      cursor: pointer;
      color: #9aa3ba;
    }

    .kv {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 6px 12px;
      margin-top: 8px;
    }

    .kv .k {
      color: #9aa3ba;
    }

    .kv .v {
      color: #c9d2ea;
    }

    .sectionTitle {
      margin-top: 10px;
      font-weight: 600;
      color: #e6e8ef;
    }

    .list {
      margin: 6px 0 0;
      padding-left: 18px;
      color: #c9d2ea;
    }

    .footer {
      margin-top: 22px;
      padding: 16px;
      background: #101524;
      border: 1px solid #23283b;
      border-radius: 12px;
    }

    code {
      background: #0f1320;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid #2a3046;
    }

    .summary {
      margin-top: 16px;
      padding: 14px;
      background: #0f1320;
      border: 1px solid #2a3046;
      border-radius: 12px;
    }

    .summary h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    /* Company card specific styles */
    #companyReact {
      margin-top: 20px;
    }

    /* Ensure proper spacing and styling for company data */
    #companyReact .bg-gradient-to-br {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }

    #companyReact .bg-gradient-to-r {
      background: linear-gradient(90deg, #eff6ff 0%, #e0e7ff 100%);
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      #companyReact .grid-cols-\[140px_1fr_auto\] {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      #companyReact .max-w-4xl {
        max-width: 100%;
      }
    }

    /* Новый красивый индикатор прогресса */
    .progress-container {
      margin: 20px 0;
      padding: 20px;
      background: #1a1f2e;
      border: 1px solid #2a3046;
      border-radius: 12px;
    }

    .progress-wrapper {
      margin-bottom: 16px;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: #0f1320;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #2a3046;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #5b7bff, #7c4dff, #10b981);
      border-radius: 6px;
      transition: width 0.3s ease;
      width: 0%;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 14px;
    }

    .progress-text #progressPercent {
      font-weight: 600;
      color: #5b7bff;
      font-size: 16px;
    }

    .progress-text #progressStatus {
      color: #9aa3ba;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      height: 2px;
      background: #2a3046;
      z-index: 1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #2a3046;
      color: #9aa3ba;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s ease;
      border: 2px solid #2a3046;
    }

    .step.active .step-circle {
      background: #5b7bff;
      color: white;
      border-color: #5b7bff;
      box-shadow: 0 0 10px rgba(91, 123, 255, 0.3);
    }

    .step.completed .step-circle {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .step-label {
      margin-top: 8px;
      font-size: 12px;
      color: #9aa3ba;
      text-align: center;
      transition: color 0.3s ease;
    }

    .step.active .step-label {
      color: #5b7bff;
      font-weight: 600;
    }

    .step.completed .step-label {
      color: #10b981;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <h1>Проверка утечек</h1>
      <p class="muted">Выберите режим. Мы последовательно проверим несколько источников.</p>
      <div class="row" style="gap: 10px; flex-wrap: wrap; margin-bottom: 8px;">
        <button id="modeLeaks" class="mini-btn" style="border-color:#415bff;color:#aebcff">Поиск утечек</button>
        <button id="modeCompany" class="mini-btn">Проверить компанию</button>
        <button id="fastMode" class="mini-btn" title="Быстрый режим без ИИ обработки">⚡ Быстро</button>
      </div>
      <div class="row" style="gap: 10px; flex-wrap: wrap;">
        <select id="field"
          style="background:#0f1320;color:#e6e8ef;border:1px solid #2a3046;border-radius:12px;padding:14px 12px;min-width:200px;">
          <option value="phone">Телефон</option>
          <option value="email">Email</option>
          <option value="vk">VK</option>
          <option value="ok">Одноклассники</option>
          <option value="inn">ИНН</option>
          <option value="snils">СНИЛС</option>
        </select>
        <input id="q" type="text" placeholder="Например: +79990000000" />
        <button id="btn">Проверить</button>
      </div>
      <!-- Новый красивый индикатор прогресса -->
      <div id="progressContainer" class="progress-container" style="display: none;">
        <div class="progress-wrapper">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text">
            <span id="progressPercent">0%</span>
            <span id="progressStatus">Ожидание...</span>
          </div>
        </div>
        <div class="progress-steps" id="progressSteps">
          <div class="step" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-label">Поиск данных</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Обработка ИИ</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Готово</div>
          </div>
        </div>
      </div>
      
      <!-- Старый индикатор (скрытый) -->
      <div class="progress" aria-hidden="true" style="display: none;">
        <div class="bar" id="bar"></div>
      </div>
      <div class="small" id="status" style="display: none;">Ожидание ввода…</div>

      <div class="grid" id="results"></div>
      <div id="companyReact" class="mt-4"></div>

      <div class="summary" id="summary" style="display:none">
        <h3>Итоговый вывод ИИ</h3>
        <div id="summaryBody" class="small"></div>
      </div>

      <div class="footer">
        <div style="font-weight:600; margin-bottom:6px;">Удаление информации (временный текст)</div>
        <div>1. стартуйте бота</div>
        <div>2. выберите мой профиль</div>
        <div>3. нажмите "скрыть информацию"</div>
      </div>
    </div>
  </div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script>
    const React = window.React;
    const ReactDOM = window.ReactDOM;

    function cx(...a) { return a.filter(Boolean).join(' ') }
    function Badge({ status }) {
      const active = /действует/i.test(status || '');
      const liq = /ликвид/i.test(status || '');
      return React.createElement('span', {
        className: cx('inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium border',
          active && 'bg-emerald-50 text-emerald-700 border-emerald-200', liq && 'bg-rose-50 text-rose-700 border-rose-200', !active && !liq && 'bg-slate-100 text-slate-600 border-slate-200')
      }, status || '—')
    }
    function Row({ label, value, copy }) {
      const [cop, setCop] = React.useState(false);
      return React.createElement('div', { className: 'grid grid-cols-[140px_1fr_auto] items-start gap-3 py-1' },
        React.createElement('div', { className: 'text-sm text-slate-500' }, label),
        React.createElement('div', { className: 'text-sm text-slate-800 break-words' }, value || '—'),
        copy && value ? React.createElement('button', { className: 'inline-flex items-center gap-1.5 rounded-md border px-2 py-1 text-xs border-slate-200 bg-slate-50 hover:bg-slate-100', onClick: async () => { try { await navigator.clipboard.writeText(String(value)); setCop(true); setTimeout(() => setCop(false), 1200); } catch { } } }, cop ? 'Скопировано' : 'Копировать') : null)
    }
    function List({ items }) { if (!items || !items.length) return React.createElement('div', { className: 'text-sm text-slate-500' }, '—'); return React.createElement('ul', { className: 'text-sm text-slate-800 list-disc pl-5 space-y-1' }, items.map((x, i) => React.createElement('li', { key: i }, x))) }
    function Collapsible({ items, initial = 5 }) {
      const [open, setOpen] = React.useState(false); const shown = open ? items : items.slice(0, initial); return React.createElement(React.Fragment, null,
        React.createElement(List, { items: shown }), items.length > shown.length && React.createElement('button', { onClick: () => setOpen(v => !v), className: 'mt-2 inline-flex items-center gap-1 text-xs text-sky-600 hover:text-sky-700' }, open ? 'Свернуть' : 'Показать ещё'))
    }
    function StatusBadge({ status }) {
      const isActive = /действует/i.test(status || '');
      const isLiquidated = /ликвид/i.test(status || '');
      const className = cx(
        'inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-medium border',
        isActive && 'bg-emerald-50 text-emerald-700 border-emerald-200',
        isLiquidated && 'bg-rose-50 text-rose-700 border-rose-200',
        !isActive && !isLiquidated && 'bg-slate-100 text-slate-600 border-slate-200'
      );
      return React.createElement('span', { className }, status || '—');
    }

    function Section({ title, children }) {
      return React.createElement('div', {
        className: 'rounded-xl border border-slate-200 bg-white/80 p-4 shadow-sm'
      }, [
        React.createElement('h3', {
          key: 'title',
          className: 'text-sm font-semibold text-slate-700 mb-3'
        }, title),
        React.createElement('div', { key: 'content' }, children)
      ]);
    }

    function InfoRow({ label, value, copyable }) {
      const [copied, setCopied] = React.useState(false);
      const text = typeof value === 'string' ? value : undefined;

      return React.createElement('div', {
        className: 'grid grid-cols-[140px_1fr_auto] items-start gap-3 py-2 border-b border-slate-100 last:border-b-0'
      }, [
        React.createElement('div', {
          key: 'label',
          className: 'text-sm font-medium text-slate-500'
        }, label),
        React.createElement('div', {
          key: 'value',
          className: 'text-sm text-slate-800 break-words'
        }, value || '—'),
        copyable && text ? React.createElement('button', {
          key: 'copy',
          className: 'inline-flex items-center gap-1.5 rounded-md border px-2 py-1 text-xs border-slate-200 bg-slate-50 hover:bg-slate-100 transition-colors',
          onClick: async () => {
            try {
              await navigator.clipboard.writeText(text);
              setCopied(true);
              setTimeout(() => setCopied(false), 1200);
            } catch { }
          }
        }, copied ? 'Скопировано' : 'Копировать') : null
      ]);
    }

    function ContactItem({ icon, items, type }) {
      if (!items || !items.length) return null;
      return React.createElement('div', {
        className: 'flex items-center gap-3 text-sm'
      }, [
        React.createElement('div', {
          key: 'icon',
          className: 'w-4 h-4 text-slate-500 flex-shrink-0'
        }, icon),
        React.createElement('div', {
          key: 'items',
          className: 'flex gap-2 flex-wrap'
        }, items.map((item, i) => {
          const href = type === 'email' ? `mailto:${item}` :
            type === 'phone' ? `tel:${item}` :
              type === 'site' ? (/^https?:\/\//i.test(item) ? item : `https://${item}`) : null;
          return React.createElement('a', {
            key: i,
            href,
            className: 'text-blue-600 hover:text-blue-800 hover:underline',
            target: type === 'site' ? '_blank' : undefined,
            rel: type === 'site' ? 'noreferrer' : undefined
          }, item);
        }))
      ]);
    }

    function CollapsibleList({ items, initial = 5 }) {
      const [open, setOpen] = React.useState(false);
      if (!items || !items.length) return React.createElement('div', { className: 'text-sm text-slate-500' }, '—');

      const shown = open ? items : items.slice(0, initial);
      const hasMore = items.length > shown.length;

      return React.createElement('div', {}, [
        React.createElement('ul', {
          key: 'list',
          className: 'text-sm text-slate-800 list-disc pl-5 space-y-1'
        }, shown.map((x, i) => React.createElement('li', { key: i }, x))),
        hasMore ? React.createElement('button', {
          key: 'toggle',
          onClick: () => setOpen(v => !v),
          className: 'mt-2 inline-flex items-center gap-1 text-xs text-blue-600 hover:text-blue-700'
        }, open ? 'Свернуть' : `Показать ещё (${items.length - shown.length})`) : null
      ]);
    }

    function CompanyCardReact({ data }) {
      console.log('CompanyCardReact data:', data);
      const c = data?.company || {};
      const companyName = c.name || c.fullName || c.shortName || 'Компания';
      const phones = c.contacts?.phones || [];
      const emails = c.contacts?.emails || [];
      const sites = c.contacts?.sites || [];
      const okMain = data?.okved?.main;
      const okAdd = data?.okved?.additional || [];

      const managers = React.useMemo(() => {
        const res = [];
        if (data?.ceo) res.push({ name: data.ceo.name || data.ceo.fio, position: data.ceo.position || data.ceo.post });
        if (Array.isArray(data?.managers)) res.push(...data.managers);
        return res.filter(Boolean);
      }, [data?.ceo, data?.managers]);

      const owners = data?.owners || [];

      return React.createElement('div', {
        className: 'w-full mx-auto max-w-4xl'
      },
        React.createElement('div', {
          className: 'rounded-2xl border border-slate-200 bg-gradient-to-br from-white to-slate-50 shadow-xl overflow-hidden'
        }, [
          // Header
          React.createElement('div', {
            key: 'header',
            className: 'p-6 border-b border-slate-200 bg-gradient-to-r from-blue-50 to-indigo-50'
          }, [
            React.createElement('div', {
              key: 'title-row',
              className: 'flex items-center justify-between gap-3 mb-2'
            }, [
              React.createElement('h2', {
                key: 'title',
                className: 'text-xl font-bold text-slate-900'
              }, companyName),
              React.createElement(StatusBadge, { key: 'status', status: c.status })
            ]),
            React.createElement('div', {
              key: 'meta',
              className: 'text-sm text-slate-600'
            }, [c.inn ? `ИНН ${c.inn}` : '', c.ogrn ? ` • ОГРН ${c.ogrn}` : '', c.kpp ? ` • КПП ${c.kpp}` : ''].filter(Boolean).join(''))
          ]),

          // Content
          React.createElement('div', {
            key: 'content',
            className: 'p-6 grid grid-cols-1 gap-6'
          }, [
            // Основная информация
            React.createElement(Section, {
              key: 'main',
              title: 'Основная информация'
            }, [
              React.createElement(InfoRow, { key: 'short', label: 'Краткое название', value: c.shortName || c.name }),
              React.createElement(InfoRow, { key: 'full', label: 'Полное название', value: c.fullName || c.name }),
              React.createElement(InfoRow, { key: 'reg', label: 'Дата регистрации', value: c.registration_date }),
              React.createElement(InfoRow, { key: 'opf', label: 'ОПФ', value: c.opf }),
              c.charter_capital ? React.createElement(InfoRow, { key: 'capital', label: 'Уставной капитал', value: c.charter_capital }) : null
            ].filter(Boolean)),

            // Адрес
            c.address ? React.createElement(Section, {
              key: 'address',
              title: 'Адрес'
            }, React.createElement(InfoRow, { label: 'Юридический адрес', value: c.address, copyable: true })) : null,

            // Контакты
            (phones.length || emails.length || sites.length) ? React.createElement(Section, {
              key: 'contacts',
              title: 'Контакты'
            }, React.createElement('div', { className: 'space-y-3' }, [
              React.createElement(ContactItem, { key: 'emails', icon: '📧', items: emails, type: 'email' }),
              React.createElement(ContactItem, { key: 'phones', icon: '📞', items: phones, type: 'phone' }),
              React.createElement(ContactItem, { key: 'sites', icon: '🌐', items: sites, type: 'site' })
            ].filter(Boolean))) : null,

            // ОКВЭД
            (okMain || okAdd.length) ? React.createElement(Section, {
              key: 'okved',
              title: 'ОКВЭД'
            }, [
              okMain ? React.createElement('div', {
                key: 'main',
                className: 'text-sm mb-3 p-3 bg-blue-50 rounded-lg'
              }, [
                React.createElement('span', { key: 'label', className: 'font-medium text-blue-900' }, 'Основной: '),
                React.createElement('span', { key: 'value', className: 'text-blue-800' }, `${okMain.code || ''} ${okMain.text || okMain.title || ''}`)
              ]) : null,
              okAdd.length ? React.createElement('div', { key: 'additional' }, [
                React.createElement('div', { key: 'label', className: 'text-xs text-slate-500 mb-2' }, 'Дополнительные:'),
                React.createElement(CollapsibleList, {
                  key: 'list',
                  items: okAdd.map(v => `${v.code || ''} ${v.text || v.title || ''}`),
                  initial: 6
                })
              ]) : null
            ].filter(Boolean)) : null,

            // Руководители
            managers.length ? React.createElement(Section, {
              key: 'managers',
              title: 'Руководители'
            }, React.createElement(CollapsibleList, {
              items: managers.map(m => `${m.name || ''}${m.position ? ` — ${m.position}` : ''}`)
            })) : null,

            // Владельцы
            owners.length ? React.createElement(Section, {
              key: 'owners',
              title: 'Владельцы и учредители'
            }, React.createElement(CollapsibleList, {
              items: owners.map(o => [o.name, o.share_text, o.inn].filter(Boolean).join(' — ')),
              initial: 8
            })) : null
          ].filter(Boolean))
        ])
      );
    }
    const q = document.getElementById('q');
    const fieldSel = document.getElementById('field');
    const btn = document.getElementById('btn');
    const modeLeaks = document.getElementById('modeLeaks');
    const modeCompany = document.getElementById('modeCompany');
    const placeholders = {
      phone: 'Например: +79990000000',
      email: 'Например: example@mail.com',
      vk: 'Ссылка или @username или id123',
      ok: 'Ссылка на профиль OK или username',
      inn: 'Например: 781075550363',
      snils: 'Например: 11581339245'
    };

    function updatePlaceholder() {
      const f = fieldSel.value;
      q.placeholder = placeholders[f] || 'Введите запрос';
    }
    updatePlaceholder();
    fieldSel.addEventListener('change', updatePlaceholder);

    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const results = document.getElementById('results');

    // Старая функция прогресса (оставляем для совместимости)
    function setProgress(step, total) {
      const pct = Math.round((step / total) * 100);
      bar.style.width = pct + '%';
    }

    // Новые функции для красивого индикатора прогресса
    function showProgress() {
      const container = document.getElementById('progressContainer');
      container.style.display = 'block';
      resetProgress();
    }

    function hideProgress() {
      const container = document.getElementById('progressContainer');
      container.style.display = 'none';
    }

    function resetProgress() {
      const fill = document.getElementById('progressFill');
      const percent = document.getElementById('progressPercent');
      const status = document.getElementById('progressStatus');
      const steps = document.querySelectorAll('.step');
      
      fill.style.width = '0%';
      percent.textContent = '0%';
      status.textContent = 'Инициализация...';
      
      // Сбрасываем все шаги
      steps.forEach(step => {
        step.classList.remove('active', 'completed');
      });
    }

    function updateProgress(percentage, statusText, currentStep = 1) {
      const fill = document.getElementById('progressFill');
      const percent = document.getElementById('progressPercent');
      const status = document.getElementById('progressStatus');
      const steps = document.querySelectorAll('.step');
      
      // Обновляем прогресс-бар
      fill.style.width = percentage + '%';
      percent.textContent = Math.round(percentage) + '%';
      status.textContent = statusText;
      
      // Обновляем шаги
      steps.forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNumber < currentStep) {
          step.classList.add('completed');
        } else if (stepNumber === currentStep) {
          step.classList.add('active');
        }
      });
    }

    function completeProgress() {
      updateProgress(100, 'Завершено', 3);
      setTimeout(() => {
        hideProgress();
      }, 2000); // Скрываем через 2 секунды
    }

    function h(tag, attrs = {}, ...children) {
      const el = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs || {})) {
        if (k === 'class') el.className = v; else if (k === 'text') el.textContent = v; else el.setAttribute(k, v);
      }
      for (const ch of children) { if (ch == null) continue; if (typeof ch === 'string') el.appendChild(document.createTextNode(ch)); else el.appendChild(ch); }
      return el;
    }

    function joinVals(val) {
      if (val == null) return '';
      if (Array.isArray(val)) return val.filter(Boolean).join('; ');
      return String(val);
    }

    function maskBotName(name) {
      if (!name || typeof name !== 'string') return '';
      const n = name.trim();
      if (n.length <= 2) return n;
      return `${n[0]}…${n[n.length - 1]}`;
    }

    function valueToText(v) {
      if (v == null) return '';
      if (typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean') return String(v);
      try { return JSON.stringify(v); } catch { return String(v); }
    }

    function isNoDataText(str) {
      if (!str || typeof str !== 'string') return false;
      return /(нет\s*информ|нет\s*данн|no\s*results|not\s*found)/i.test(str);
    }

    function itemHasData(item) {
      if (!item || !item.ok) return false;
      const it = item.items;
      if (typeof it === 'string') {
        return !isNoDataText(it);
      }
      if (Array.isArray(it)) {
        return it.length > 0;
      }
      if (it && typeof it === 'object') {
        // ITP shape: { dbName: { data: [...] }, ... }
        const vals = Object.values(it);
        if (vals.length === 0) return false;
        for (const v of vals) {
          if (v && Array.isArray(v.data) && v.data.length > 0) return true;
        }
        // If object with some keys but no explicit data arrays, assume has content
        return Object.keys(it).length > 0;
      }
      // Fallback to meta
      const mc = item.meta && ((item.meta.count ?? 0) || (item.meta.records ?? 0));
      return !!mc;
    }

    function keyChips(obj, opts = {}) {
      const max = opts.max ?? 12;
      const skip = new Set(['_id', 'id', '__v', '_score', 'data_provider', 'db_name', 'source', 'hits']);
      const chips = [];
      if (obj && typeof obj === 'object') {
        const entries = Object.entries(obj);
        for (const [k, v] of entries) {
          if (chips.length >= max) break;
          if (skip.has(k)) continue;
          const text = valueToText(v);
          if (!text || !String(text).trim()) continue;
          const short = text.length > 160 ? text.slice(0, 157) + '…' : text;
          chips.push(h('span', { class: 'chip' }, `${k}: ${short}`));
        }
      }
      return chips;
    }

    function renderRawBlock(data) {
      const pre = document.createElement('pre');
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.wordBreak = 'break-word';
      pre.textContent = JSON.stringify(data, null, 2);
      const det = h('details', {}, h('summary', {}, 'Сырой ответ (JSON)'));
      det.appendChild(pre);
      return det;
    }

    function renderITPContent(item) {
      const wrap = h('div', { class: 'rows' });
      const groups = item.items || {};
      const dbNames = Object.keys(groups);
      for (const db of dbNames) {
        const entries = (groups[db]?.data || []);
        for (const e of entries) {
          const kv = h('div', { class: 'kv' });
          const pushKV = (k, v) => { if (v) { kv.appendChild(h('div', { class: 'k', text: k })); kv.appendChild(h('div', { class: 'v', text: joinVals(v) })); } };
          pushKV('ФИО', e.name);
          pushKV('Телефон', e.phone);
          pushKV('Email', e.email);
          pushKV('Адрес', e.address);
          pushKV('Паспорт', e.passport);
          wrap.appendChild(
            h('div', { class: 'rowx' },
              h('div', { class: 'title', text: db }),
              kv
            )
          );
        }
      }
      return wrap;
    }

    function renderDyxlessContent(item) {
      const wrap = h('div', { class: 'rows' });
      const list = Array.isArray(item.items) ? item.items : [];
      const groups = {};
      for (const e of list) {
        const base = e.baseName || e.database || e.source || 'База данных';
        if (!groups[base]) groups[base] = [];
        groups[base].push(e);
      }
      const bases = Object.keys(groups);
      for (const base of bases) {
        for (const e of groups[base]) {
          const fullName = e.fullName || [e.first_name, e.last_name].filter(Boolean).join(' ') || e.name || e.username || e.login || '';
          const chips = [];
          if (fullName) chips.push(h('span', { class: 'chip' }, `ФИО: ${fullName}`));
          if (e.first_name && !fullName.includes(e.first_name)) chips.push(h('span', { class: 'chip' }, `Имя: ${e.first_name}`));
          if (e.last_name && !(fullName && fullName.includes(e.last_name))) chips.push(h('span', { class: 'chip' }, `Фамилия: ${e.last_name}`));
          const number = e.number || e.phone;
          if (number) chips.push(h('span', { class: 'chip' }, `Телефон: ${joinVals(number)}`));
          if (e.address) chips.push(h('span', { class: 'chip' }, `Адрес: ${joinVals(e.address)}`));
          if (e.email) chips.push(h('span', { class: 'chip' }, `Email: ${joinVals(e.email)}`));
          // Fallback: add a few more fields if chips are too few
          if (chips.length < 3) {
            const extra = keyChips(e, { max: 8 });
            for (const ch of extra) {
              if (chips.length >= 8) break;
              chips.push(ch);
            }
          }
          wrap.appendChild(
            h('div', { class: 'rowx' },
              h('div', { class: 'title', text: base }),
              h('div', { class: 'chips' }, ...chips)
            )
          );
        }
      }
      return wrap;
    }

    function renderLeakOsintContent(item) {
      const wrap = h('div', { class: 'rows' });
      const groups = Array.isArray(item.items) ? item.items : [];
      for (const g of groups) {
        const recs = Array.isArray(g.data) ? g.data : [];
        for (const e of recs) {
          const kv = h('div', { class: 'kv' });
          const pushKV = (k, v) => { if (v) { kv.appendChild(h('div', { class: 'k', text: k })); kv.appendChild(h('div', { class: 'v', text: joinVals(v) })); } };
          pushKV('ФИО', e.name);
          pushKV('Телефон', e.phone);
          pushKV('Email', e.email);
          pushKV('Адрес', e.address);
          pushKV('Логин', e.login);
          wrap.appendChild(
            h('div', { class: 'rowx' },
              h('div', { class: 'title', text: g.db || 'Источник' }),
              g.info ? h('div', { class: 'small' }, g.info) : null,
              kv
            )
          );
        }
      }
      return wrap;
    }

    function renderUsersboxContent(item) {
      const wrap = h('div', { class: 'rows' });
      const entries = Array.isArray(item.items) ? item.items : [];
      for (const e of entries) {
        const src = e.source ? `${e.source.database}/${e.source.collection}` : '(источник)';
        const docs = Array.isArray(e.hits?.items) ? e.hits.items : [];
        if (docs.length) {
          for (const d of docs) {
            const kv = h('div', { class: 'kv' });
            const pushKV = (k, v) => { if (v) { kv.appendChild(h('div', { class: 'k', text: k })); kv.appendChild(h('div', { class: 'v', text: joinVals(v) })); } };
            pushKV('ФИО', d.full_name || d.name);
            pushKV('Телефон', d.phone);
            pushKV('Email', d.email);
            pushKV('Адрес', d.address);
            pushKV('Логин', d.login);
            wrap.appendChild(
              h('div', { class: 'rowx' },
                h('div', { class: 'title', text: src }),
                kv
              )
            );
          }
        } else {
          const kv = h('div', { class: 'kv' });
          const pushKV = (k, v) => { if (v) { kv.appendChild(h('div', { class: 'k', text: k })); kv.appendChild(h('div', { class: 'v', text: joinVals(v) })); } };
          pushKV('ФИО', e.full_name || e.name);
          pushKV('Телефон', e.phone);
          pushKV('Email', e.email);
          pushKV('Адрес', e.address);
          pushKV('Логин', e.login);
          wrap.appendChild(
            h('div', { class: 'rowx' },
              h('div', { class: 'title', text: src }),
              kv
            )
          );
        }
      }
      return wrap;
    }

    function renderVektorContent(item) {
      const wrap = h('div', { class: 'rows' });
      const dict = item.items || {};
      const arr = Array.isArray(dict) ? dict : Object.values(dict);
      for (const e of arr) {
        const base = e['database'] || 'Источник';
        const kv = h('div', { class: 'kv' });
        const pushKV = (k, v) => { if (v) { kv.appendChild(h('div', { class: 'k', text: k })); kv.appendChild(h('div', { class: 'v', text: joinVals(v) })); } };
        const fio = e['ФИО'] || e['Фамилия'];
        pushKV('ФИО', fio);
        pushKV('Телефон', e['ТЕЛЕФОН']);
        pushKV('ДР', e['ДАТА РОЖДЕНИЯ']);
        wrap.appendChild(
          h('div', { class: 'rowx' },
            h('div', { class: 'title', text: base }),
            kv
          )
        );
      }
      return wrap;
    }

    // --- Company mode ---
    function extractAddress(addr) {
      if (!addr) return '';
      if (typeof addr === 'string') return addr;
      const parts = [];
      const pick = (k) => { if (addr[k]) parts.push(addr[k]); };
      pick('value'); pick('unrestricted_value'); pick('address'); pick('full');
      pick('region'); pick('city'); pick('settlement'); pick('street'); pick('house'); pick('building'); pick('block'); pick('office'); pick('room'); pick('flat'); pick('postal_code');
      const s = parts.join(', ');
      if (s) return s;
      try { return JSON.stringify(addr); } catch { return String(addr); }
    }

    function renderDatanewtonContent(item) {
      const wrap = h('div', { class: 'rows' });
      const data = item.items || {};
      // Company
      const company = data.company || {};
      const kvC = h('div', { class: 'kv' });
      const addKV = (k, v) => { if (v != null && String(v).trim() !== '') { kvC.appendChild(h('div', { class: 'k', text: k })); kvC.appendChild(h('div', { class: 'v', text: joinVals(v) })); } };
      addKV('ИНН', data.inn || company.inn);
      addKV('ОГРН', data.ogrn || company.ogrn);
      addKV('КПП', company.kpp);
      addKV('Наименование', company.company_names?.full || company.company_names?.short || company.name);
      addKV('ОПФ', company.opf);
      addKV('Дата регистрации', company.registration_date);
      addKV('Адрес', extractAddress(company.address));
      wrap.appendChild(h('div', { class: 'rowx' }, h('div', { class: 'title', text: 'Юридическое лицо' }), kvC));

      // Owners
      if (company.owners) {
        const owners = [];
        for (const [k, list] of Object.entries(company.owners)) {
          if (Array.isArray(list)) {
            for (const o of list) {
              const line = [o.name || o.title, o.share_text || o.share, o.inn].filter(Boolean).join(' — ');
              if (line) owners.push(line);
            }
          }
        }
        if (owners.length) {
          const box = h('div', { class: 'rowx' }, h('div', { class: 'title', text: 'Учредители' }));
          const ul = h('ul', { class: 'list' });
          owners.slice(0, 20).forEach(t => ul.appendChild(h('li', {}, t)));
          box.appendChild(ul);
          wrap.appendChild(box);
        }
      }

      // Managers
      if (Array.isArray(company.managers) && company.managers.length) {
        const box = h('div', { class: 'rowx' }, h('div', { class: 'title', text: 'Руководители' }));
        const ul = h('ul', { class: 'list' });
        company.managers.slice(0, 20).forEach(m => {
          const t = [m.fio || m.name, m.post || m.position].filter(Boolean).join(' — ');
          if (t) ul.appendChild(h('li', {}, t));
        });
        box.appendChild(ul);
        wrap.appendChild(box);
      }

      // OKVEDs
      const okveds = company.okveds || [];
      if (Array.isArray(okveds) && okveds.length) {
        const box = h('div', { class: 'rowx' }, h('div', { class: 'title', text: 'ОКВЭД' }));
        const ul = h('ul', { class: 'list' });
        okveds.slice(0, 30).forEach(v => {
          const t = [v.code, v.text || v.title].filter(Boolean).join(' — ');
          if (t) ul.appendChild(h('li', {}, t));
        });
        box.appendChild(ul);
        wrap.appendChild(box);
      }

      // Contacts
      if (company.contacts) {
        const kv = h('div', { class: 'kv' });
        addKV('Телефон', company.contacts.phone);
        addKV('Email', company.contacts.email);
        addKV('Сайт', company.contacts.site || company.contacts.web || company.contacts.url);
        wrap.appendChild(h('div', { class: 'rowx' }, h('div', { class: 'title', text: 'Контакты' }), kv));
      }

      // Individual (ИП)
      if (data.individual) {
        const i = data.individual;
        const kv = h('div', { class: 'kv' });
        const push = (k, v) => { if (v) { kv.appendChild(h('div', { class: 'k', text: k })); kv.appendChild(h('div', { class: 'v', text: joinVals(v) })); } };
        push('ФИО', i.fio);
        push('Дата регистрации', i.registration_date);
        push('ИНН', data.inn);
        wrap.appendChild(h('div', { class: 'rowx' }, h('div', { class: 'title', text: 'Индивидуальный предприниматель' }), kv));
      }

      return wrap;
    }

    function renderCheckoContent(item) {
      const wrap = h('div', { class: 'rows' });
      const data = item.items || {};
      const kv = h('div', { class: 'kv' });
      const add = (k, v) => { if (v) { kv.appendChild(h('div', { class: 'k', text: k })); kv.appendChild(h('div', { class: 'v', text: joinVals(v) })); } };
      add('ИНН', data.inn || data.INN);
      add('ОГРН', data.ogrn || data.OGRN);
      add('КПП', data.kpp || data.KPP);
      add('Наименование', data.name || data.full_name || data.company_name);
      add('Адрес', extractAddress(data.address));
      add('Руководитель', data.ceo || data.manager || data.head);
      wrap.appendChild(h('div', { class: 'rowx' }, h('div', { class: 'title', text: 'Компания' }), kv));

      if (Array.isArray(data.founders) && data.founders.length) {
        const box = h('div', { class: 'rowx' }, h('div', { class: 'title', text: 'Учредители' }));
        const ul = h('ul', { class: 'list' });
        data.founders.slice(0, 20).forEach(f => {
          const t = [f.name, f.share_text || f.share, f.inn].filter(Boolean).join(' — ');
          if (t) ul.appendChild(h('li', {}, t));
        });
        box.appendChild(ul);
        wrap.appendChild(box);
      }

      if (Array.isArray(data.okveds) && data.okveds.length) {
        const box = h('div', { class: 'rowx' }, h('div', { class: 'title', text: 'ОКВЭД' }));
        const ul = h('ul', { class: 'list' });
        data.okveds.slice(0, 30).forEach(v => {
          const t = [v.code, v.title || v.text].filter(Boolean).join(' — ');
          if (t) ul.appendChild(h('li', {}, t));
        });
        box.appendChild(ul);
        wrap.appendChild(box);
      }

      return wrap;
    }

    function renderResult(item) {
      const card = document.createElement('div');
      card.className = 'item';

      const head = h('div', { class: 'head' });
      const displayName = (item.name === 'Datanewton' || item.name === 'Checko') ? item.name : maskBotName(item.name);
      const titlewrap = h('div', { class: 'titlewrap' }, h('h3', { text: displayName }));
      const statusWrap = document.createElement('div');
      if (item.ok) {
        const has = itemHasData(item);
        const b = document.createElement('span');
        b.className = has ? 'badge found' : 'badge empty';
        b.textContent = has ? ('найдено' + (item.meta?.count || item.meta?.records ? ` — ${item.meta?.count ?? item.meta?.records}` : '')) : 'нет данных';
        statusWrap.appendChild(b);
        if (has) {
          const delBtn = document.createElement('button');
          delBtn.className = 'mini-btn danger';
          delBtn.textContent = 'удалить';
          delBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            // toggle panel
            let panel = body.querySelector('.remove-panel');
            if (!panel) {
              panel = document.createElement('div');
              panel.className = 'remove-panel';
              const title = document.createElement('div');
              title.style.fontWeight = '600';
              title.style.marginBottom = '6px';
              title.textContent = 'Удаление информации';
              const s1 = document.createElement('div'); s1.className = 'step'; s1.textContent = '1. стартуйте бота';
              const s2 = document.createElement('div'); s2.className = 'step'; s2.textContent = '2. выберите мой профиль';
              const s3 = document.createElement('div'); s3.className = 'step'; s3.textContent = '3. нажмите "скрыть информацию"';
              panel.appendChild(title); panel.appendChild(s1); panel.appendChild(s2); panel.appendChild(s3);
              body.prepend(panel);
              card.classList.add('open');
            } else {
              if (panel.style.display === 'none') { panel.style.display = ''; card.classList.add('open'); } else { panel.style.display = 'none'; }
            }
          });
          statusWrap.appendChild(delBtn);
        }
      } else {
        const b = document.createElement('span');
        b.className = 'badge err';
        b.textContent = 'ошибка';
        statusWrap.appendChild(b);
      }
      const caret = h('span', { class: 'caret', text: '▸' });
      head.appendChild(titlewrap);
      head.appendChild(statusWrap);
      head.appendChild(caret);
      card.appendChild(head);

      const body = h('div', { class: 'body' });
      if (item.ok) {
        let content = null;
        if (item.name === 'ITP') content = renderITPContent(item);
        else if (item.name === 'Dyxless') content = renderDyxlessContent(item);
        else if (item.name === 'LeakOsint') content = renderLeakOsintContent(item);
        else if (item.name === 'Usersbox') content = renderUsersboxContent(item);
        else if (item.name === 'Vektor') content = renderVektorContent(item);
        else if (item.name === 'Datanewton') content = renderDatanewtonContent(item);
        else if (item.name === 'Checko') content = renderCheckoContent(item);
        if (content) body.appendChild(content);
      }
      let raw = item.ok ? (item.items ?? item.meta ?? {}) : (item.error ?? {});
      if (Array.isArray(raw) && raw.length === 0) raw = { message: 'Нет данных' };
      if (raw && typeof raw === 'object' && !Array.isArray(raw) && Object.keys(raw).length === 0) raw = { message: 'Нет данных' };
      body.appendChild(renderRawBlock(raw));
      card.appendChild(body);

      head.addEventListener('click', () => {
        card.classList.toggle('open');
      });

      results.appendChild(card);
    }


    const API_BASE = (location.origin && location.origin.startsWith('http')) ? '' : 'http://localhost:3020';

    let companyMode = false;
    
    // Функция для проверки наличия результатов
    function hasResults() {
      const companyResults = document.getElementById('companyReact').innerHTML.trim();
      const leakResults = document.getElementById('results').innerHTML.trim();
      return companyResults !== '' || leakResults !== '';
    }

    // Функция для очистки всех результатов
    function clearAllResults() {
      document.getElementById('companyReact').innerHTML = '';
      document.getElementById('results').innerHTML = '';
      document.getElementById('summary').style.display = 'none';
      document.getElementById('q').value = ''; // Очищаем поле ввода
      hideProgress();
    }

    // Функция для показа модального окна подтверждения
    function showConfirmModal(message, onConfirm, onCancel) {
      // Создаем модальное окно
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
          <div class="flex items-center mb-4">
            <svg class="w-6 h-6 text-amber-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-900">Подтверждение</h3>
          </div>
          <p class="text-gray-600 mb-6">${message}</p>
          <div class="flex justify-end space-x-3">
            <button id="cancelBtn" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              Отмена
            </button>
            <button id="confirmBtn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
              Очистить
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Обработчики кнопок
      modal.querySelector('#confirmBtn').addEventListener('click', () => {
        document.body.removeChild(modal);
        onConfirm();
      });

      modal.querySelector('#cancelBtn').addEventListener('click', () => {
        document.body.removeChild(modal);
        if (onCancel) onCancel();
      });

      // Закрытие по клику на фон
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
          if (onCancel) onCancel();
        }
      });
    }

    // Обработчики событий для переключения режимов
    modeLeaks.addEventListener('click', () => {
      // Если уже в режиме утечек, ничего не делаем
      if (!companyMode) return;

      // Проверяем наличие результатов
      if (hasResults()) {
        showConfirmModal(
          'При переключении на "Поиск утечек" текущие результаты будут очищены. Продолжить?',
          () => {
            // Подтверждено - переключаем режим и очищаем
            companyMode = false;
            modeLeaks.style.borderColor = '#415bff'; 
            modeLeaks.style.color = '#aebcff';
            modeCompany.style.borderColor = '#2a3046'; 
            modeCompany.style.color = '#e6e8ef';
            fieldSel.disabled = false;
            updatePlaceholder();
            clearAllResults();
          },
          () => {
            // Отменено - ничего не делаем
          }
        );
      } else {
        // Нет результатов - переключаем без подтверждения
        companyMode = false;
        modeLeaks.style.borderColor = '#415bff'; 
        modeLeaks.style.color = '#aebcff';
        modeCompany.style.borderColor = '#2a3046'; 
        modeCompany.style.color = '#e6e8ef';
        fieldSel.disabled = false;
        updatePlaceholder();
      }
    });
    
    modeCompany.addEventListener('click', () => {
      // Если уже в режиме компаний, ничего не делаем
      if (companyMode) return;

      // Проверяем наличие результатов
      if (hasResults()) {
        showConfirmModal(
          'При переключении на "Проверить компанию" текущие результаты будут очищены. Продолжить?',
          () => {
            // Подтверждено - переключаем режим и очищаем
            companyMode = true;
            modeCompany.style.borderColor = '#415bff'; 
            modeCompany.style.color = '#aebcff';
            modeLeaks.style.borderColor = '#2a3046'; 
            modeLeaks.style.color = '#e6e8ef';
            fieldSel.value = 'inn'; 
            fieldSel.disabled = true; 
            updatePlaceholder();
            clearAllResults();
          },
          () => {
            // Отменено - ничего не делаем
          }
        );
      } else {
        // Нет результатов - переключаем без подтверждения
        companyMode = true;
        modeCompany.style.borderColor = '#415bff'; 
        modeCompany.style.color = '#aebcff';
        modeLeaks.style.borderColor = '#2a3046'; 
        modeLeaks.style.color = '#e6e8ef';
        fieldSel.value = 'inn'; 
        fieldSel.disabled = true; 
        updatePlaceholder();
      }
    });
    modeLeaks.addEventListener('click', () => {
      companyMode = false;
      modeLeaks.style.borderColor = '#415bff'; modeLeaks.style.color = '#aebcff';
      modeCompany.style.borderColor = '#2a3046'; modeCompany.style.color = '#e6e8ef';
      fieldSel.disabled = false;
      updatePlaceholder();
    });
    modeCompany.addEventListener('click', () => {
      companyMode = true;
      modeCompany.style.borderColor = '#415bff'; modeCompany.style.color = '#aebcff';
      modeLeaks.style.borderColor = '#2a3046'; modeLeaks.style.color = '#e6e8ef';
      fieldSel.value = 'inn'; fieldSel.disabled = true; updatePlaceholder();
    });

    btn.addEventListener('click', async () => {
      const query = (q.value || '').trim();
      if (!companyMode) {
        if (query.length < 3) { alert('Введите корректный запрос (мин. 3 символа)'); return; }
      } else {
        if (!/^\d{10,12}$/.test(query)) { alert('Введите корректный ИНН (10 или 12 цифр)'); return; }
      }
      
      // Очищаем результаты и показываем новый индикатор прогресса
      results.innerHTML = '';
      document.getElementById('companyReact').innerHTML = '';
      showProgress();
      updateProgress(0, 'Инициализация...', 1);
      btn.disabled = true;
      try {
        // Шаг 1: Отправка запроса к API
        updateProgress(10, 'Отправка запроса к источникам...', 1);
        
        const url = companyMode ? `${API_BASE}/api/company-search` : `${API_BASE}/api/search`;
        const payload = companyMode ? { inn: query } : { query, field: fieldSel.value };
        const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await r.json();
        const items = data.results || [];
        
        // Шаг 1 завершен: Данные получены
        updateProgress(40, 'Данные получены, начинаем обработку...', 1);
        
        // AI summary for company mode - обрабатываем каждый источник отдельно
        if (companyMode) {
          try {
            // Шаг 2: Обработка через ИИ
            updateProgress(50, 'Обработка данных через ИИ...', 2);
            console.log('Starting OpenAI processing for each source...');
            
            const mount = document.getElementById('companyReact');
            mount.innerHTML = ''; // Очищаем контейнер
            
            // Обрабатываем каждый источник отдельно
            const validItems = items.filter(item => item.ok && item.items);
            for (let i = 0; i < validItems.length; i++) {
              const item = validItems[i];
              
              // Обновляем прогресс для каждого источника
              const sourceProgress = 50 + (i / validItems.length) * 40; // от 50% до 90%
              updateProgress(sourceProgress, `Обработка ${item.name} через ИИ...`, 2);
              console.log(`Processing ${item.name} with OpenAI...`);
              
              try {
                const openaiResponse = await fetch(`${API_BASE}/api/openai/format-company`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    prompt: `Ты — ассистент для визуализации данных компаний. На вход ты получаешь JSON-ответ с информацией о компании от источника "${item.name}".

Задача: превратить этот JSON в структурированное и красиво оформленное описание компании.

Формат ответа — HTML с минимальными инлайн-стилями, но с классами Tailwind CSS.

Требования:
1. Первая секция — название компании (полное + сокращенное) крупным шрифтом, ниже ИНН, ОГРН, дата регистрации, возраст компании.
2. Вторая секция — адрес с иконкой 📍, форматировать одной строкой.
3. Третья секция — статус компании, выделить цветом (зелёный для "Действует", красный для "Ликвидирована").
4. Четвёртая секция — Основной ОКВЭД (показать код и расшифровку), дополнительные — в сворачиваемом списке.
5. Пятая секция — руководители (ФИО, должность).
6. Шестая секция — контакты (email — кликабельный mailto:, телефон — tel:, сайт — ссылка).
7. Седьмая секция — капитал и владельцы.
8. Если данных нет — пропускать секцию.
9. Использовать только безопасный HTML (никаких script).
10. Добавь заголовок с названием источника "${item.name}" в верхней части карточки.

Ответь только HTML-кодом.

Вот JSON от ${item.name}: ${JSON.stringify(item)}`,
                    model: 'gpt-5'
                  })
                });

                if (openaiResponse.ok) {
                  const openaiData = await openaiResponse.json();
                  console.log(`${item.name} processed successfully`);
                  
                  // Создаем сворачиваемый контейнер для каждого источника компании
                  const sourceContainer = document.createElement('div');
                  sourceContainer.className = 'mb-6 bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden';
                  
                  const header = document.createElement('div');
                  header.className = 'flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors';
                  header.innerHTML = `
                    <div class="flex items-center space-x-3">
                      <h3 class="text-lg font-semibold text-gray-900">${item.name}</h3>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">найдено</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-500 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  `;
                  
                  const content = document.createElement('div');
                  content.className = 'p-4';
                  content.style.display = 'none'; // Изначально свернуто
                  content.innerHTML = openaiData.html || `<div class="text-gray-500">Не удалось обработать данные от ${item.name}</div>`;
                  
                  // Добавляем обработчик клика для сворачивания/разворачивания
                  header.addEventListener('click', () => {
                    const isHidden = content.style.display === 'none';
                    content.style.display = isHidden ? 'block' : 'none';
                    const arrow = header.querySelector('svg');
                    arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
                  });
                  
                  sourceContainer.appendChild(header);
                  sourceContainer.appendChild(content);
                  mount.appendChild(sourceContainer);
                } else {
                  console.error(`${item.name} processing failed:`, openaiResponse.status);
                  const errorContainer = document.createElement('div');
                  errorContainer.className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg';
                  errorContainer.innerHTML = `<div class="text-red-600">Ошибка обработки данных от ${item.name}</div>`;
                  mount.appendChild(errorContainer);
                }
              } catch (e) {
                console.error(`Error processing ${item.name}:`, e);
                const errorContainer = document.createElement('div');
                errorContainer.className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg';
                errorContainer.innerHTML = `<div class="text-red-600">Ошибка обработки ${item.name}: ${e.message}</div>`;
                mount.appendChild(errorContainer);
              }
              
              // Обновляем прогресс
              setProgress(3 + (i + 1) / items.length * 2, 5);
            }
            
            // Завершаем прогресс
            // Завершаем прогресс
            setProgress(5, 5);
            statusEl.textContent = 'Готово';
            completeProgress();
          } catch (e) {
            console.error('Company formatting error:', e);
            const mount = document.getElementById('companyReact');
            mount.innerHTML = '<div class="p-4 text-red-400">Ошибка обработки данных ИИ: ' + (e.message || 'Неизвестная ошибка') + '</div>';
          }
        } else {
          // Обработка утечек через GPT-5 - каждый источник отдельно
          try {
            console.log('Starting OpenAI processing for leaks sources...');
            statusEl.textContent = 'Информация обрабатывается...';
            setProgress(3, 5);
            
            // Очищаем контейнер результатов
            results.innerHTML = '';
            
            // Фильтруем только источники с данными
            const validItems = items.filter(item => item.ok && itemHasData(item));
            console.log(`Processing ${validItems.length} leak sources with GPT-5...`);
            
            // Обрабатываем каждый источник утечек через GPT-5
            for (let i = 0; i < validItems.length; i++) {
              const item = validItems[i];
              console.log(`Processing ${item.name} leaks with OpenAI...`);
              
              try {
                const openaiResponse = await fetch(`${API_BASE}/api/openai/format-company`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    prompt: `Преобразуй данные утечек в красивый HTML с Tailwind CSS.

Источник: ${item.name}
Данные: ${JSON.stringify(item)}

Создай HTML карточку с:
1. Заголовок "${item.name}" с красным бейджем "найдено" или зеленым "нет данных"
2. Если есть данные - покажи их списком:
   - ФИО
   - Телефон (сделай ссылкой tel:)
   - Email (сделай ссылкой mailto:)
   - Адрес
   - База данных
   - Другие поля
3. Используй классы: bg-white, shadow-lg, rounded-lg, p-4, text-red-600 для утечек, text-green-600 для "нет данных"
4. Группируй по базам данных если их несколько

Ответь только HTML без объяснений.`,
                    model: 'gpt-5'
                  })
                });

                if (openaiResponse.ok) {
                  const openaiData = await openaiResponse.json();
                  console.log(`${item.name} leaks processed successfully`);
                  
                  // Создаем сворачиваемый контейнер для каждого источника утечек
                  const sourceContainer = document.createElement('div');
                  sourceContainer.className = 'mb-6 bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden';
                  
                  const header = document.createElement('div');
                  header.className = 'flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors';
                  header.innerHTML = `
                    <div class="flex items-center space-x-3">
                      <h3 class="text-lg font-semibold text-gray-900">${item.name}</h3>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">найдено</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-500 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  `;
                  
                  const content = document.createElement('div');
                  content.className = 'p-4';
                  content.style.display = 'none'; // Изначально свернуто
                  content.innerHTML = openaiData.html || `<div class="text-gray-500">Не удалось обработать данные от ${item.name}</div>`;
                  
                  // Добавляем обработчик клика для сворачивания/разворачивания
                  header.addEventListener('click', () => {
                    const isHidden = content.style.display === 'none';
                    content.style.display = isHidden ? 'block' : 'none';
                    const arrow = header.querySelector('svg');
                    arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
                  });
                  
                  sourceContainer.appendChild(header);
                  sourceContainer.appendChild(content);
                  results.appendChild(sourceContainer);
                } else {
                  console.error(`${item.name} leaks processing failed:`, openaiResponse.status);
                  const errorContainer = document.createElement('div');
                  errorContainer.className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg';
                  errorContainer.innerHTML = `<div class="text-red-600">Ошибка обработки данных от ${item.name}</div>`;
                  results.appendChild(errorContainer);
                }
              } catch (e) {
                console.error(`Error processing ${item.name} leaks:`, e);
                const errorContainer = document.createElement('div');
                errorContainer.className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg';
                errorContainer.innerHTML = `<div class="text-red-600">Ошибка обработки ${item.name}: ${e.message}</div>`;
                results.appendChild(errorContainer);
              }
              
              // Обновляем прогресс
              setProgress(3 + (i + 1) / validItems.length * 2, 5);
            }
            
            // Завершаем прогресс для утечек
            setProgress(5, 5);
            statusEl.textContent = 'Готово';
            completeProgress();
          } catch (e) {
            console.error('Leaks formatting error:', e);
            results.innerHTML = '<div class="p-4 text-red-400">Ошибка обработки данных утечек: ' + (e.message || 'Неизвестная ошибка') + '</div>';
            completeProgress();
          }
        }
        statusEl.textContent = 'Готово';
      } catch (e) {
        statusEl.textContent = 'Ошибка запроса';
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>

</html>